<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Care Schedule - Horizontal Layout</title>
    <style>
        /* Core styling for light and dark modes */
        :root {
            --background-color: #f9f9f9; /* Light background */
            --text-color: #333333; /* Dark text color */
            --container-bg-color: #ffffff; /* White container background */
            --button-bg-color: #0077ff; /* Bright blue button color */
            --button-hover-bg-color: #0056cc; /* Darker blue for hover */
            --table-header-bg-color: #f3f4f6; /* Light gray for table headers */
            --table-header-text-color: #333333; /* Dark text for table headers */
            --table-cell-bg-color: #ffffff; /* White table cell background */
            --table-cell-text-color: #333333; /* Dark text color for table cells */
            --break-bg-color: #ffefc1; /* Soft yellow for breaks */
            --lunch-bg-color: #c1f0c1; /* Soft green for lunch */
            --unassigned-bg-color: #ffc1c1; /* Soft red for unassigned */
            --primary-font: 'Poppins', sans-serif; /* Modern font */
        }

        /* Dark mode overrides */
        body.dark-mode {
            --background-color: #1f2937; /* Dark background */
            --text-color: #f9fafb; /* Light text color */
            --container-bg-color: #374151; /* Dark gray container background */
            --button-bg-color: #2563eb; /* Blue button color */
            --button-hover-bg-color: #1d4ed8; /* Darker blue for hover */
            --table-header-bg-color: #4b5563; /* Darker gray for table headers */
            --table-header-text-color: #f9fafb; /* Light text for table headers */
            --table-cell-bg-color: #4b5563; /* Dark gray table cell background */
            --table-cell-text-color: #f9fafb; /* Light text color for table cells */
            --break-bg-color: #fbbf24; /* Yellow for breaks */
            --lunch-bg-color: #22c55e; /* Green for lunch */
            --unassigned-bg-color: #ef4444; /* Red for unassigned */
        }

        /* General body styling */
        body {
            font-family: var(--primary-font);
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.8;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        h1, h2 {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 20px;
        }
        h1 {
            font-size: 2.5rem;
            text-align: center;
            margin-top: 20px;
        }
        h2 {
            font-size: 1.8rem;
        }
        .container {
            width: 100%; /* Ensure it takes full width */
            max-width: 1200px; /* Limit the maximum width */
            min-width: 800px; /* Ensure a minimum width for smaller content */
            margin: 0 auto;
            padding: 30px;
            background-color: var(--container-bg-color);
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            overflow-x: auto; /* Allow horizontal scrolling for overflowing content */
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
        }
        .setup-section {
            background-color: var(--container-bg-color); /* Use dark mode container background */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e4e8;
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease; /* Smooth transition */
        }
        .setup-section h2 {
            margin-bottom: 10px;
        }
        .staff-inputs, .patient-inputs, .security-staff-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
           
        }
        input, select {
            padding: 8px;
            border: 1px solid #dfe4ea;
            border-radius: 5px;
            width: 150px; /* Shortened width */
            font-size: 14px;
            background-color: #ffffff;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        input:focus, select:focus, button:focus {
            outline: 3px solid #4a69bd;
            box-shadow: 0 0 5px rgba(74, 105, 189, 0.5);
        }
        button {
            background-color: var(--button-bg-color);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: var(--button-hover-bg-color);
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--table-cell-bg-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 15px;
            text-align: center;
            font-size: 14px;
            background-color: var(--table-cell-bg-color);
            color: var(--table-cell-text-color);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        th {
            background-color: var(--table-header-bg-color);
            color: var(--table-header-text-color);
            font-weight: 600;
        }
        tr:nth-child(even) td {
            background-color: #f9fafb;
            color: var(--table-cell-text-color); /* Explicitly set text color */
        }
        tr:nth-child(odd) td {
            background-color: var(--table-cell-bg-color);
            color: var(--table-cell-text-color); /* Explicitly set text color */
        }
        .row-header {
            background-color: var(--table-header-bg-color);
            color: var(--table-header-text-color);
            font-weight: bold;
            text-align: left;
        }
        .staff-break {
            background-color: var(--break-bg-color);
            color: #000000; /* Ensure black text for contrast with yellow background */
            font-weight: bold;
        }
        .staff-lunch {
            background-color: var(--lunch-bg-color);
            color: #000000; /* Ensure black text for contrast with green background */
            font-weight: bold;
        }
        .schedule-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        .stats {
            margin-top: 20px;
            background-color: var(--container-bg-color); /* Use dark mode container background */
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e4e8;
            color: var(--text-color); /* Ensure text color adapts to dark mode */
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease; /* Smooth transition */
        }
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            justify-content: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 50%;
        }
        .legend-break {
            background-color: var(--break-bg-color);
        }
        .legend-lunch {
            background-color: var(--lunch-bg-color);
        }
        .legend-unassigned {
            background-color: var(--unassigned-bg-color);
        }
        .legend-security {
            background-color: #ffccbc;
        }
        .legend-night-break {
            background-color: #673ab7;
        }
        .staff-cleaning-duty {
            background-color: #9c27b0; /* Purple color for cleaning duties */
            color: #ffffff; /* White text for contrast */
            font-weight: bold;
        }

        .legend-cleaning-duty {
            background-color: #9c27b0;
        }

        /* Ensure text color is visible for cells with white background in dark mode */
        body.dark-mode td {
            color: var(--text-color); /* Use the light text color defined for dark mode */
        }

        body.dark-mode tr:nth-child(even) td {
            background-color: #374151; /* Dark gray for even rows in dark mode */
            color: var(--table-cell-text-color); /* Ensure text color is visible */
        }

        body.dark-mode tr:nth-child(odd) td {
            background-color: var(--table-cell-bg-color); /* Dark gray for odd rows in dark mode */
            color: var(--table-cell-text-color); /* Ensure text color is visible */
        }

        /* Explicitly set text color for cells with white background */
        body.dark-mode td[style*="background-color: #ffffff"] {
            color: #333333; /* Dark text color for white background */
        }

        .staff-count {
            padding: 5px; /* Reduce padding */
            border: 1px solid #dfe4ea;
            border-radius: 5px;
            width: 80px; /* Adjust width to save space */
            font-size: 12px; /* Reduce font size */
            background-color: #ffffff;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .staff-count:focus {
            outline: none;
            border-color: #4a69bd;
            box-shadow: 0 0 5px rgba(74, 105, 189, 0.5);
        }

        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #f44336;
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 1000;
        }

        /* Explicitly set text color for cells when in dark mode */
        body.dark-mode .staff-break {
            background-color: var(--break-bg-color); /* Your dark mode yellow */
            color: #000000; /* Keep black text which contrasts with yellow */
        }

        body.dark-mode .staff-lunch {
            background-color: var(--lunch-bg-color); /* Your dark mode green */
            color: #000000; /* Keep black text which contrasts with green */
        }

        /* Other cells with custom colors in dark mode may need adjustments */
        body.dark-mode td.row-header {
            color: var(--table-header-text-color);
        }

        .rotation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .rotation-table th, .rotation-table td {
            border: 1px solid #e5e7eb;
            padding: 15px;
            text-align: center;
            font-size: 14px;
        }

        .rotation-table th {
            background-color: var(--table-header-bg-color);
            color: var(--table-header-text-color);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Title dynamically updates based on the current shift -->
        <h1 id="siteTitle">Day Shift Allocation</h1>

        <!-- Buttons for toggling shift and dark mode -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button id="toggleShiftBtn" style="padding: 10px 20px; font-size: 14px;">Switch to Night Shift</button>
            <button id="toggleModeBtn" title="Toggle Dark/Light Mode"></button>
        </div>

        <!-- Replace the Security Staff and Nurse in Charge sections with this flex container -->
        <div class="setup-section" style="margin-bottom: 20px;">
            <div style="display: flex; gap: 40px; align-items: flex-start;">
                <!-- Security Staff Section -->
                <div>
                    <h2>Security Staff</h2>
                    <div class="security-staff-inputs" id="securityStaffInputs"></div>
                    <button id="addSecurityStaffBtn">Add Security Staff</button>
                    <button id="removeSecurityStaffBtn">Remove Security Staff</button>
                </div>
                
                <!-- Combined Nurses Section -->
                <div>
                    <h2>Nursing Staff</h2>
                    <div style="margin-bottom: 15px;">
                        <label for="nurseInChargeInput"><strong>Nurse in Charge 1:</strong></label>
                        <input type="text" id="nurseInChargeInput" placeholder="Enter First Nurse in Charge" style="width: 250px; margin-bottom: 15px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="nurseInCharge2Input"><strong>Nurse in Charge 2:</strong></label>
                        <input type="text" id="nurseInCharge2Input" placeholder="Enter Second Nurse in Charge" style="width: 250px; margin-bottom: 15px;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Add this new section for Health Care Workers only -->
<div class="setup-section" style="margin-bottom: 20px;">
    <h2>Health Care Workers</h2>
    <div class="staff-inputs" id="staffInputs"></div>
    <button id="addStaffBtn">Add Health Care Worker</button>
    <button id="removeStaffBtn">Remove Health Care Worker</button>
</div>

        <!-- Section for managing health care workers and patients -->
        <div class="setup-section">
            <h2>Patient Names</h2>
            <div class="patient-inputs" id="patientInputs"></div>
            <button id="addPatientBtn">Add Patient</button>
            <button id="removePatientBtn">Remove Patient</button>

            <!-- Add this cleaning duties assignment section before the Generate/Reset buttons -->
            <div id="cleaningDutiesSection" class="setup-section" style="display: none; margin-top: 20px;">
                <h2>Night Shift Cleaning Duties Assignment</h2>
                <p>Assign cleaning duties to staff members. You can assign multiple duties to one staff member.</p>
                
                <table id="cleaningDutiesTable" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Duty</th>
                            <th>Staff Assignment</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Will be populated dynamically -->
                    </tbody>
                </table>
                
                <div style="margin-top: 15px;">
                    <button id="saveCleaningDuties" style="background-color: #4CAF50;">Save Assignments</button>
                    <button id="resetCleaningDuties" style="background-color: #f44336;">Reset Assignments</button>
                </div>
            </div>

            <!-- Buttons for generating and resetting the schedule -->
            <button id="generateBtn">Generate Schedule</button>
            <button id="resetBtn">Reset</button>
            <!-- Debugging Button -->
            <!-- This button is for debugging purposes only. Remove this button and its functionality before final deployment. -->
            <button id="debugFillBtn" style="background-color: #ff5722; color: white; margin-top: 10px;">Debug: Fill Random Names</button>
        </div>

        <!-- Legend for schedule colors -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color legend-break"></div>
                <div>30-min Break</div>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-lunch"></div>
                <div>1-hour 2nd Break</div>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-unassigned"></div>
                <div>Unassigned</div>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-security"></div>
                <div>Security Duty</div>
            </div>
        </div>

        <!-- Schedule tables -->
        <div class="schedule-container">
            <h2>Patient Care Schedule</h2>
            <table id="scheduleTable">
                <thead id="scheduleHeader"></thead>
                <tbody id="scheduleBody"></tbody>
            </table>
        </div>

        <div class="schedule-container">
            <h2>Staff Schedule</h2>
            <table id="staffTable">
                <thead id="staffHeader"></thead>
                <tbody id="staffBody"></tbody>
            </table>
        </div>

        <div class="schedule-container">
            <h2>Staff Break Hours</h2>
            <table id="breakHoursTable">
                <thead>
                    <tr>
                        <th>Staff</th>
                        <th>30-min Break</th>
                        <th>1-hour 2nd Break</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Statistics section -->
        <div class="stats" id="stats"></div>

        <!-- Staff-Patient Rotation section -->
        <div class="stats" id="rotationStats"></div>

        <button id="resetRotationBtn" class="action-button">Reset Rotation History</button>
    </div>

    <div id="debugPanel" style="display: none; position: fixed; bottom: 0; right: 0; width: 400px; height: 300px; background-color: rgba(0,0,0,0.8); color: white; padding: 10px; overflow: auto; z-index: 1000; font-family: monospace; font-size: 12px;">
    <h3 style="margin-top: 0; border-bottom: 1px solid white;">Debug Console</h3>
    <button id="clearDebugBtn" style="position: absolute; top: 10px; right: 10px; background-color: #f44336; color: white; border: none; border-radius: 4px; padding: 5px;">Clear</button>
    <div id="debugOutput"></div>
</div>

<button id="toggleDebugBtn" style="position: fixed; bottom: 10px; right: 10px; background-color: #333; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; z-index: 999;">🐞</button>

    <script>
        // Add this function near the top of your script section with other utility functions
        function getInitials(fullName) {
            if (!fullName) return '';
            
            // Split the name by spaces
            const nameParts = fullName.trim().split(' ');
            
            // If it's a single name, return first 2 letters
            if (nameParts.length === 1) {
                return nameParts[0].substring(0, 2).toUpperCase();
            }
            
            // Otherwise return first letter of first name + first letter of last name
            const firstInitial = nameParts[0][0] || '';
            const lastInitial = nameParts[nameParts.length - 1][0] || '';
            
            return (firstInitial + lastInitial).toUpperCase();
        }

        // Add this function to your JavaScript
        function updateLegend() {
            // Update legend based on shift
            const legendDiv = document.querySelector('.legend');
            if (isDayShift) {
                legendDiv.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color legend-break"></div>
                        <div>30-min Break</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-lunch"></div>
                        <div>1-hour 2nd Break</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-unassigned"></div>
                        <div>Unassigned</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-security"></div>
                        <div>Security Duty</div>
                    </div>
                `;
            } else {
                legendDiv.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color legend-night-break"></div>
                        <div>2-hour Break</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-cleaning-duty"></div>
                        <div>Cleaning Duty</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-unassigned"></div>
                        <div>Unassigned</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-security"></div>
                        <div>Security Duty</div>
                    </div>
                `;
            }
            
            // Update break hours table header
            const breakHoursTableHead = document.querySelector('#breakHoursTable thead');
            if (isDayShift) {
                breakHoursTableHead.innerHTML = `
                <tr>
                    <th>Staff</th>
                    <th>30-min Break</th>
                    <th>1-hour 2nd Break</th>
                </tr>`;
            } else {
                breakHoursTableHead.innerHTML = `
                <tr>
                    <th>Staff</th>
                    <th>Break Start</th>
                    <th>Break End</th>
                </tr>`;
            }
        }

        // Global variables
        let schedule = {};
        let isDayShift = true;
        let securityStaff = []; // Add this new global variable
        let staffPatientHistory = {};
        const cleaningDuties = [
            "DINING ROOM", "OFFICE ROOM", "TAKE OUT BINS", "LAUNDRY ROOM", "PHONE ROOM",
            "LOUNGE", "KITCHEN", "QUIET ROOM", "CORRIDOR", "TOILETS"
        ];

        // Time slots for day and night shifts
        const dayShiftSlots = [
            "08:00-09:00", "09:00-10:00", "10:00-11:00", "11:00-12:00",
            "12:00-13:00", "13:00-14:00", "14:00-15:00", "15:00-16:00",
            "16:00-17:00", "17:00-18:00", "18:00-19:00", "19:00-20:00"
        ];

        const nightShiftSlots = [
            "20:00-21:00", "21:00-22:00", "22:00-23:00", "23:00-00:00",
            "00:00-01:00", "01:00-02:00", "02:00-03:00", "03:00-04:00",
            "04:00-05:00", "05:00-06:00", "06:00-07:00", "07:00-08:00"
        ];
        
        // Current time slots (default to day shift)
        let timeSlots = [...dayShiftSlots];
        
        // Helper functions
        function getInputValues(selector) {
            return Array.from(document.querySelectorAll(selector)).map(input => input.value.trim());
        }
        
        function getElement(id) {
            return document.getElementById(id);
        }
        
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            }
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Simplified saveToLocalStorage function that only stores essential data
        function saveToLocalStorage() {
            try {
                // Get all current input values
                const staffInputs = Array.from(document.querySelectorAll('.staff-name')).map(input => input.value.trim());
                const patientInputs = Array.from(document.querySelectorAll('.patient-container')).map(container => {
                    return {
                        name: container.querySelector('.patient-name').value.trim(),
                        staffCount: parseInt(container.querySelector('.staff-count').value)
                    };
                });
                
                const securityStaffValues = Array.from(document.querySelectorAll('.security-name')).map(input => input.value.trim());
                const nurseInCharge1 = document.getElementById('nurseInChargeInput')?.value.trim() || '';
                const nurseInCharge2 = document.getElementById('nurseInCharge2Input')?.value.trim() || '';
                
                // Save only essential data: names, preferences, and input fields
                const data = {
                    staff: staffInputs,
                    nurseInCharge1,
                    nurseInCharge2,
                    patients: patientInputs,
                    securityStaff: securityStaffValues,
                    isDayShift, // Day/night shift toggle
                    isDarkMode: document.body.classList.contains('dark-mode') // Dark/light mode toggle
                };
                
                localStorage.setItem('patientCareData', JSON.stringify(data));
                return true;
            } catch (error) {
                console.error("Error saving to localStorage:", error);
                showError("Failed to save your changes. Your browser storage might be full or restricted.");
                return false;
            }
        }

        // Simplified loadFromLocalStorage function to match
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('patientCareData');
                if (!savedData) {
                    console.warn("No data found in localStorage.");
                    // Add default data
                    addStaffInput();
                    addPatientInput();
                    return false;
                }
                
                const parsedData = JSON.parse(savedData);
                
                // Load shift type
                isDayShift = parsedData.isDayShift !== undefined ? parsedData.isDayShift : true;
                timeSlots = isDayShift ? [...dayShiftSlots] : [...nightShiftSlots];
                
                // Update UI for shift type
                document.getElementById('siteTitle').textContent = isDayShift ? "Day Shift Allocation" : "Night Shift Allocation";
                document.getElementById('toggleShiftBtn').textContent = isDayShift ? "Switch to Night Shift" : "Switch to Day Shift";
                
                // Load dark mode setting
                if (parsedData.isDarkMode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('toggleModeBtn').textContent = '☀️';
                } else {
                    document.body.classList.remove('dark-mode');
                    document.getElementById('toggleModeBtn').textContent = '🌙';
                }
                
                // Load nurse in charge values
                if (document.getElementById('nurseInChargeInput')) {
                    document.getElementById('nurseInChargeInput').value = parsedData.nurseInCharge1 || '';
                }
                if (document.getElementById('nurseInCharge2Input')) {
                    document.getElementById('nurseInCharge2Input').value = parsedData.nurseInCharge2 || '';
                }
                
                // Load staff, patients, and security staff
                loadStaffFromData(parsedData.staff || []);
                loadPatientsFromData(parsedData.patients || []);
                loadSecurityStaffFromData(parsedData.securityStaff || []);
                
                // Initialize empty schedule when loading (instead of loading saved schedule)
                schedule = {}; 
                
                // Set up legend based on shift type
                updateLegend();
                
                console.log("Data loaded successfully from localStorage");
                return true;
            } catch (error) {
                console.error("Error loading from localStorage:", error);
                showError("Failed to load your saved data. Using default settings instead.");
                return false;
            }
        }

        // Helper functions for loadFromLocalStorage
        function loadStaffFromData(staffData) {
            const staffInputs = document.getElementById('staffInputs');
            staffInputs.innerHTML = '';
            
            staffData.forEach(name => {
                const staffContainer = document.createElement('div');
                staffContainer.className = 'staff-container';
                
                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.value = name;
                newInput.className = 'staff-name';
                newInput.addEventListener('input', debounce(saveToLocalStorage, 300));
                
                staffContainer.appendChild(newInput);
                staffInputs.appendChild(staffContainer);
            });
            
            // Add at least one staff input if none were loaded
            if (staffData.length === 0) {
                addStaffInput();
            }
        }

        function loadPatientsFromData(patientsData) {
            const patientInputs = document.getElementById('patientInputs');
            patientInputs.innerHTML = '';
            
            patientsData.forEach(({ name, staffCount }) => {
                const patientContainer = document.createElement('div');
                patientContainer.className = 'patient-container';
                
                const inputWrapper = document.createElement('div');
                inputWrapper.style.display = 'flex';
                inputWrapper.style.alignItems = 'center';
                inputWrapper.style.gap = '10px';
                
                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.value = name;
                newInput.className = 'patient-name';
                newInput.addEventListener('input', debounce(saveToLocalStorage, 300));
                
                const staffCountSelect = document.createElement('select');
                staffCountSelect.className = 'staff-count';
                staffCountSelect.addEventListener('change', debounce(saveToLocalStorage, 300));
                
                const option1 = document.createElement('option');
                option1.value = 1;
                option1.textContent = '1:1';
                const option2 = document.createElement('option');
                option2.value = 2;
                option2.textContent = '2:1';
                const option3 = document.createElement('option');
                option3.value = 3;
                option3.textContent = '3:1';
                
                staffCountSelect.appendChild(option1);
                staffCountSelect.appendChild(option2);
                staffCountSelect.appendChild(option3);
                staffCountSelect.value = staffCount || 1;
                
                inputWrapper.appendChild(newInput);
                inputWrapper.appendChild(staffCountSelect);
                patientContainer.appendChild(inputWrapper);
                patientInputs.appendChild(patientContainer);
            });
            
            // Add at least one patient input if none were loaded
            if (patientsData.length === 0) {
                addPatientInput();
            }
        }

        function loadSecurityStaffFromData(securityStaffData) {
            const securityStaffInputs = document.getElementById('securityStaffInputs');
            securityStaffInputs.innerHTML = '';
            
            // Reset the global array
            securityStaff = [];
            
            securityStaffData.forEach(name => {
                if (!securityStaff.includes(name)) {
                    securityStaff.push(name);
                }
                
                const securityContainer = document.createElement('div');
                securityContainer.className = 'security-container';
                
                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.value = name;
                newInput.className = 'security-name';
                newInput.addEventListener('input', debounce(saveToLocalStorage, 300));
                
                securityContainer.appendChild(newInput);
                securityStaffInputs.appendChild(securityContainer);
            });
        }

        function clearAllData() {
            // Clear all input containers
            document.getElementById('staffInputs').innerHTML = '';
            document.getElementById('patientInputs').innerHTML = '';
            document.getElementById('securityStaffInputs').innerHTML = '';
            document.getElementById('nurseInChargeInput').value = '';
            document.getElementById('nurseInCharge2Input').value = '';

            // Clear all display areas
            document.getElementById('scheduleHeader').innerHTML = '';
            document.getElementById('scheduleBody').innerHTML = '';
            document.getElementById('staffHeader').innerHTML = '';
            document.getElementById('staffBody').innerHTML = '';
            document.getElementById('breakHoursTable').querySelector('tbody').innerHTML = '';
            document.getElementById('stats').innerHTML = '';
            
            // Reset variables
            schedule = {};
            isDayShift = true;
            timeSlots = [...dayShiftSlots];
        }

        // Function to add staff input
function addStaffInput() {
    const staffInputs = document.getElementById('staffInputs');
    
    const staffContainer = document.createElement('div');
    staffContainer.className = 'staff-container';
    
    const newInput = document.createElement('input');
    newInput.type = 'text';
    newInput.placeholder = 'Enter HCW Name';
    newInput.className = 'staff-name';
    
    staffContainer.appendChild(newInput);
    staffInputs.appendChild(staffContainer);
    
    // Add event listener to the new input
    newInput.addEventListener('input', debounce(saveToLocalStorage, 300));
    
    saveToLocalStorage();
}

// Function to add patient input
function addPatientInput() {
    const patientInputs = document.getElementById('patientInputs');
    
    const patientContainer = document.createElement('div');
    patientContainer.className = 'patient-container';
    
    const inputWrapper = document.createElement('div');
    inputWrapper.style.display = 'flex';
    inputWrapper.style.alignItems = 'center';
    inputWrapper.style.gap = '10px';
    
    const newInput = document.createElement('input');
    newInput.type = 'text';
    newInput.placeholder = 'Enter Patient Name';
    newInput.className = 'patient-name';
    
    const staffCountSelect = document.createElement('select');
    staffCountSelect.className = 'staff-count';
    
    const option1 = document.createElement('option');
    option1.value = 1;
    option1.textContent = '1:1';
    const option2 = document.createElement('option');
    option2.value = 2;
    option2.textContent = '2:1';
    const option3 = document.createElement('option');
    option3.value = 3;
    option3.textContent = '3:1';
    
    staffCountSelect.appendChild(option1);
    staffCountSelect.appendChild(option2);
    staffCountSelect.appendChild(option3);
    staffCountSelect.value = 1; // Default to 1:1
    
    inputWrapper.appendChild(newInput);
    inputWrapper.appendChild(staffCountSelect);
    patientContainer.appendChild(inputWrapper);
    patientInputs.appendChild(patientContainer);
    
    // Add event listeners to the new elements
    newInput.addEventListener('input', debounce(saveToLocalStorage, 300));
    staffCountSelect.addEventListener('change', debounce(saveToLocalStorage, 300));
    
    saveToLocalStorage();
}

// Function to add security staff input
function addSecurityStaffInput() {
    const securityStaffInputs = document.getElementById('securityStaffInputs');
    
    // Check if we've reached the 1 security staff limit
    if (securityStaffInputs.children.length >= 1) {
        showError("Maximum of 1 security staff allowed");
        return;
    }
    
    const securityContainer = document.createElement('div');
    securityContainer.className = 'security-container';
    
    const newInput = document.createElement('input');
    newInput.type = 'text';
    newInput.placeholder = 'Enter Security Staff Name';
    newInput.className = 'security-name';
    
    securityContainer.appendChild(newInput);
    securityStaffInputs.appendChild(securityContainer);
    
    // Add event listener to the new input
    newInput.addEventListener('input', debounce(saveToLocalStorage, 300));
    
    saveToLocalStorage();
}

// Function to check if time is restricted for security
function isSecurityRestrictedHour(timeIndex, totalHours) {
    // First 2 hours or last 2 hours
    return timeIndex < 2 || timeIndex >= totalHours - 2;
}

// Add this comprehensive function to generate the schedule
function generateSchedule() {
    try {
        // Validate inputs before generating schedule
        if (!validateInputs()) {
            return;
        }

        // Get current values
        const staff = Array.from(document.querySelectorAll('.staff-name'))
            .map(input => input.value.trim())
            .filter(name => name); // Filter out empty names
            
        // Get security staff values
        const securityStaffValues = Array.from(document.querySelectorAll('.security-name'))
            .map(input => input.value.trim())
            .filter(name => name);
            
        // Update global security staff array for use in other functions
        securityStaff = [...securityStaffValues];
        
        // Get nurse in charge values
        const nurseInCharge1 = document.getElementById('nurseInChargeInput').value.trim();
        const nurseInCharge2 = document.getElementById('nurseInCharge2Input').value.trim();
        
        // Add nurses in charge to the staff list if they're not empty
        const allNurses = [];
        if (nurseInCharge1) {
            staff.push(nurseInCharge1);
            allNurses.push(nurseInCharge1);
        }
        if (nurseInCharge2) {
            staff.push(nurseInCharge2);
            allNurses.push(nurseInCharge2);
        }
        
        // Add security staff to the combined staff list
        const allStaff = [...staff, ...securityStaff];
        
        // Get patient inputs
        const patients = Array.from(document.querySelectorAll('.patient-container'))
            .map(container => {
                const name = container.querySelector('.patient-name').value.trim();
                if (!name) return null;
                
                return {
                    name,
                    staffCount: parseInt(container.querySelector('.staff-count').value)
                };
            })
            .filter(patient => patient !== null); // Filter out empty patients
        
        // Initialize schedule object with all time slots
        schedule = {};
        timeSlots.forEach(time => {
            schedule[time] = {
                patientAssignments: {},
                staffBreaks: {}
            };
            
            // Initialize patient assignments
            patients.forEach(patient => {
                schedule[time].patientAssignments[patient.name] = [];
            });
        });
        
        // Initialize staffPatientHistory if it doesn't exist
        if (!staffPatientHistory) {
            staffPatientHistory = {};
        }
        
        // Make sure all staff and patients have entries in staffPatientHistory
        staff.forEach(s => {
            if (!staffPatientHistory[s]) {
                staffPatientHistory[s] = {};
            }
            
            patients.forEach(patient => {
                if (!staffPatientHistory[s][patient.name]) {
                    staffPatientHistory[s][patient.name] = 0;
                }
            });
        });
        
        // Initialize stats object to track staff workload
        const staffStats = {};
        allStaff.forEach(s => {
            staffStats[s] = {
                workHours: 0,
                breakTime: 0,
                shortBreakTime: "",
                secondBreakTime: ""
            };
        });
        
        // First, assign break times
        assignBreaks(allStaff, staffStats);
        
        // Then, assign security duties for security staff (if any)
        assignSecurityDuties(securityStaff, staffStats);
        
        // Next, assign cleaning duties for night shift (if applicable)
        if (!isDayShift) {
            assignCleaningDuties(staff, securityStaff, nurseInCharge1, nurseInCharge2, staffStats);
        }
        
        // Finally, assign staff to patients using a fair algorithm
        assignPatients(staff, patients, staffStats);
        
        // Render the schedule
        renderSchedule(schedule, allStaff, patients.map(p => p.name), staffStats);
        
        // Render stats
        renderStats(staffStats, allStaff, patients.map(p => p.name));
        
        // Render rotation stats
        renderStaffRotationStats(
            patients.map(p => p.name), 
            staff.filter(s => !securityStaffValues.includes(s))
        );
        
        // Save to localStorage
        saveToLocalStorage();
        
        return true;
    } catch (error) {
        console.error("Error generating schedule:", error);
        showError("An error occurred while generating the schedule. Please check your inputs and try again.");
        return false;
    }
}

// Sub-functions for generateSchedule

function validateInputs() {
    // Check if there are any staff members
    const staffInputs = Array.from(document.querySelectorAll('.staff-name'))
        .map(input => input.value.trim())
        .filter(name => name);
        
    if (staffInputs.length === 0) {
        showError("Please add at least one Health Care Worker.");
        return false;
    }
    
    // Check if there are any patients
    const patientInputs = Array.from(document.querySelectorAll('.patient-name'))
        .map(input => input.value.trim())
        .filter(name => name);
        
    if (patientInputs.length === 0) {
        showError("Please add at least one patient.");
        return false;
    }
    
    // Check for duplicate staff names
    const allStaffInputs = [
        ...Array.from(document.querySelectorAll('.staff-name')).map(input => input.value.trim()),
        ...Array.from(document.querySelectorAll('.security-name')).map(input => input.value.trim()),
        document.getElementById('nurseInChargeInput').value.trim(),
        document.getElementById('nurseInCharge2Input').value.trim()
    ].filter(name => name);
    
    const uniqueStaff = new Set(allStaffInputs);
    if (uniqueStaff.size !== allStaffInputs.length) {
        showError("Each staff member must have a unique name. Please remove duplicates.");
        return false;
    }
    
    // Check for duplicate patient names
    const patientNames = Array.from(document.querySelectorAll('.patient-name'))
        .map(input => input.value.trim())
        .filter(name => name);
        
    const uniquePatients = new Set(patientNames);
    if (uniquePatients.size !== patientNames.length) {
        showError("Each patient must have a unique name. Please remove duplicates.");
        return false;
    }
    
    return true;
}

function assignBreaks(allStaff, staffStats) {
    allStaff.forEach(s => {
        if (isDayShift) {
            // Day shift: 30-min break and 1-hour 2nd break
            // Assign 30-min break to a random hour between 9:00 and 13:00
            const shortBreakHour = Math.floor(Math.random() * 4) + 1; // 1 to 4 (9:00 to 13:00)
            schedule[timeSlots[shortBreakHour]].staffBreaks[s] = "30-MIN BREAK";
            staffStats[s].breakTime += 0.5;
            staffStats[s].shortBreakTime = timeSlots[shortBreakHour];
            
            // Assign 1-hour 2nd break to a random hour between 14:00 and 17:00
            const secondBreakHour = Math.floor(Math.random() * 4) + 6; // 6 to 9 (14:00 to 17:00)
            schedule[timeSlots[secondBreakHour]].staffBreaks[s] = "2ND BREAK";
            staffStats[s].breakTime += 1;
            staffStats[s].secondBreakTime = timeSlots[secondBreakHour];
        } else {
            // Night shift: 2-hour continuous break
            // Choose a random starting hour between 23:00 and 3:00
            const breakStartHour = Math.floor(Math.random() * 5) + 3; // 3 to 7 (23:00 to 3:00)
            
            // Assign the 2-hour break (spanning 2 continuous time slots)
            schedule[timeSlots[breakStartHour]].staffBreaks[s] = "NIGHT BREAK";
            schedule[timeSlots[breakStartHour + 1]].staffBreaks[s] = "NIGHT BREAK";
            
            staffStats[s].breakTime += 2;
            staffStats[s].shortBreakTime = timeSlots[breakStartHour];
            staffStats[s].secondBreakTime = timeSlots[breakStartHour + 1];
        }
    });
}

function assignSecurityDuties(securityStaff, staffStats) {
    // Assign security duties for the first 2 and last 2 hours of the shift
    securityStaff.forEach(s => {
        const totalHours = timeSlots.length;
        for (let i = 0; i < totalHours; i++) {
            if (isSecurityRestrictedHour(i, totalHours)) {
                schedule[timeSlots[i]].staffBreaks[s] = "SECURITY DUTY";
            }
        }
    });
}

function assignCleaningDuties(staff, securityStaff, nurseInCharge1, nurseInCharge2, staffStats) {
    // Find regular staff (not security staff and not nurse in charge)
    const regularStaff = staff.filter(s => 
        !securityStaff.includes(s) && 
        s !== nurseInCharge1 && 
        s !== nurseInCharge2
    );
    
    if (regularStaff.length > 0) {
        // Create a map to track available free slots for each staff member
        const freeSlots = {};
        regularStaff.forEach(s => {
            freeSlots[s] = [];
            
            // Find all free time slots for this staff member
            timeSlots.forEach((time, timeIndex) => {
                // Skip if on break
                if (schedule[time].staffBreaks[s]) {
                    return;
                }
                
                // Skip security restricted hours
                if (isSecurityRestrictedHour(timeIndex, timeSlots.length)) {
                    return;
                }
                
                // This is a free slot
                freeSlots[s].push({ time, timeIndex });
            });
        });
        
        // Try to distribute duties fairly
        let dutiesAssigned = 0;
        const maxDutiesPerStaff = Math.ceil(cleaningDuties.length / regularStaff.length);
        const staffDutyCount = {};
        regularStaff.forEach(s => { staffDutyCount[s] = 0; });
        
        // Assign duties - prioritize staff with more free slots
        while (dutiesAssigned < cleaningDuties.length) {
            // Sort staff by number of duties assigned (ascending)
            const staffByAvailability = [...regularStaff].sort((a, b) => {
                return staffDutyCount[a] - staffDutyCount[b]; // Staff with fewer duties first
            });
            
            // Try to assign a duty to the first available staff
            let assigned = false;
            for (const s of staffByAvailability) {
                // Skip if this staff member has reached their duty limit
                if (staffDutyCount[s] >= maxDutiesPerStaff) continue;
                
                // Skip if no free slots
                if (freeSlots[s].length === 0) continue;
                
                // Get the duty to assign
                const duty = cleaningDuties[dutiesAssigned];
                
                // Try to find a good slot - prefer middle of shift when possible
                const middleSlots = freeSlots[s].filter(slot => slot.timeIndex >= 3 && slot.timeIndex <= 8);
                const slot = middleSlots.length > 0 ? middleSlots[0] : freeSlots[s][0];
                
                // Assign the duty
                schedule[slot.time].staffBreaks[s] = duty;
                
                // Store cleaning duty in the staff stats
                if (!staffStats[s].cleaningDuties) {
                    staffStats[s].cleaningDuties = [];
                }
                staffStats[s].cleaningDuties.push({
                    duty: duty,
                    time: slot.time
                });
                
                // Remove this slot from available slots
                freeSlots[s] = freeSlots[s].filter(fs => fs.time !== slot.time);
                
                // Update counters
                staffDutyCount[s]++;
                dutiesAssigned++;
                assigned = true;
                break;
            }
            
            // If we couldn't assign any more duties, break the loop
            if (!assigned || dutiesAssigned >= cleaningDuties.length) break;
        }
    }
}

function assignPatients(staff, patients, staffStats) {
    // Create a list of all time slots
    timeSlots.forEach(time => {
        // Get available staff for this time slot (those not on break)
        const availableStaff = staff.filter(s => !schedule[time].staffBreaks[s]);
        
        if (availableStaff.length === 0) {
            // No staff available for this time slot, all patients will be unassigned
            return;
        }
        
        // Sort patients by staffCount (highest first) to prioritize higher needs
        const sortedPatients = [...patients].sort((a, b) => b.staffCount - a.staffCount);
        
        // For each patient, assign the required number of staff
        for (const patient of sortedPatients) {
            // Calculate how many staff we can assign to this patient
            const staffNeeded = Math.min(patient.staffCount, availableStaff.length);
            
            if (staffNeeded === 0) {
                // No staff available for this patient
                continue;
            }
            
            // Find the best staff for this patient based on rotation history
            const bestStaff = findBestStaffForPatient(availableStaff, patient.name, staffNeeded);
            
            // Assign the staff to this patient
            bestStaff.forEach(s => {
                schedule[time].patientAssignments[patient.name].push(s);
                
                // Update rotation history
                staffPatientHistory[s][patient.name]++;
                
                // Update stats
                staffStats[s].workHours++;
                
                // Remove this staff from available staff for this time slot
                const index = availableStaff.indexOf(s);
                if (index !== -1) {
                    availableStaff.splice(index, 1);
                }
            });
        }
    });
}

function findBestStaffForPatient(availableStaff, patientName, count) {
    // Sort staff by how many times they've worked with this patient (ascending)
    const sorted = [...availableStaff].sort((a, b) => {
        const countA = staffPatientHistory[a][patientName] || 0;
        const countB = staffPatientHistory[b][patientName] || 0;
        return countA - countB;
    });
    
    // Return the top 'count' staff
    return sorted.slice(0, count);
}

function renderSchedule(schedule, staff, patients, staffStats) {
    // Clear previous schedule
    const scheduleHeader = document.getElementById('scheduleHeader');
    const scheduleBody = document.getElementById('scheduleBody');
    const staffHeader = document.getElementById('staffHeader');
    const staffBody = document.getElementById('staffBody');
    const breakHoursTable = document.getElementById('breakHoursTable').querySelector('tbody');
    
    scheduleHeader.innerHTML = '';
    scheduleBody.innerHTML = '';
    staffHeader.innerHTML = '';
    staffBody.innerHTML = '';
    breakHoursTable.innerHTML = '';
    
    // Create header for the patient schedule
    const headerRow = document.createElement('tr');
    
    // Add blank cell for the corner
    const cornerCell = document.createElement('th');
    headerRow.appendChild(cornerCell);
    
    // Add time slots as headers
    timeSlots.forEach(time => {
        const th = document.createElement('th');
        th.textContent = time;
        headerRow.appendChild(th);
    });
    
    scheduleHeader.appendChild(headerRow);
    
    // Create rows for each patient
    patients.forEach(patient => {
        const row = document.createElement('tr');
        
        // Add patient name as row header
        const nameCell = document.createElement('td');
        nameCell.textContent = patient;
        nameCell.className = 'row-header';
        row.appendChild(nameCell);
        
        // Add cells for each time slot
        timeSlots.forEach(time => {
            const cell = document.createElement('td');
            const assignedStaff = schedule[time].patientAssignments[patient];
            
            if (assignedStaff.length === 0) {
                cell.textContent = "UNASSIGNED";
                cell.className = 'staff-unassigned';
                cell.style.backgroundColor = "#ffeaa7"; // Yellow for unassigned
                cell.style.color = "#000000"; // Black text for contrast
            } else {
                // Use initials instead of full names
                const staffInitials = assignedStaff.map(name => getInitials(name)).join(", ");
                cell.textContent = staffInitials;
                
                // Add a title attribute for hover tooltip showing full names
                cell.title = assignedStaff.join(", ");
                
                // Color the cell based on the first assigned staff member's color
                if (assignedStaff.length > 0) {
                    // Generate a color based on the staff name
                    const staffName = assignedStaff[0];
                    const hash = staffName.split('').reduce((hash, char) => {
                        return ((hash << 5) - hash) + char.charCodeAt(0);
                    }, 0);
                    
                    const hue = Math.abs(hash) % 360;
                    const bgColor = `hsl(${hue}, 70%, 85%)`;
                    const textColor = hue > 30 && hue < 200 ? '#000000' : '#ffffff';
                    
                    cell.style.backgroundColor = bgColor;
                    cell.style.color = textColor;
                } else {
                    cell.style.backgroundColor = "#f8f9fa";
                    cell.style.color = "#000000";
                }
            }
            
            row.appendChild(cell);
        });
        
        scheduleBody.appendChild(row);
    });
    
    // Create header for the staff schedule
    const staffHeaderRow = document.createElement('tr');
    
    // Add blank cell for the corner
    const staffCornerCell = document.createElement('th');
    staffHeaderRow.appendChild(staffCornerCell);
    
    // Add time slots as headers
    timeSlots.forEach(time => {
        const th = document.createElement('th');
        th.textContent = time;
        staffHeaderRow.appendChild(th);
    });
    
    staffHeader.appendChild(staffHeaderRow);
    
    // Create a map of staff colors for consistent coloring
    const staffColors = {};
    staff.forEach(s => {
        // Generate a color based on the staff name
        const hash = s.split('').reduce((hash, char) => {
            return ((hash << 5) - hash) + char.charCodeAt(0);
        }, 0);
        
        const hue = Math.abs(hash) % 360;
        const bgColor = `hsl(${hue}, 70%, 85%)`;
        const textColor = hue > 30 && hue < 200 ? '#000000' : '#ffffff';
        
        staffColors[s] = { bgColor, textColor };
    });
    
    // Create rows for each staff member
    staff.forEach(s => {
        const row = document.createElement('tr');
        
        // Add staff name cell with initials
        const staffCell = document.createElement('td');
        staffCell.textContent = getInitials(s);
        staffCell.title = s; // Add full name as tooltip
        staffCell.className = 'row-header';
        
        // Check if this is security staff
        if (securityStaff.includes(s)) {
            // Special styling for security staff name cell
            staffCell.style.backgroundColor = "#ff9800"; // Orange background
            staffCell.style.color = "#000000"; // Black text for contrast
            staffCell.style.fontWeight = "bold";
            staffCell.title = s + " (Security)"; // Add explicit label
        } else if (staffColors[s]) {
            // Regular staff with their assigned color
            const { bgColor, textColor } = staffColors[s];
            staffCell.style.backgroundColor = bgColor;
            staffCell.style.color = textColor;
        } else {
            // Fallback colors
            staffCell.style.backgroundColor = "#f8f9fa";
            staffCell.style.color = "#000000";
        }
        
        row.appendChild(staffCell);
        
        // Add cells for each time slot
        timeSlots.forEach(time => {
            const cell = document.createElement('td');
            
            // Check if the staff is on break during this time
            const breakStatus = schedule[time].staffBreaks[s];
            if (breakStatus === "30-MIN BREAK") {
                cell.textContent = "BREAK";
                cell.className = 'staff-break';
            } else if (breakStatus === "2ND BREAK") {
                cell.textContent = "2ND BREAK";
                cell.className = 'staff-lunch';
            } else if (breakStatus === "NIGHT BREAK") {
                cell.textContent = "BREAK";
                cell.style.backgroundColor = "#673ab7"; // Purple for night break
                cell.style.color = "#ffffff";
            } else if (breakStatus === "SECURITY DUTY") {
                cell.textContent = "SECURITY";
                cell.style.backgroundColor = "#ffccbc"; // Light orange for security duty
                cell.style.color = "#000000";
            } else if (breakStatus && cleaningDuties.includes(breakStatus)) {
                // This is for cleaning duties
                cell.textContent = breakStatus;
                cell.style.backgroundColor = "#9c27b0"; // Purple for cleaning duties
                cell.style.color = "#ffffff";
            } else {
                // Staff is not on break, find which patient they're assigned to
                let assigned = false;
                for (const patient of patients) {
                    if (schedule[time].patientAssignments[patient] &&
                        schedule[time].patientAssignments[patient].includes(s)) {
                        cell.textContent = getInitials(patient);
                        cell.title = patient; // Add patient name as tooltip
                        
                        // Use the same color as the staff name for consistency
                        if (staffColors[s]) {
                            const { bgColor, textColor } = staffColors[s];
                            cell.style.backgroundColor = bgColor;
                            cell.style.color = textColor;
                        }
                        assigned = true;
                        break;
                    }
                }
                
                if (!assigned) {
                    cell.textContent = "FREE";
                    cell.style.backgroundColor = "#f8f9fa"; // Light gray for free time
                    cell.style.color = "#000000";
                }
            }
            
            row.appendChild(cell);
        });
        
        staffBody.appendChild(row);
    });
    
    // Render break hours table
    staff.forEach(s => {
        const row = document.createElement('tr');
        
        // Staff name cell with initials
        const staffCell = document.createElement('td');
        staffCell.textContent = getInitials(s);
        staffCell.title = s; // Add full name as tooltip
        row.appendChild(staffCell);
        
        // Break time cells
        const shortBreakCell = document.createElement('td');
        shortBreakCell.textContent = staffStats[s].shortBreakTime || "N/A";
        row.appendChild(shortBreakCell);
        
        const secondBreakCell = document.createElement('td');
        secondBreakCell.textContent = staffStats[s].secondBreakTime || "N/A";
        row.appendChild(secondBreakCell);
        
        breakHoursTable.appendChild(row);
    });
}

function renderStats(staffStats, staff, patients) {
    let statsHtml = '<h2>Health Care Worker (HCW) Work Summary</h2>';
    statsHtml += '<table>';
    
    if (isDayShift) {
        statsHtml += '<tr><th>HCW</th><th>Work Hours</th><th>Break Time</th><th>30-min Break</th><th>1-hour 2nd Break</th></tr>';
    } else {
        statsHtml += '<tr><th>HCW</th><th>Work Hours</th><th>Break Time</th><th>Break Time</th><th>Cleaning Duties</th></tr>';
    }
    
    staff.forEach(s => {
        if (isDayShift) {
            statsHtml += `<tr>
                <td title="${s}">${getInitials(s)}</td>
                <td>${staffStats[s].workHours} hours</td>
                <td>${staffStats[s].breakTime} hours</td>
                <td>${staffStats[s].shortBreakTime}</td>
                <td>${staffStats[s].secondBreakTime}</td>
            </tr>`;
        } else {
            // Display cleaning duties for night shift
            let cleaningDutiesText = "None";
            if (staffStats[s].cleaningDuties && staffStats[s].cleaningDuties.length > 0) {
                cleaningDutiesText = staffStats[s].cleaningDuties
                    .map(item => `${item.duty} (${item.time})`)
                    .join(', ');
            }
            
            statsHtml += `<tr>
                <td title="${s}">${getInitials(s)}</td>
                <td>${staffStats[s].workHours} hours</td>
                <td>${staffStats[s].breakTime} hours</td>
                <td>${staffStats[s].shortBreakTime} to ${staffStats[s].secondBreakTime}</td>
                <td>${cleaningDutiesText}</td>
            </tr>`;
        }
    });
    
    statsHtml += '</table>';
    
    // Add schedule coverage
    statsHtml += '<h2>Schedule Coverage</h2>';
    statsHtml += `<p>Total HCWs: ${staff.length}</p>`;
    statsHtml += `<p>Total Patients: ${patients.length}</p>`;
    
    // Calculate patient-to-HCW ratio
    const ratio = staff.length / patients.length;
    statsHtml += `<p>HCW-to-Patient Ratio: ${ratio.toFixed(2)}:1</p>`;
    
    // Calculate workload balance metrics
    const workHours = staff.map(s => staffStats[s].workHours);
    const maxHours = Math.max(...workHours);
    const minHours = Math.min(...workHours);
    const avgHours = workHours.reduce((sum, hours) => sum + hours, 0) / staff.length;
    const balanceScore = maxHours - minHours; // Lower is better
    
    statsHtml += '<h3>Work Balance Metrics</h3>';
    statsHtml += `<p>Maximum Work Hours: ${maxHours}</p>`;
    statsHtml += `<p>Minimum Work Hours: ${minHours}</p>`;
    statsHtml += `<p>Average Work Hours: ${avgHours.toFixed(1)}</p>`;
    statsHtml += `<p>Balance Score: ${balanceScore} (lower is better)</p>`;
    
    // Add this to the end of the renderStats function
    if (!isDayShift) {
        // Add a cleaning duties summary
        statsHtml += '<h3>Night Shift Cleaning Duties Summary</h3>';
        statsHtml += '<table>';
        statsHtml += '<tr><th>Duty</th><th>Assigned To</th><th>Time</th><th>Status</th></tr>'; // Added Status column
        
        // Create a map of duties to staff
        const dutyAssignments = {};
        staff.forEach(s => {
            if (staffStats[s].cleaningDuties) {
                staffStats[s].cleaningDuties.forEach(item => {
                    dutyAssignments[item.duty] = {
                        staff: s,
                        time: item.time
                    };
                });
            }
        });
        
        // Track how many duties are assigned and unassigned
        let assignedCount = 0;
        let unassignedCount = 0;
        
        // List all possible cleaning duties
        cleaningDuties.forEach(duty => {
            const assignment = dutyAssignments[duty];
            if (assignment) {
                statsHtml += `<tr>
                    <td>${duty}</td>
                    <td title="${assignment.staff}">${getInitials(assignment.staff)}</td>
                    <td>${assignment.time}</td>
                    <td style="color: green; font-weight: bold;">✓ Assigned</td>
                </tr>`;
                assignedCount++;
            } else {
                statsHtml += `<tr>
                    <td>${duty}</td>
                    <td>Not Assigned</td>
                    <td>N/A</td>
                    <td style="color: red; font-weight: bold;">⚠ Unassigned</td>
                </tr>`;
                unassignedCount++;
            }
        });
        
        // Add summary row at the bottom
        statsHtml += `<tr style="background-color: #f8f9fa;">
            <td colspan="3" style="text-align: right; font-weight: bold;">Duty Completion Rate:</td>
            <td>${assignedCount} of ${cleaningDuties.length} (${Math.round(assignedCount/cleaningDuties.length*100)}%)</td>
        </tr>`;
        
        // Show remaining duties count
        if (unassignedCount > 0) {
            statsHtml += `<tr style="background-color: #fff3cd; color: #856404;">
                <td colspan="3" style="text-align: right; font-weight: bold;">Remaining Duties:</td>
                <td>${unassignedCount}</td>
            </tr>`;
        }
        
        statsHtml += '</table>';
    }
    
    // Set the HTML for the stats section
    document.getElementById('stats').innerHTML = statsHtml;
}

function renderStaffRotationStats(patients, staff) {
    // Generate a table showing how many times each staff member has worked with each patient
    let rotationHtml = '<h2>Staff-Patient Rotation History</h2>';
    rotationHtml += '<p>This table shows how many times each staff member has worked with each patient across all schedules.</p>';
    rotationHtml += '<table class="rotation-table">';
    
    // Header row with patient initials
    rotationHtml += '<tr><th>Staff</th>';
    patients.forEach(patient => {
        const patientName = typeof patient === 'object' ? patient.name : patient;
        rotationHtml += `<th title="${patientName}">${getInitials(patientName)}</th>`;
    });
    rotationHtml += '</tr>';
    
    // Rows for each staff member with initials
    staff.forEach(s => {
        rotationHtml += `<tr><td title="${s}">${getInitials(s)}</td>`;
        
        // For each patient, show the rotation count
        patients.forEach(patient => {
            const patientName = typeof patient === 'object' ? patient.name : patient;
            const count = staffPatientHistory[s] && staffPatientHistory[s][patientName] ? 
                staffPatientHistory[s][patientName] : 0;
            
            // Color the cell based on the count (darker for higher counts)
            const bgColor = count === 0 ? 
                '#ffffff' : `rgba(0, 123, 255, ${Math.min(0.1 + (count * 0.1), 0.9)})`;
            const textColor = count >= 5 ? '#ffffff' : '#000000';
            
            rotationHtml += `<td style="background-color: ${bgColor}; color: ${textColor};">${count}</td>`;
        });
        
        rotationHtml += '</tr>';
    });
    
    rotationHtml += '</table>';
    rotationHtml += '<p><em>Note: Lower numbers (lighter cells) indicate staff members who have worked less frequently with those patients.</em></p>';
    
    document.getElementById('rotationStats').innerHTML = rotationHtml;
}

// Initialize on window load
window.onload = function() {
    // Set moon emoji for dark mode button
    document.getElementById('toggleModeBtn').innerHTML = '🌙';
    
    try {
        // Load data from localStorage
        loadFromLocalStorage();
        
        // Make sure dark mode is correctly applied based on saved preference
        const savedData = localStorage.getItem('patientCareData');
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            if (parsedData.isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('toggleModeBtn').textContent = '☀️';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('toggleModeBtn').textContent = '🌙';
            }
        }
        
        // Rest of your onload code...
    } catch (error) {
        logError("Initialization Error", "Failed to initialize application", error);
    }

    // Initialize inputs if none exist
    if (document.getElementById('staffInputs').children.length === 0) {
        addStaffInput();
    }
    if (document.getElementById('patientInputs').children.length === 0) {
        addPatientInput();
    }
    if (document.getElementById('securityStaffInputs').children.length === 0) {
        addSecurityStaffInput();
    }

    // Initialize legend
    updateLegend();
};

document.getElementById('resetRotationBtn').addEventListener('click', () => {
    // Get current staff and patients from inputs
    const currentStaff = Array.from(document.querySelectorAll('.staff-name')).map(input => input.value.trim());
    
    // Get security staff too
    const currentSecurityStaff = Array.from(document.querySelectorAll('.security-name')).map(input => input.value.trim());
    
    // Combine regular and security staff
    const allStaff = [...currentStaff, ...currentSecurityStaff];
    
    // Get current patients
    const currentPatients = Array.from(document.querySelectorAll('.patient-container')).map(container => {
        return {
            name: container.querySelector('.patient-name').value.trim(),
            staffCount: parseInt(container.querySelector('.staff-count').value)
        };
    });
    
    // Reset staffPatientHistory
    staffPatientHistory = {};
    
    // Initialize for current staff and patients
    allStaff.forEach(s => {
        if (s) { // Only process non-empty staff names
            staffPatientHistory[s] = {};
            currentPatients.forEach(patient => {
                if (patient.name) { // Only process non-empty patient names
                    staffPatientHistory[s][patient.name] = 0;
                }
            });
        }
    });
    
    // Save to localStorage
    saveToLocalStorage();
    
    // Show confirmation
    const confirmationDiv = document.createElement('div');
    confirmationDiv.className = 'error-message'; // Using the existing error-message class
    confirmationDiv.style.backgroundColor = '#4CAF50'; // Green for success
    confirmationDiv.textContent = "Staff rotation history has been reset.";
    document.body.appendChild(confirmationDiv);
    setTimeout(() => confirmationDiv.remove(), 3000);
    
    // Regenerate schedule if exists
    if (Object.keys(schedule).length > 0) {
        generateSchedule();
    } else {
        // If no schedule, just update the rotation stats display
        renderStaffRotationStats(
            currentPatients.map(p => p.name), 
            allStaff.filter(s => s) // Filter out empty strings
        );
    }
});

        // Add these event listeners to your window.onload function
document.getElementById('generateBtn').addEventListener('click', generateSchedule);

document.getElementById('resetBtn').addEventListener('click', function() {
    clearAllData();
    localStorage.removeItem('patientCareData');
    addStaffInput();
    addPatientInput();
    addSecurityStaffInput();
});

document.getElementById('addStaffBtn').addEventListener('click', addStaffInput);
document.getElementById('removeStaffBtn').addEventListener('click', function() {
    const staffInputs = document.getElementById('staffInputs');
    if (staffInputs.lastChild) {
        staffInputs.removeChild(staffInputs.lastChild);
        saveToLocalStorage();
    }
});

document.getElementById('addPatientBtn').addEventListener('click', addPatientInput);
document.getElementById('removePatientBtn').addEventListener('click', function() {
    const patientInputs = document.getElementById('patientInputs');
    if (patientInputs.lastChild) {
        patientInputs.removeChild(patientInputs.lastChild);
        saveToLocalStorage();
    }
});

document.getElementById('addSecurityStaffBtn').addEventListener('click', addSecurityStaffInput);
document.getElementById('removeSecurityStaffBtn').addEventListener('click', function() {
    const securityStaffInputs = document.getElementById('securityStaffInputs');
    if (securityStaffInputs.lastChild) {
        securityStaffInputs.removeChild(securityStaffInputs.lastChild);
        saveToLocalStorage();
    }
});

document.getElementById('toggleShiftBtn').addEventListener('click', function() {
    isDayShift = !isDayShift;
    timeSlots = isDayShift ? [...dayShiftSlots] : [...nightShiftSlots];
    document.getElementById('siteTitle').textContent = isDayShift ? "Day Shift Allocation" : "Night Shift Allocation";
    this.textContent = isDayShift ? "Switch to Night Shift" : "Switch to Day Shift";
    
    // Show or hide cleaning duties section based on shift
    document.getElementById('cleaningDutiesSection').style.display = isDayShift ? 'none' : 'block';
    
    // Update legend based on shift
    updateLegend();
    saveToLocalStorage();
    
    // If night shift, populate cleaning duties table
    if (!isDayShift) {
        populateCleaningDutiesTable();
    }
    
    // If a schedule exists, regenerate it with the new shift type
    if (Object.keys(schedule).length > 0) {
        generateSchedule();
    }
});

document.getElementById('toggleModeBtn').addEventListener('click', function() {
    document.body.classList.toggle('dark-mode');
    this.textContent = document.body.classList.contains('dark-mode') ? '☀️' : '🌙';
    saveToLocalStorage();
});

document.getElementById('debugFillBtn').addEventListener('click', function() {
    // Mock data
    const staffNames = ['John Smith', 'Maria Rodriguez', 'Robert Johnson', 'Sarah Brown', 'David Lee'];
    const patientNames = ['Patient A', 'Patient B', 'Patient C', 'Patient D'];
    const securityNames = ['Security Officer Jones'];
    const nurseNames = ['Charge Nurse Wilson', 'Charge Nurse Thompson'];
    
    // Fill nurse in charge inputs
    document.getElementById('nurseInChargeInput').value = nurseNames[0];
    document.getElementById('nurseInCharge2Input').value = nurseNames[1];
    
    // Fill existing staff inputs without changing structure
    const staffInputs = document.querySelectorAll('.staff-container .staff-name');
    staffInputs.forEach((input, index) => {
        input.value = index < staffNames.length ? staffNames[index] : `Staff ${index + 1}`;
    });
    
    // Fill existing security staff inputs without changing structure
    const securityStaffInputs = document.querySelectorAll('.security-container .security-name');
    securityStaffInputs.forEach((input, index) => {
        input.value = index < securityNames.length ? securityNames[index] : `Security ${index + 1}`;
    });
    
    // Fill existing patient inputs without changing structure
    const patientContainers = document.querySelectorAll('.patient-container');
    patientContainers.forEach((container, index) => {
        const nameInput = container.querySelector('.patient-name');
        const staffCountSelect = container.querySelector('.staff-count');
        
        nameInput.value = index < patientNames.length ? patientNames[index] : `Patient ${index + 1}`;
        staffCountSelect.value = (index % 3) + 1; // Cycle through 1, 2, 3
    });
    
    // Show confirmation message
    const confirmationDiv = document.createElement('div');
    confirmationDiv.className = 'error-message';
    confirmationDiv.style.backgroundColor = '#4CAF50'; // Green for success
    confirmationDiv.textContent = "Debug data filled successfully!";
    document.body.appendChild(confirmationDiv);
    setTimeout(() => confirmationDiv.remove(), 3000);
    
    // Save to localStorage
    saveToLocalStorage();
});

// Add event listener to document to close debug panel when clicking outside
document.addEventListener('click', function(event) {
    const debugPanel = document.getElementById('debugPanel');
    const toggleButton = document.getElementById('toggleDebugBtn');
    
    // If debug panel is visible
    if (debugPanel.style.display !== 'none') {
        // Check if click was outside debug panel and not on the toggle button
        if (!debugPanel.contains(event.target) && event.target !== toggleButton) {
            debugPanel.style.display = 'none';
        }
    }
});

// Prevent clicks inside the debug panel from bubbling to document
document.getElementById('debugPanel').addEventListener('click', function(event) {
    event.stopPropagation();
});
    </script>
</body>
</html>
`