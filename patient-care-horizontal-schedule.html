<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Care Schedule - Horizontal Layout</title>
    <style>
        /* Core styling for light and dark modes */
        :root {
            --background-color: #f9f9f9; /* Light background */
            --text-color: #333333; /* Dark text color */
            --container-bg-color: #ffffff; /* White container background */
            --button-bg-color: #0077ff; /* Bright blue button color */
            --button-hover-bg-color: #0056cc; /* Darker blue for hover */
            --table-header-bg-color: #f3f4f6; /* Light gray for table headers */
            --table-header-text-color: #333333; /* Dark text for table headers */
            --table-cell-bg-color: #ffffff; /* White table cell background */
            --table-cell-text-color: #333333; /* Dark text color for table cells */
            --break-bg-color: #ffefc1; /* Soft yellow for breaks */
            --lunch-bg-color: #c1f0c1; /* Soft green for lunch */
            --unassigned-bg-color: #ffc1c1; /* Soft red for unassigned */
            --primary-font: 'Poppins', sans-serif; /* Modern font */
        }

        /* Dark mode overrides */
        body.dark-mode {
            --background-color: #1f2937; /* Dark background */
            --text-color: #f9fafb; /* Light text color */
            --container-bg-color: #374151; /* Dark gray container background */
            --button-bg-color: #2563eb; /* Blue button color */
            --button-hover-bg-color: #1d4ed8; /* Darker blue for hover */
            --table-header-bg-color: #4b5563; /* Darker gray for table headers */
            --table-header-text-color: #f9fafb; /* Light text for table headers */
            --table-cell-bg-color: #4b5563; /* Dark gray table cell background */
            --table-cell-text-color: #f9fafb; /* Light text color for table cells */
            --break-bg-color: #fbbf24; /* Yellow for breaks */
            --lunch-bg-color: #22c55e; /* Green for lunch */
            --unassigned-bg-color: #ef4444; /* Red for unassigned */
        }

        /* General body styling */
        body {
            font-family: var(--primary-font);
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.8;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        h1, h2 {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 20px;
        }
        h1 {
            font-size: 2.5rem;
            text-align: center;
            margin-top: 20px;
        }
        h2 {
            font-size: 1.8rem;
        }
        .container {
            width: 100%; /* Ensure it takes full width */
            max-width: 1200px; /* Limit the maximum width */
            min-width: 800px; /* Ensure a minimum width for smaller content */
            margin: 0 auto;
            padding: 30px;
            background-color: var(--container-bg-color);
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            overflow-x: auto; /* Allow horizontal scrolling for overflowing content */
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
        }
        .setup-section {
            background-color: var(--container-bg-color); /* Use dark mode container background */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e4e8;
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease; /* Smooth transition */
        }
        .setup-section h2 {
            margin-bottom: 10px;
        }
        .staff-inputs, .patient-inputs, .security-staff-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;

        }
        input, select {
            padding: 8px;
            border: 1px solid #dfe4ea;
            border-radius: 5px;
            width: 150px; /* Shortened width */
            font-size: 14px;
            background-color: #ffffff;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        input:focus, select:focus, button:focus {
            outline: 3px solid #4a69bd;
            box-shadow: 0 0 5px rgba(74, 105, 189, 0.5);
        }
        button {
            background-color: var(--button-bg-color);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: var(--button-hover-bg-color);
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--table-cell-bg-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 15px;
            text-align: center;
            font-size: 14px;
            background-color: var(--table-cell-bg-color);
            color: var(--table-cell-text-color);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        th {
            background-color: var(--table-header-bg-color);
            color: var(--table-header-text-color);
            font-weight: 600;
        }
        tr:nth-child(even) td {
            background-color: #f9fafb;
            color: var(--table-cell-text-color); /* Explicitly set text color */
        }
        tr:nth-child(odd) td {
            background-color: var(--table-cell-bg-color);
            color: var(--table-cell-text-color); /* Explicitly set text color */
        }
        .row-header {
            background-color: var(--table-header-bg-color);
            color: var(--table-header-text-color);
            font-weight: bold;
            text-align: left;
        }
        .staff-break {
            background-color: var(--break-bg-color);
            color: #000000; /* Ensure black text for contrast with yellow background */
            font-weight: bold;
        }
        .staff-lunch {
            background-color: var(--lunch-bg-color);
            color: #000000; /* Ensure black text for contrast with green background */
            font-weight: bold;
        }
        .schedule-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        .stats {
            margin-top: 20px;
            background-color: var(--container-bg-color); /* Use dark mode container background */
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e4e8;
            color: var(--text-color); /* Ensure text color adapts to dark mode */
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease; /* Smooth transition */
        }
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            justify-content: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 50%;
        }
        .legend-break {
            background-color: var(--break-bg-color);
        }
        .legend-lunch {
            background-color: var(--lunch-bg-color);
        }
        .legend-unassigned {
            background-color: var(--unassigned-bg-color);
        }
        .legend-security {
            background-color: #ffccbc;
        }
        .legend-night-break {
            background-color: #673ab7;
        }
        .staff-cleaning-duty {
            background-color: #9c27b0; /* Purple color for cleaning duties */
            color: #ffffff; /* White text for contrast */
            font-weight: bold;
        }

        .legend-cleaning-duty {
            background-color: #9c27b0;
        }

        /* Ensure text color is visible for cells with white background in dark mode */
        body.dark-mode td {
            color: var(--text-color); /* Use the light text color defined for dark mode */
        }

        body.dark-mode tr:nth-child(even) td {
            background-color: #374151; /* Dark gray for even rows in dark mode */
            color: var(--table-cell-text-color); /* Ensure text color is visible */
        }

        body.dark-mode tr:nth-child(odd) td {
            background-color: var(--table-cell-bg-color); /* Dark gray for odd rows in dark mode */
            color: var(--table-cell-text-color); /* Ensure text color is visible */
        }

        /* Explicitly set text color for cells with white background */
        body.dark-mode td[style*="background-color: #ffffff"] {
            color: #333333; /* Dark text color for white background */
        }

        .staff-count {
            padding: 5px; /* Reduce padding */
            border: 1px solid #dfe4ea;
            border-radius: 5px;
            width: 80px; /* Adjust width to save space */
            font-size: 12px; /* Reduce font size */
            background-color: #ffffff;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .staff-count:focus {
            outline: none;
            border-color: #4a69bd;
            box-shadow: 0 0 5px rgba(74, 105, 189, 0.5);
        }

        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #f44336;
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 1000;
        }

        /* Explicitly set text color for cells when in dark mode */
        body.dark-mode .staff-break {
            background-color: var(--break-bg-color); /* Your dark mode yellow */
            color: #000000; /* Keep black text which contrasts with yellow */
        }

        body.dark-mode .staff-lunch {
            background-color: var(--lunch-bg-color); /* Your dark mode green */
            color: #000000; /* Keep black text which contrasts with green */
        }

        /* Other cells with custom colors in dark mode may need adjustments */
        body.dark-mode td.row-header {
            color: var(--table-header-text-color);
        }

        .rotation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .rotation-table th, .rotation-table td {
            border: 1px solid #e5e7eb;
            padding: 15px;
            text-align: center;
            font-size: 14px;
        }

        .rotation-table th {
            background-color: var(--table-header-bg-color);
            color: var(--table-header-text-color);
            font-weight: 600;
        }

        /* Staff selection popup */
        #staffPopup {
            display: none;
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -30%);
            background-color: var(--container-bg-color);
            color: var(--text-color);
            border: 2px solid var(--button-bg-color);
            border-radius: 12px;
            z-index: 2000;
            padding: 25px;
            min-width: 350px;
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        #staffPopup h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        #staffList {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        /* Style for popup buttons */
        #staffPopup button {
            border-radius: 6px;
            padding: 10px 15px;
            font-size: 14px;
        }

        #staffPopup #removeAllStaffBtn {
            background-color: #f44336;
            color: white;
        }

        #staffPopup #removeAllStaffBtn:hover {
            background-color: #d32f2f;
        }

        #staffPopup #closePopupBtn {
            background-color: #6c757d;
            color: white;
        }

        #staffPopup #closePopupBtn:hover {
            background-color: #5a6268;
        }

        /* Popup overlay for better focus */
        #popupOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1999;
        }

        /* Clickable cell cursor */
        .assignable-staff-cell {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .assignable-staff-cell:hover {
            opacity: 0.8;
            transform: scale(1.02);
        }

        /* Debug panel styles */
        #debugPanel {
            display: none;
            position: fixed;
            bottom: 0;
            right: 0;
            width: 400px;
            height: 300px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            overflow: auto;
            z-index: 1000;
            font-family: monospace;
            font-size: 12px;
        }

        #debugPanel h3 {
            margin-top: 0;
            border-bottom: 1px solid white;
        }

        #debugOutput {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        #toggleDebugBtn {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Title dynamically updates based on the current shift -->
        <h1 id="siteTitle">Day Shift Allocation</h1>

        <!-- Buttons for toggling shift and dark mode -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button id="toggleShiftBtn" style="padding: 10px 20px; font-size: 14px;">Switch to Night Shift</button>
            <button id="toggleModeBtn" title="Toggle Dark/Light Mode"></button>
        </div>

        <!-- Replace the Security Staff and Nurse in Charge sections with this flex container -->
        <div class="setup-section" style="margin-bottom: 20px;">
            <div style="display: flex; gap: 40px; align-items: flex-start;">
                <!-- Security Staff Section -->
                <div>
                    <h2>Security Staff <span style="color: red;">*</span></h2>
                    <div class="security-staff-inputs" id="securityStaffInputs">
                        <div class="security-container">
                            <input type="text" placeholder="Enter Security Staff Name" class="security-name" required>
                        </div>
                    </div>
                </div>

                <!-- Combined Nurses Section -->
                <div>
                    <h2>Nursing Staff</h2>
                    <div style="margin-bottom: 15px;">
                        <label for="nurseInChargeInput"><strong>Nurse in Charge 1:</strong></label>
                        <input type="text" id="nurseInChargeInput" placeholder="Enter First Nurse in Charge" style="width: 250px; margin-bottom: 15px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="nurseInCharge2Input"><strong>Nurse in Charge 2:</strong></label>
                        <input type="text" id="nurseInCharge2Input" placeholder="Enter Second Nurse in Charge" style="width: 250px; margin-bottom: 15px;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Add this new section for Health Care Workers only -->
<div class="setup-section" style="margin-bottom: 20px;">
    <h2>Health Care Workers</h2>
    <div class="staff-inputs" id="staffInputs"></div>
    <button id="addStaffBtn">Add Health Care Worker</button>
    <button id="removeStaffBtn">Remove Health Care Worker</button>
</div>

        <!-- Section for managing health care workers and patients -->
        <div class="setup-section">
            <h2>Patient Names</h2>
            <div class="patient-inputs" id="patientInputs"></div>
            <button id="addPatientBtn">Add Patient</button>
            <button id="removePatientBtn">Remove Patient</button>

            <!-- Buttons for generating and resetting the schedule -->
            <button id="generateBtn">Generate Schedule</button>
            <button id="resetBtn">Reset</button>
            <!-- Debugging Button -->
            <!-- This button is for debugging purposes only. Remove this button and its functionality before final deployment. -->
            <button id="debugFillBtn" style="background-color: #ff5722; color: white; margin-top: 10px;">Debug: Fill Random Names</button>
        </div>

        <!-- Legend for schedule colors -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color legend-break"></div>
                <div>30-min Break</div>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-lunch"></div>
                <div>1-hour 2nd Break</div>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-unassigned"></div>
                <div>Unassigned</div>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-security"></div>
                <div>Security Duty</div>
            </div>
        </div>

        <!-- Schedule tables -->
        <div class="schedule-container">
            <h2>Patient Care Schedule</h2>
            <table id="scheduleTable">
                <thead id="scheduleHeader"></thead>
                <tbody id="scheduleBody"></tbody>
            </table>
        </div>

        <div class="schedule-container">
            <h2>Staff Schedule</h2>
            <table id="staffTable">
                <thead id="staffHeader"></thead>
                <tbody id="staffBody"></tbody>
            </table>
        </div>

        <div class="schedule-container">
            <h2>Staff Break Hours</h2>
            <table id="breakHoursTable">
                <thead>
                    <tr>
                        <th>Staff</th>
                        <th>30-min Break</th>
                        <th>1-hour 2nd Break</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Statistics section -->
        <div class="stats" id="stats"></div>

        <!-- Staff-Patient Rotation section -->
        <div class="stats" id="rotationStats"></div>

        <button id="resetRotationBtn" class="action-button">Reset Rotation History</button>
    </div>

    <div id="debugPanel" style="display: none; position: fixed; bottom: 0; right: 0; width: 400px; height: 300px; background-color: rgba(0,0,0,0.8); color: white; padding: 10px; overflow: auto; z-index: 1000; font-family: monospace; font-size: 12px;">
    <h3 style="margin-top: 0; border-bottom: 1px solid white;">Debug Console</h3>
    <button id="clearDebugBtn" style="position: absolute; top: 10px; right: 10px; background-color: #f44336; color: white; border: none; border-radius: 4px; padding: 5px;">Clear</button>
    <div id="debugOutput"></div>
</div>

<button id="toggleDebugBtn" style="position: fixed; bottom: 10px; right: 10px; background-color: #333; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; z-index: 999;">üêû</button>

    <!-- Staff selection popup with overlay -->
<div id="popupOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
     background-color: rgba(0,0,0,0.5); z-index:1999;"></div>

<div id="staffPopup" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%,-30%);
     background-color: var(--container-bg-color); color: var(--text-color); border:2px solid var(--button-bg-color);
     border-radius:12px; z-index:2000; padding:25px; min-width:350px; max-width:500px; max-height:70vh;
     overflow-y:auto; box-shadow: 0 8px 25px rgba(0,0,0,0.3);">
    <h3>Select Staff for <span id="popupPatientName"></span> at <span id="popupTimeSlot"></span></h3>
    <div id="staffList" style="max-height: 300px; overflow-y: auto; margin: 15px 0;"></div>
    <div style="display: flex; justify-content: space-between; margin-top: 15px;">
        <button id="removeAllStaffBtn" style="background-color: #f44336;">Remove All Staff</button>
        <button id="closePopupBtn">Cancel</button>
    </div>
</div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="api.js"></script>
    <script>
        // Add this function near the top of your script section with other utility functions
        function getInitials(fullName) {
            if (!fullName) return '';

            // Split the name by spaces
            const nameParts = fullName.trim().split(' ');

            // If it's a single name, return first 2 letters
            if (nameParts.length === 1) {
                return nameParts[0].substring(0, 2).toUpperCase();
            }

            // Otherwise return first letter of first name + first letter of last name
            const firstInitial = nameParts[0][0] || '';
            const lastInitial = nameParts[nameParts.length - 1][0] || '';

            return (firstInitial + lastInitial).toUpperCase();
        }

        // In the updateLegend function, update the break hours table header
        function updateLegend() {
            // Update legend based on shift
            const legendDiv = document.querySelector('.legend');
            if (isDayShift) {
                legendDiv.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color legend-break"></div>
                        <div>30-min Break</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-lunch"></div>
                        <div>1-hour 2nd Break</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-unassigned"></div>
                        <div>Patient Unassigned</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-security"></div>
                        <div>Security Duty</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #4CAF50;"></div>
                        <div>OBS</div>
                    </div>
                `;
            } else {
                legendDiv.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color legend-night-break"></div>
                        <div>2-hour Break</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-cleaning-duty"></div>
                        <div>Cleaning Duty</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-unassigned"></div>
                        <div>Patient Unassigned</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-security"></div>
                        <div>Security Duty</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #4CAF50;"></div>
                        <div>OBS</div>
                    </div>
                `;
            }

            // Update break hours table header
            const breakHoursTableHead = document.querySelector('#breakHoursTable thead');
            if (isDayShift) {
                breakHoursTableHead.innerHTML = `
                <tr>
                    <th>Staff</th>
                    <th>30-min Break</th>
                    <th>1-hour 2nd Break</th>
                </tr>`;
            } else {
                breakHoursTableHead.innerHTML = `
                <tr>
                    <th>Staff</th>
                    <th>2-hour Break Time</th>
                    <th>Status</th>
                </tr>`;
            }
        }

        // Global variables
        let schedule = {};
        let isDayShift = true;
        let securityStaff = []; // Add this new global variable
        let staffPatientHistory = {};
        const cleaningDuties = [
            "DINING ROOM", "OFFICE ROOM", "TAKE OUT BINS", "LAUNDRY ROOM", "PHONE ROOM",
            "LOUNGE", "KITCHEN", "QUIET ROOM", "CORRIDOR", "TOILETS"
        ];
        let nurseInCharge1 = '';
        let nurseInCharge2 = '';

        // Initialize API instance
        const api = new ScheduleAPI();

        // Current schedule ID (for saving/loading specific schedules)
        let currentScheduleId = `schedule_${new Date().toISOString().split('T')[0]}`;

        // Time slots for day and night shifts
        const dayShiftSlots = [
            "08:00-09:00", "09:00-10:00", "10:00-11:00", "11:00-12:00",
            "12:00-13:00", "13:00-14:00", "14:00-15:00", "15:00-16:00",
            "16:00-17:00", "17:00-18:00", "18:00-19:00", "19:00-20:00"
        ];

        const nightShiftSlots = [
            "20:00-21:00", "21:00-22:00", "22:00-23:00", "23:00-00:00",
            "00:00-01:00", "01:00-02:00", "02:00-03:00", "03:00-04:00",
            "04:00-05:00", "05:00-06:00", "06:00-07:00", "07:00-08:00"
        ];

        // Current time slots (default to day shift)
        let timeSlots = [...dayShiftSlots];

        // Helper functions
        function getInputValues(selector) {
            return Array.from(document.querySelectorAll(selector)).map(input => input.value.trim());
        }

        function getElement(id) {
            return document.getElementById(id);
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            }
        }

        // Debounced save function for AJAX
        // Debounced cookie save function
        const debouncedSaveToCookies = debounce(saveInputsToCookies, 300);

        // Cookie-based storage functions (temporary data only)
        function setCookie(name, value, days = 1) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
        }

        function saveInputsToCookies() {
            // Only save current input values to cookies (temporary storage)
            const staffInputs = Array.from(document.querySelectorAll('.staff-name')).map(input => input.value.trim());
            const patientInputs = Array.from(document.querySelectorAll('.patient-container')).map(container => {
                return {
                    name: container.querySelector('.patient-name').value.trim(),
                    staffCount: parseInt(container.querySelector('.staff-count').value)
                };
            });
            const securityStaff = document.querySelector('.security-name')?.value.trim() || '';
            const nurse1 = document.getElementById('nurseInChargeInput')?.value.trim() || '';
            const nurse2 = document.getElementById('nurseInCharge2Input')?.value.trim() || '';

            setCookie('tempStaff', JSON.stringify(staffInputs));
            setCookie('tempPatients', JSON.stringify(patientInputs));
            setCookie('tempSecurity', securityStaff);
            setCookie('tempNurse1', nurse1);
            setCookie('tempNurse2', nurse2);
        }

        function loadInputsFromCookies() {
            // Load only if cookies exist
            const staffData = getCookie('tempStaff');
            const patientData = getCookie('tempPatients');
            const securityData = getCookie('tempSecurity');
            const nurse1Data = getCookie('tempNurse1');
            const nurse2Data = getCookie('tempNurse2');

            if (staffData) {
                const staff = JSON.parse(staffData);
                const staffInputs = document.getElementById('staffInputs');
                staffInputs.innerHTML = '';
                staff.forEach(name => {
                    addStaffInput();
                    const inputs = document.querySelectorAll('.staff-name');
                    inputs[inputs.length - 1].value = name;
                });
            }

            if (patientData) {
                const patients = JSON.parse(patientData);
                const patientInputs = document.getElementById('patientInputs');
                patientInputs.innerHTML = '';
                patients.forEach(patient => {
                    addPatientInput();
                    const containers = document.querySelectorAll('.patient-container');
                    const lastContainer = containers[containers.length - 1];
                    lastContainer.querySelector('.patient-name').value = patient.name;
                    lastContainer.querySelector('.staff-count').value = patient.staffCount;
                });
            }

            if (securityData) {
                const securityInput = document.querySelector('.security-name');
                if (securityInput) securityInput.value = securityData;
            }

            if (nurse1Data) {
                const nurse1Input = document.getElementById('nurseInChargeInput');
                if (nurse1Input) nurse1Input.value = nurse1Data;
            }

            if (nurse2Data) {
                const nurse2Input = document.getElementById('nurseInCharge2Input');
                if (nurse2Input) nurse2Input.value = nurse2Data;
            }
        }

        function clearAllCookies() {
            deleteCookie('tempStaff');
            deleteCookie('tempPatients');
            deleteCookie('tempSecurity');
            deleteCookie('tempNurse1');
            deleteCookie('tempNurse2');
        }

        // AJAX-based save function to replace localStorage
        async function saveToServer() {
            try {
                // Get all current input values
                const staffInputs = Array.from(document.querySelectorAll('.staff-name')).map(input => input.value.trim());
                const patientInputs = Array.from(document.querySelectorAll('.patient-container')).map(container => {
                    return {
                        name: container.querySelector('.patient-name').value.trim(),
                        staffCount: parseInt(container.querySelector('.staff-count').value)
                    };
                });

                const securityStaffValues = Array.from(document.querySelectorAll('.security-name')).map(input => input.value.trim());
                const nurseInCharge1 = document.getElementById('nurseInChargeInput')?.value.trim() || '';
                const nurseInCharge2 = document.getElementById('nurseInCharge2Input')?.value.trim() || '';

                // Save settings to server
                const settings = {
                    staff: staffInputs,
                    nurseInCharge1,
                    nurseInCharge2,
                    patients: patientInputs,
                    securityStaff: securityStaffValues,
                    isDayShift, // Day/night shift toggle
                    isDarkMode: document.body.classList.contains('dark-mode') // Dark/light mode toggle
                };

                await api.saveSettings(settings);
                console.log("Settings saved to server successfully");
                return true;
            } catch (error) {
                console.error("Error saving to server:", error);
                showError(`Failed to save your changes: ${error.message}`);
                return false;
            }
        }

        // AJAX-based load function to replace localStorage
        async function loadFromServer() {
            try {
                const data = await api.loadData();

                if (!data || !data.settings) {
                    console.warn("No data found on server.");
                    // Add default data
                    addStaffInput();
                    addPatientInput();
                    return false;
                }

                const settings = data.settings;

                // Load shift type
                isDayShift = settings.isDayShift !== undefined ? settings.isDayShift : true;
                timeSlots = isDayShift ? [...dayShiftSlots] : [...nightShiftSlots];

                // Update UI for shift type
                document.getElementById('siteTitle').textContent = isDayShift ? "Day Shift Allocation" : "Night Shift Allocation";
                document.getElementById('toggleShiftBtn').textContent = isDayShift ? "Switch to Night Shift" : "Switch to Day Shift";

                // Load dark mode setting
                if (settings.isDarkMode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('toggleModeBtn').textContent = '‚òÄÔ∏è';
                } else {
                    document.body.classList.remove('dark-mode');
                    document.getElementById('toggleModeBtn').textContent = 'üåô';
                }

                // Load nurse in charge values
                if (document.getElementById('nurseInChargeInput')) {
                    document.getElementById('nurseInChargeInput').value = settings.nurseInCharge1 || '';
                }
                if (document.getElementById('nurseInCharge2Input')) {
                    document.getElementById('nurseInCharge2Input').value = settings.nurseInCharge2 || '';
                }

                // Load staff, patients, and security staff
                loadStaffFromData(settings.staff || []);
                loadPatientsFromData(settings.patients || []);
                loadSecurityStaffFromData(settings.securityStaff || []);

                // Initialize empty schedule when loading (instead of loading saved schedule)
                schedule = {};

                // Set up legend based on shift type
                updateLegend();

                console.log("Data loaded successfully from server");
                return true;
            } catch (error) {
                console.error("Error loading from server:", error);
                showError(`Failed to load your saved data: ${error.message}`);
                return false;
            }
        }

        // Save current schedule to server
        async function saveScheduleToServer() {
            try {
                if (Object.keys(schedule).length === 0) {
                    console.log("No schedule to save");
                    return true;
                }

                await api.saveSchedule(currentScheduleId, schedule);
                console.log("Schedule saved to server successfully");
                return true;
            } catch (error) {
                console.error("Error saving schedule to server:", error);
                showError(`Failed to save schedule: ${error.message}`);
                return false;
            }
        }

        // Load schedule from server
        async function loadScheduleFromServer(scheduleId = null) {
            try {
                const id = scheduleId || currentScheduleId;
                const scheduleData = await api.loadSchedule(id);

                if (scheduleData && scheduleData.schedule) {
                    schedule = scheduleData.schedule;
                    regenerateScheduleStats();
                    console.log("Schedule loaded from server successfully");
                    return true;
                }
                return false;
            } catch (error) {
                console.error("Error loading schedule from server:", error);
                // Don't show error for schedule not found, as it's normal for new schedules
                if (!error.message.includes('not found')) {
                    showError(`Failed to load schedule: ${error.message}`);
                }
                return false;
            }
        }

        // Simplified loadFromLocalStorage function to match
function loadFromLocalStorage() {
    try {
        const savedData = localStorage.getItem('patientCareData');
        if (!savedData) {
            console.warn("No data found in localStorage.");
            // Add default data
            addStaffInput();
            addPatientInput();
            return false;
        }

        const parsedData = JSON.parse(savedData);

        // Load shift type
        isDayShift = parsedData.isDayShift !== undefined ? parsedData.isDayShift : true;
        timeSlots = isDayShift ? [...dayShiftSlots] : [...nightShiftSlots];

        // Update UI for shift type
        document.getElementById('siteTitle').textContent = isDayShift ? "Day Shift Allocation" : "Night Shift Allocation";
        document.getElementById('toggleShiftBtn').textContent = isDayShift ? "Switch to Night Shift" : "Switch to Day Shift";

        // Load dark mode setting
        if (parsedData.isDarkMode) {
            document.body.classList.add('dark-mode');
            document.getElementById('toggleModeBtn').textContent = '‚òÄÔ∏è';
        } else {
            document.body.classList.remove('dark-mode');
            document.getElementById('toggleModeBtn').textContent = 'üåô';
        }

        // Load nurse in charge values
        if (document.getElementById('nurseInChargeInput')) {
            document.getElementById('nurseInChargeInput').value = parsedData.nurseInCharge1 || '';
        }
        if (document.getElementById('nurseInCharge2Input')) {
            document.getElementById('nurseInCharge2Input').value = parsedData.nurseInCharge2 || '';
        }

        // Load staff, patients, and security staff
        loadStaffFromData(parsedData.staff || []);
        loadPatientsFromData(parsedData.patients || []);
        loadSecurityStaffFromData(parsedData.securityStaff || []);

        // Initialize empty schedule when loading (instead of loading saved schedule)
        schedule = {};

        // Set up legend based on shift type
        updateLegend();

        console.log("Data loaded successfully from localStorage");
        return true;
    } catch (error) {
        console.error("Error loading from localStorage:", error);
        showError("Failed to load your saved data. Using default settings instead.");
        return false;
    }
}

// Helper functions for loadFromLocalStorage
function loadStaffFromData(staffData) {
    const staffInputs = document.getElementById('staffInputs');
    if (!staffInputs) return;

    staffInputs.innerHTML = '';

    staffData.forEach(name => {
        const staffContainer = document.createElement('div');
        staffContainer.className = 'staff-container';

        const newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.value = name;
        newInput.className = 'staff-name';
        newInput.addEventListener('input', debounce(saveToLocalStorage, 300));

        staffContainer.appendChild(newInput);
        staffInputs.appendChild(staffContainer);
    });

    // Add at least one staff input if none were loaded
    if (staffData.length === 0) {
        addStaffInput();
    }
}

function loadPatientsFromData(patientsData) {
    const patientInputs = document.getElementById('patientInputs');
    if (!patientInputs) return;

    patientInputs.innerHTML = '';

    patientsData.forEach(({ name, staffCount }) => {
        const patientContainer = document.createElement('div');
        patientContainer.className = 'patient-container';

        const inputWrapper = document.createElement('div');
        inputWrapper.style.display = 'flex';
        inputWrapper.style.alignItems = 'center';
        inputWrapper.style.gap = '10px';

        const newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.value = name;
        newInput.className = 'patient-name';
        newInput.addEventListener('input', debounce(saveToLocalStorage, 300));

        const staffCountSelect = document.createElement('select');
        staffCountSelect.className = 'staff-count';
        staffCountSelect.addEventListener('change', debounce(saveToLocalStorage, 300));

        const option1 = document.createElement('option');
        option1.value = 1;
        option1.textContent = '1:1';
        const option2 = document.createElement('option');
        option2.value = 2;
        option2.textContent = '2:1';
        const option3 = document.createElement('option');
        option3.value = 3;
        option3.textContent = '3:1';

        staffCountSelect.appendChild(option1);
        staffCountSelect.appendChild(option2);
        staffCountSelect.appendChild(option3);
        staffCountSelect.value = staffCount || 1;

        inputWrapper.appendChild(newInput);
        inputWrapper.appendChild(staffCountSelect);
        patientContainer.appendChild(inputWrapper);
        patientInputs.appendChild(patientContainer);
    });

    // Add at least one patient input if none were loaded
    if (patientsData.length === 0) {
        addPatientInput();
    }
}

function loadSecurityStaffFromData(securityStaffData) {
    const securityStaffInputs = document.getElementById('securityStaffInputs');
    if (!securityStaffInputs) return;

    securityStaffInputs.innerHTML = '';

    // Reset the global array
    securityStaff = [];

    securityStaffData.forEach(name => {
        if (!securityStaff.includes(name)) {
            securityStaff.push(name);
        }

        const securityContainer = document.createElement('div');
        securityContainer.className = 'security-container';

        const newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.value = name;
        newInput.className = 'security-name';
        newInput.addEventListener('input', debounce(saveToLocalStorage, 300));

        securityContainer.appendChild(newInput);
        securityStaffInputs.appendChild(securityContainer);
    });
}

// DELETE THIS ENTIRE SECOND regenerateScheduleStats FUNCTION (around line 2125)
// Keep only the first, more comprehensive implementation that starts around line 2025

// FIX: At the end of your window.onload function (around line 2689), add proper closing bracket
// FIX: The updateStaffPatientHistory function should be inside the window.onload function or moved outside
function updateStaffPatientHistory(staffName, patientName) {
    if (!window.staffPatientHistory) window.staffPatientHistory = {};
    if (!window.staffPatientHistory[staffName]) window.staffPatientHistory[staffName] = {};
    if (!window.staffPatientHistory[staffName][patientName]) window.staffPatientHistory[staffName][patientName] = 0;

    window.staffPatientHistory[staffName][patientName]++;
}

// FIX: The getAllStaffNames and getAllPatientNames functions should also be moved to the right scope
function getAllStaffNames() {
    const allStaff = [];
    $('.staff-name').each(function() {
        const name = $(this).val().trim();
        if (name) allStaff.push(name);
    });
    if ($('#nurseInChargeInput').val().trim()) allStaff.push($('#nurseInChargeInput').val().trim());
    if ($('#nurseInCharge2Input').val().trim()) allStaff.push($('#nurseInCharge2Input').val().trim());
    $('.security-name').each(function() {
        const name = $(this).val().trim();
        if (name) allStaff.push(name);
    });
    return allStaff;
}

function getAllPatientNames() {
    const patients = [];
    $('.patient-name').each(function() {
        const name = $(this).val().trim();
        if (name) patients.push(name);
    });
    return patients;
}

// Add this comprehensive function to your code:
function regenerateScheduleStats() {
    const allStaff = getAllStaffNames();
    const patients = getAllPatientNames();

    // Initialize staffStats object
    const staffStats = {};
    allStaff.forEach(s => {
        staffStats[s] = {
            workHours: 0,
            breakTime: 0,
            shortBreakTime: "",
            secondBreakTime: ""
        };
    });

    // Calculate work hours for each staff member
    timeSlots.forEach(time => {
        allStaff.forEach(s => {
            // Count break times
            if (schedule[time]?.staffBreaks?.[s]) {
                const breakType = schedule[time].staffBreaks[s];
                if (breakType === "30-MIN BREAK") {
                    staffStats[s].breakTime += 0.5;
                    staffStats[s].shortBreakTime = time;
                } else if (breakType === "2ND BREAK") {
                    staffStats[s].breakTime += 1;
                    staffStats[s].secondBreakTime = time;
                } else if (breakType === "NIGHT BREAK") {
                    staffStats[s].breakTime += 1;
                    // For night shift we track both break times
                    if (!staffStats[s].shortBreakTime) {
                        staffStats[s].shortBreakTime = time;
                    } else {
                        staffStats[s].secondBreakTime = time;
                    }
                }
                return; // Skip work calculation if on break
            }

            // Check if staff is assigned to a patient
            let isWorking = false;
            if (schedule[time]?.patientAssignments) {
                for (const patient in schedule[time].patientAssignments) {
                    if (schedule[time].patientAssignments[patient]?.includes(s)) {
                        isWorking = true;
                        break;
                    }
                }
            }

            // Update work hours if working
            if (isWorking) {
                staffStats[s].workHours += 1;
            }
        });
    });

    // Render all components of the schedule
    renderSchedule(schedule, allStaff, patients);
    renderStaffTable(schedule, allStaff);
    renderBreakHoursTable(staffStats, allStaff);
    renderStats(staffStats, allStaff, patients);
    renderStaffRotationStats(patients, allStaff);

    // Save to server
    saveInputsToCookies();
    saveScheduleToServer();
}

function calculateStaffStats(staffStats, allStaff) {
    timeSlots.forEach((time) => {
        allStaff.forEach(s => {
            // Calculate break times
            if (schedule[time] && schedule[time].staffBreaks && schedule[time].staffBreaks[s]) {
                if (schedule[time].staffBreaks[s] === "30-MIN BREAK") {
                    staffStats[s].breakTime += 0.5;
                    staffStats[s].shortBreakTime = time;
                } else if (schedule[time].staffBreaks[s] === "2ND BREAK") {
                    staffStats[s].breakTime += 1;
                    staffStats[s].secondBreakTime = time;
                } else if (schedule[time].staffBreaks[s] === "NIGHT BREAK") {
                    staffStats[s].breakTime += 1;
                }
            }

            // Calculate work hours
            if (schedule[time] && schedule[time].patientAssignments) {
                for (const patient in schedule[time].patientAssignments) {
                    if (schedule[time].patientAssignments[patient].includes(s)) {
                        staffStats[s].workHours++;
                        break; // Only count once per time slot
                    }
                }
            }
        });
    });
}

// Staff rotation stats
function renderStaffRotationStats(patients, regularStaff) {
    const rotationStatsDiv = document.getElementById('rotationStats');
    rotationStatsDiv.innerHTML = '';

    if (!Array.isArray(patients) || patients.length === 0) {
        rotationStatsDiv.textContent = "No patient data available for rotation stats.";
        return;
    }

    if (!Array.isArray(regularStaff) || regularStaff.length === 0) {
        rotationStatsDiv.textContent = "No staff data available for rotation stats.";
        return;
    }

    // Calculate rotation stats
    const patientRotations = {};
    patients.forEach(patient => {
        patientRotations[patient] = {
            totalAssignments: 0,
            staffMembers: new Set()
        };
    });

    regularStaff.forEach(staff => {
        const assignments = getStaffAssignments(staff);
        assignments.forEach(({ patient }) => {
            if (patientRotations[patient]) {
                patientRotations[patient].totalAssignments++;
                patientRotations[patient].staffMembers.add(staff);
            }
        });
    });

    // Render rotation stats
    Object.keys(patientRotations).forEach(patient => {
        const { totalAssignments, staffMembers } = patientRotations[patient];

        const patientDiv = document.createElement('div');
        patientDiv.className = 'patient-rotation-stat';

        const patientNameElem = document.createElement('strong');
        patientNameElem.textContent = patient;
        patientDiv.appendChild(patientNameElem);

        const totalAssignmentsElem = document.createElement('div');
        totalAssignmentsElem.textContent = `Total Assignments: ${totalAssignments}`;
        patientDiv.appendChild(totalAssignmentsElem);

        const staffMembersElem = document.createElement('div');
        staffMembersElem.textContent = `Staff Members: ${Array.from(staffMembers).join(', ')}`;
        patientDiv.appendChild(staffMembersElem);

        rotationStatsDiv.appendChild(patientDiv);
    });
}

// Security rotation stats (if needed)
function renderSecurityRotationStats() {
    // Similar to staff rotation stats, but specific to security staff
}

// Function to get staff assignments for a given staff member
function getStaffAssignments(staff) {
    const assignments = [];

    timeSlots.forEach(time => {
        if (schedule[time] && schedule[time].patientAssignments) {
            Object.keys(schedule[time].patientAssignments).forEach(patient => {
                const assignedStaff = schedule[time].patientAssignments[patient];
                if (assignedStaff.includes(staff)) {
                    assignments.push({ time, patient });
                }
            });
        }
    });

    return assignments;
}

// Staff rotation logic (if needed)
function rotateStaff() {
    // Implement staff rotation logic here
}

// Function to render the patient care schedule table
function renderSchedule(schedule, staff, patients) {
    // Generate colors for staff
    const staffColors = generateStaffColors(staff);

    // Setup patient schedule header
    const scheduleHeader = document.getElementById('scheduleHeader');
    let headerHTML = '<tr><th>Patient</th>';
    timeSlots.forEach(time => {
        headerHTML += `<th>${time}</th>`;
    });
    headerHTML += '</tr>';
    scheduleHeader.innerHTML = headerHTML;

    // Setup patient schedule body (patient rows)
    const scheduleBody = document.getElementById('scheduleBody');
    scheduleBody.innerHTML = '';

    patients.forEach(patient => {
        const row = document.createElement('tr');

        // Add patient name cell
        const patientCell = document.createElement('td');
        patientCell.textContent = patient;
        patientCell.className = 'row-header';
        row.appendChild(patientCell);

        // Add cells for each time slot
        timeSlots.forEach(time => {
            const cell = document.createElement('td');
            cell.className = 'assignable-staff-cell'; // Make cells clickable
            cell.setAttribute('data-time', time);     // Add time attribute
            cell.setAttribute('data-patient', patient); // Add patient attribute
            cell.style.cursor = 'pointer';

            const assignedStaff = schedule[time]?.patientAssignments?.[patient] || [];

            if (assignedStaff.length === 0) {
                cell.textContent = "UNASSIGNED";
                cell.style.backgroundColor = "#ffeaa7"; // Yellow for unassigned
                cell.style.color = "#000000"; // Black text for contrast
                cell.classList.add('staff-unassigned');
            } else {
                // Use initials for display
                cell.textContent = getInitials(assignedStaff[0]);
                cell.title = assignedStaff.join(", "); // Full names on hover

                // Add styling based on staff color
                if (assignedStaff.length > 0 && staffColors[assignedStaff[0]]) {
                    const { bgColor, textColor } = staffColors[assignedStaff[0]];
                    cell.style.backgroundColor = bgColor;
                    cell.style.color = textColor;
                } else {
                    // Fallback colors
                    cell.style.backgroundColor = "#f8f9fa";
                    cell.style.color = "#000000";
                }
            }

            row.appendChild(cell);
        });

        scheduleBody.appendChild(row);
    });
}

// Function to render staff schedule table
function renderStaffTable(schedule, staff) {
    // Setup staff schedule header
    const staffHeader = document.getElementById('staffHeader');
    let headerHTML = '<tr><th>Staff</th>';
    timeSlots.forEach(time => {
        headerHTML += `<th>${time}</th>`;
    });
    headerHTML += '</tr>';
    staffHeader.innerHTML = headerHTML;

    // Generate colors for staff
    const staffColors = generateStaffColors(staff);

    // Setup staff schedule body
    const staffBody = document.getElementById('staffBody');
    staffBody.innerHTML = '';

    staff.forEach(s => {
        const row = document.createElement('tr');

        // Add staff name cell
        const staffCell = document.createElement('td');
        staffCell.textContent = s;
        staffCell.className = 'row-header';

        // Style based on staff type
        if (securityStaff.includes(s)) {
            staffCell.style.backgroundColor = "#ff9800";
            staffCell.style.color = "#000000";
            staffCell.style.fontWeight = "bold";
            staffCell.textContent = s + " (Security)";
        } else if (staffColors[s]) {
            const { bgColor, textColor } = staffColors[s];
            staffCell.style.backgroundColor = bgColor;
            staffCell.style.color = textColor;
        }

        row.appendChild(staffCell);

        // Add cells for each time slot
        timeSlots.forEach((time, timeIndex) => {
            const cell = document.createElement('td');

            // Check for breaks first
            if (schedule[time]?.staffBreaks?.[s]) {
                const breakType = schedule[time].staffBreaks[s];

                if (breakType === "30-MIN BREAK") {
                    cell.textContent = "BREAK";
                    cell.className = 'staff-break';
                } else if (breakType === "2ND BREAK") {
                    cell.textContent = "2ND BREAK";
                    cell.className = 'staff-lunch';
                } else if (breakType === "NIGHT BREAK") {
                    cell.textContent = "BREAK";
                    cell.style.backgroundColor = "#673ab7";
                    cell.style.color = "#ffffff";
                } else if (breakType === "SECURITY DUTY") {
                    cell.textContent = "SECURITY";
                    cell.style.backgroundColor = "#ffccbc";
                    cell.style.color = "#000000";
                    cell.style.fontWeight = "bold";
                }
            }
            // Check if assigned to a patient
            else {
                let assigned = false;

                if (schedule[time]?.patientAssignments) {
                    for (const patient in schedule[time].patientAssignments) {
                        if (schedule[time].patientAssignments[patient]?.includes(s)) {
                            cell.textContent = patient;

                            if (staffColors[s]) {
                                cell.style.backgroundColor = staffColors[s].bgColor;
                                cell.style.color = staffColors[s].textColor;
                            }

                            assigned = true;
                            break;
                        }
                    }
                }

                if (!assigned) {
                    cell.textContent = "FREE";
                    cell.style.backgroundColor = "#e0f7fa";
                    cell.style.color = "#000000";
                }
            }

            row.appendChild(cell);
        });

        staffBody.appendChild(row);
    });
}

// Function to render break hours table
function renderBreakHoursTable(staffStats, staff) {
    const breakHoursTableBody = document.querySelector('#breakHoursTable tbody');
    if (!breakHoursTableBody) return;

    breakHoursTableBody.innerHTML = '';

    staff.forEach(s => {
        const row = document.createElement('tr');

        // Staff name
        const staffCell = document.createElement('td');
        staffCell.textContent = s;
        row.appendChild(staffCell);

        // First break time (30-min break for day shift, first hour of night break for night shift)
        const shortBreakCell = document.createElement('td');
        shortBreakCell.textContent = staffStats[s]?.shortBreakTime || 'N/A';
        row.appendChild(shortBreakCell);

        // Second break time (2nd break for day shift, second hour of night break for night shift)
        const secondBreakCell = document.createElement('td');
        secondBreakCell.textContent = staffStats[s]?.secondBreakTime || 'N/A';
        row.appendChild(secondBreakCell);

        breakHoursTableBody.appendChild(row);
    });
}

// Function to generate staff colors for visual distinction
function generateStaffColors(staff) {
    const colors = [
        { bgColor: '#ffb3ba', textColor: '#000000' }, // Light pink
        { bgColor: '#bae1ff', textColor: '#000000' }, // Light blue
        { bgColor: '#baffc9', textColor: '#000000' }, // Light green
        { bgColor: '#ffffba', textColor: '#000000' }, // Light yellow
        { bgColor: '#ffdfba', textColor: '#000000' }, // Light orange
        { bgColor: '#e0bbff', textColor: '#000000' }, // Light purple
        { bgColor: '#ffb3d9', textColor: '#000000' }, // Light magenta
        { bgColor: '#c9ffba', textColor: '#000000' }, // Light lime
        { bgColor: '#ffcccb', textColor: '#000000' }, // Light red
        { bgColor: '#add8e6', textColor: '#000000' }  // Light blue-2
    ];

    const staffColors = {};
    staff.forEach((s, index) => {
        staffColors[s] = colors[index % colors.length];
    });

    return staffColors;
}

// Function to render statistics
function renderStats(staffStats, staff, patients) {
    const statsDiv = document.getElementById('stats');
    if (!statsDiv) return;

    let statsHTML = '<h2>Staff Statistics</h2>';
    
    // Overall statistics
    const totalStaff = staff.length;
    const totalPatients = patients.length;
    const totalSlots = timeSlots.length;
    
    statsHTML += `<div style="margin-bottom: 20px;">
        <p><strong>Total Staff:</strong> ${totalStaff}</p>
        <p><strong>Total Patients:</strong> ${totalPatients}</p>
        <p><strong>Total Time Slots:</strong> ${totalSlots}</p>
    </div>`;

    // Individual staff statistics
    if (staff.length > 0) {
        statsHTML += '<h3>Individual Staff Hours</h3>';
        statsHTML += '<table style="width: 100%; border-collapse: collapse;">';
        statsHTML += '<tr><th style="border: 1px solid #ddd; padding: 8px;">Staff</th><th style="border: 1px solid #ddd; padding: 8px;">Work Hours</th><th style="border: 1px solid #ddd; padding: 8px;">Break Hours</th></tr>';
        
        staff.forEach(s => {
            const workHours = staffStats[s]?.workHours || 0;
            const breakHours = staffStats[s]?.breakTime || 0;
            statsHTML += `<tr>
                <td style="border: 1px solid #ddd; padding: 8px;">${s}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${workHours}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${breakHours}</td>
            </tr>`;
        });
        
        statsHTML += '</table>';
    }

    statsDiv.innerHTML = statsHTML;
}

// Main schedule generation function
function generateSchedule() {
    try {
        // Get staff and patient data
        const staff = Array.from(document.querySelectorAll('.staff-name')).map(input => input.value.trim()).filter(name => name);
        const patients = Array.from(document.querySelectorAll('.patient-container')).map(container => {
            return {
                name: container.querySelector('.patient-name').value.trim(),
                staffCount: parseInt(container.querySelector('.staff-count').value)
            };
        }).filter(patient => patient.name);

        // Validate inputs
        if (staff.length === 0) {
            showError("Please add at least one staff member");
            return;
        }

        if (patients.length === 0) {
            showError("Please add at least one patient");
            return;
        }

        // Initialize schedule structure
        schedule = {};
        timeSlots.forEach(time => {
            schedule[time] = {
                patientAssignments: {},
                staffBreaks: {}
            };
        });

        // Assign patients to staff for each time slot
        patients.forEach(patient => {
            timeSlots.forEach(time => {
                // Initialize patient assignment array
                schedule[time].patientAssignments[patient.name] = [];
                
                // Assign required number of staff to each patient
                const availableStaff = staff.filter(s => !schedule[time].staffBreaks[s]);
                
                for (let i = 0; i < Math.min(patient.staffCount, availableStaff.length); i++) {
                    const assignedStaff = availableStaff[i % availableStaff.length];
                    if (!schedule[time].patientAssignments[patient.name].includes(assignedStaff)) {
                        schedule[time].patientAssignments[patient.name].push(assignedStaff);
                    }
                }
            });
        });

        // Assign breaks to staff
        assignStaffBreaks(staff);

        // Generate and display the schedule
        regenerateScheduleStats();
        
        showError("Schedule generated successfully!", '#4CAF50');
        
    } catch (error) {
        console.error("Error generating schedule:", error);
        showError("Failed to generate schedule. Please try again.");
    }
}

// Function to assign breaks to staff
function assignStaffBreaks(staff) {
    staff.forEach((s, index) => {
        if (isDayShift) {
            // Day shift: 30-min break + 1-hour 2nd break
            const breakSlot = timeSlots[2 + (index % 4)]; // Spread breaks across different times
            const lunchSlot = timeSlots[5 + (index % 3)]; // Spread lunch breaks
            
            if (schedule[breakSlot]) {
                schedule[breakSlot].staffBreaks[s] = "30-MIN BREAK";
            }
            if (schedule[lunchSlot]) {
                schedule[lunchSlot].staffBreaks[s] = "2ND BREAK";
            }
        } else {
            // Night shift: 2-hour break (split into 2 consecutive hours)
            const breakStart = 3 + (index % 6); // Start break between 23:00-05:00
            const breakSlot1 = timeSlots[breakStart];
            const breakSlot2 = timeSlots[breakStart + 1];
            
            if (schedule[breakSlot1]) {
                schedule[breakSlot1].staffBreaks[s] = "NIGHT BREAK";
            }
            if (schedule[breakSlot2]) {
                schedule[breakSlot2].staffBreaks[s] = "NIGHT BREAK";
            }
        }
    });
}

// Popup functionality for staff assignment
function showStaffPopup(patient, timeSlot) {
    const popup = document.getElementById('staffPopup');
    const overlay = document.getElementById('popupOverlay');
    const patientNameSpan = document.getElementById('popupPatientName');
    const timeSlotSpan = document.getElementById('popupTimeSlot');
    const staffList = document.getElementById('staffList');

    if (!popup || !overlay || !patientNameSpan || !timeSlotSpan || !staffList) {
        console.error("Popup elements not found");
        return;
    }

    // Set popup title
    patientNameSpan.textContent = patient;
    timeSlotSpan.textContent = timeSlot;

    // Get all available staff
    const allStaff = Array.from(document.querySelectorAll('.staff-name')).map(input => input.value.trim()).filter(name => name);
    const currentlyAssigned = schedule[timeSlot]?.patientAssignments?.[patient] || [];

    // Clear previous content
    staffList.innerHTML = '';

    // Add staff options
    allStaff.forEach(staffName => {
        const isAssigned = currentlyAssigned.includes(staffName);
        const isOnBreak = schedule[timeSlot]?.staffBreaks?.[staffName];
        
        const staffDiv = document.createElement('div');
        staffDiv.style.display = 'flex';
        staffDiv.style.alignItems = 'center';
        staffDiv.style.marginBottom = '10px';
        staffDiv.style.padding = '8px';
        staffDiv.style.border = '1px solid #ddd';
        staffDiv.style.borderRadius = '4px';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `staff-${staffName}`;
        checkbox.checked = isAssigned;
        checkbox.disabled = isOnBreak;
        checkbox.style.marginRight = '10px';

        const label = document.createElement('label');
        label.htmlFor = `staff-${staffName}`;
        label.textContent = staffName;
        label.style.flex = '1';
        
        if (isOnBreak) {
            label.textContent += ` (On ${isOnBreak})`;
            label.style.color = '#666';
            staffDiv.style.backgroundColor = '#f5f5f5';
        }

        checkbox.addEventListener('change', function() {
            if (this.checked) {
                addStaffToPatient(patient, timeSlot, staffName);
            } else {
                removeStaffFromPatient(patient, timeSlot, staffName);
            }
        });

        staffDiv.appendChild(checkbox);
        staffDiv.appendChild(label);
        staffList.appendChild(staffDiv);
    });

    // Show popup
    overlay.style.display = 'block';
    popup.style.display = 'block';
}

// Helper functions for staff assignment
function addStaffToPatient(patient, timeSlot, staffName) {
    if (!schedule[timeSlot]) {
        schedule[timeSlot] = { patientAssignments: {}, staffBreaks: {} };
    }
    if (!schedule[timeSlot].patientAssignments[patient]) {
        schedule[timeSlot].patientAssignments[patient] = [];
    }
    
    if (!schedule[timeSlot].patientAssignments[patient].includes(staffName)) {
        schedule[timeSlot].patientAssignments[patient].push(staffName);
        regenerateScheduleStats();
    }
}

function removeStaffFromPatient(patient, timeSlot, staffName) {
    if (schedule[timeSlot]?.patientAssignments?.[patient]) {
        const index = schedule[timeSlot].patientAssignments[patient].indexOf(staffName);
        if (index > -1) {
            schedule[timeSlot].patientAssignments[patient].splice(index, 1);
            regenerateScheduleStats();
        }
    }
}

function removeAllStaffFromPatient(patient, timeSlot) {
    if (schedule[timeSlot]?.patientAssignments?.[patient]) {
        schedule[timeSlot].patientAssignments[patient] = [];
        regenerateScheduleStats();
    }
}

function closeStaffPopup() {
    const popup = document.getElementById('staffPopup');
    const overlay = document.getElementById('popupOverlay');
    
    if (popup) popup.style.display = 'none';
    if (overlay) overlay.style.display = 'none';
}

// Debug panel functionality
document.getElementById('toggleDebugBtn')?.addEventListener('click', function() {
    const debugPanel = document.getElementById('debugPanel');
    if (debugPanel.style.display === 'none') {
        debugPanel.style.display = 'block';
    } else {
        debugPanel.style.display = 'none';
    }
});

document.getElementById('clearDebugBtn')?.addEventListener('click', function() {
    document.getElementById('debugOutput').innerHTML = '';
});

// Override console.log to show in debug panel
const originalLog = console.log;
console.log = function(...args) {
    originalLog.apply(console, args);
    const debugOutput = document.getElementById('debugOutput');
    if (debugOutput) {
        const logEntry = document.createElement('div');
        logEntry.textContent = args.join(' ');
        logEntry.style.borderBottom = '1px solid #333';
        logEntry.style.padding = '2px 0';
        debugOutput.appendChild(logEntry);
        debugOutput.scrollTop = debugOutput.scrollHeight;
    }
};

// Initialize the application when page loads
window.addEventListener('DOMContentLoaded', function() {
    // Load data from localStorage
    loadFromLocalStorage();

    // Set up event listeners for buttons
    document.getElementById('addStaffBtn')?.addEventListener('click', addStaffInput);
    document.getElementById('removeStaffBtn')?.addEventListener('click', () => {
        const staffContainers = document.querySelectorAll('.staff-container');
        if (staffContainers.length > 1) {
            staffContainers[staffContainers.length - 1].remove();
            saveToLocalStorage();
        }
    });

    document.getElementById('addPatientBtn')?.addEventListener('click', addPatientInput);
    document.getElementById('removePatientBtn')?.addEventListener('click', () => {
        const patientContainers = document.querySelectorAll('.patient-container');
        if (patientContainers.length > 1) {
            patientContainers[patientContainers.length - 1].remove();
            saveToLocalStorage();
        }
    });

    document.getElementById('addSecurityStaffBtn')?.addEventListener('click', addSecurityStaffInput);
    document.getElementById('removeSecurityStaffBtn')?.addEventListener('click', () => {
        const securityContainers = document.querySelectorAll('.security-container');
        if (securityContainers.length > 0) {
            securityContainers[securityContainers.length - 1].remove();
            saveToLocalStorage();
        }
    });

    document.getElementById('toggleShiftBtn')?.addEventListener('click', () => {
        isDayShift = !isDayShift;
        timeSlots = isDayShift ? [...dayShiftSlots] : [...nightShiftSlots];

        document.getElementById('siteTitle').textContent = isDayShift ? "Day Shift Allocation" : "Night Shift Allocation";
        document.getElementById('toggleShiftBtn').textContent = isDayShift ? "Switch to Night Shift" : "Switch to Day Shift";

        updateLegend();
        saveToLocalStorage();
    });

    document.getElementById('toggleModeBtn')?.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById('toggleModeBtn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        saveToLocalStorage();
    });

    document.getElementById('resetBtn')?.addEventListener('click', () => {
        if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
            localStorage.removeItem('patientCareData');
            location.reload();
        }
    });

    // Generate Schedule button
    document.getElementById('generateBtn')?.addEventListener('click', generateSchedule);

    // Debug Fill button (for testing)
    document.getElementById('debugFillBtn')?.addEventListener('click', function() {
        // Fill with sample data for testing
        const sampleStaff = ['Alice Johnson', 'Bob Smith', 'Carol Davis', 'David Wilson'];
        const samplePatients = [
            { name: 'Patient A', staffCount: 1 },
            { name: 'Patient B', staffCount: 2 },
            { name: 'Patient C', staffCount: 1 }
        ];

        // Clear existing inputs
        document.getElementById('staffInputs').innerHTML = '';
        document.getElementById('patientInputs').innerHTML = '';

        // Add sample staff
        sampleStaff.forEach(name => {
            addStaffInput();
            const inputs = document.querySelectorAll('.staff-name');
            inputs[inputs.length - 1].value = name;
        });

        // Add sample patients
        samplePatients.forEach(patient => {
            addPatientInput();
            const containers = document.querySelectorAll('.patient-container');
            const lastContainer = containers[containers.length - 1];
            lastContainer.querySelector('.patient-name').value = patient.name;
            lastContainer.querySelector('.staff-count').value = patient.staffCount;
        });

        saveToLocalStorage();
        showError('Sample data loaded successfully!', '#4CAF50');
    });

    // Popup event listeners
    document.getElementById('closePopupBtn')?.addEventListener('click', closeStaffPopup);
    document.getElementById('popupOverlay')?.addEventListener('click', closeStaffPopup);
    
    document.getElementById('removeAllStaffBtn')?.addEventListener('click', function() {
        const patientName = document.getElementById('popupPatientName').textContent;
        const timeSlot = document.getElementById('popupTimeSlot').textContent;
        removeAllStaffFromPatient(patientName, timeSlot);
        closeStaffPopup();
    });

    // Add click listeners to schedule cells (for popup functionality)
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('assignable-staff-cell')) {
            const patient = event.target.getAttribute('data-patient');
            const timeSlot = event.target.getAttribute('data-time');
            
            if (patient && timeSlot) {
                showStaffPopup(patient, timeSlot);
            }
        }
    });

    // Initialize dark mode button text
    const isDark = document.body.classList.contains('dark-mode');
    document.getElementById('toggleModeBtn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
});

    </script>
</body>
</html>