<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Care Schedule - Horizontal Layout</title>
    <style>
        /* Core styling for light and dark modes */
        :root {
            --background-color: #f9f9f9; /* Light background */
            --text-color: #333333; /* Dark text color */
            --container-bg-color: #ffffff; /* White container background */
            --button-bg-color: #0077ff; /* Bright blue button color */
            --button-hover-bg-color: #0056cc; /* Darker blue for hover */
            --table-header-bg-color: #f3f4f6; /* Light gray for table headers */
            --table-header-text-color: #333333; /* Dark text for table headers */
            --table-cell-bg-color: #ffffff; /* White table cell background */
            --table-cell-text-color: #333333; /* Dark text color for table cells */
            --break-bg-color: #ffefc1; /* Soft yellow for breaks */
            --lunch-bg-color: #c1f0c1; /* Soft green for lunch */
            --unassigned-bg-color: #ffc1c1; /* Soft red for unassigned */
            --primary-font: 'Poppins', sans-serif; /* Modern font */
        }

        /* Dark mode overrides */
        body.dark-mode {
            --background-color: #1f2937; /* Dark background */
            --text-color: #f9fafb; /* Light text color */
            --container-bg-color: #374151; /* Dark gray container background */
            --button-bg-color: #2563eb; /* Blue button color */
            --button-hover-bg-color: #1d4ed8; /* Darker blue for hover */
            --table-header-bg-color: #4b5563; /* Darker gray for table headers */
            --table-header-text-color: #f9fafb; /* Light text for table headers */
            --table-cell-bg-color: #4b5563; /* Dark gray table cell background */
            --table-cell-text-color: #f9fafb; /* Light text color for table cells */
            --break-bg-color: #fbbf24; /* Yellow for breaks */
            --lunch-bg-color: #22c55e; /* Green for lunch */
            --unassigned-bg-color: #ef4444; /* Red for unassigned */
        }

        /* General body styling */
        body {
            font-family: var(--primary-font);
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.8;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        h1, h2 {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 20px;
        }
        h1 {
            font-size: 2.5rem;
            text-align: center;
            margin-top: 20px;
        }
        h2 {
            font-size: 1.8rem;
        }
        .container {
            width: 100%; /* Ensure it takes full width */
            max-width: 1200px; /* Limit the maximum width */
            min-width: 800px; /* Ensure a minimum width for smaller content */
            margin: 0 auto;
            padding: 30px;
            background-color: var(--container-bg-color);
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            overflow-x: auto; /* Allow horizontal scrolling for overflowing content */
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
        }
        .setup-section {
            background-color: var(--container-bg-color); /* Use dark mode container background */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e4e8;
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease; /* Smooth transition */
        }
        .setup-section h2 {
            margin-bottom: 10px;
        }
        .staff-inputs, .patient-inputs, .security-staff-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
           
        }
        input, select {
            padding: 8px;
            border: 1px solid #dfe4ea;
            border-radius: 5px;
            width: 150px; /* Shortened width */
            font-size: 14px;
            background-color: #ffffff;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        input:focus, select:focus, button:focus {
            outline: 3px solid #4a69bd;
            box-shadow: 0 0 5px rgba(74, 105, 189, 0.5);
        }
        button {
            background-color: var(--button-bg-color);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: var(--button-hover-bg-color);
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--table-cell-bg-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 15px;
            text-align: center;
            font-size: 14px;
            background-color: var(--table-cell-bg-color);
            color: var(--table-cell-text-color);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        th {
            background-color: var(--table-header-bg-color);
            color: var(--table-header-text-color);
            font-weight: 600;
        }
        tr:nth-child(even) td {
            background-color: #f9fafb;
            color: var(--table-cell-text-color); /* Explicitly set text color */
        }
        tr:nth-child(odd) td {
            background-color: var(--table-cell-bg-color);
            color: var(--table-cell-text-color); /* Explicitly set text color */
        }
        .row-header {
            background-color: var(--table-header-bg-color);
            color: var(--table-header-text-color);
            font-weight: bold;
            text-align: left;
        }
        .staff-break {
            background-color: var(--break-bg-color);
            color: #000000; /* Ensure black text for contrast with yellow background */
            font-weight: bold;
        }
        .staff-lunch {
            background-color: var(--lunch-bg-color);
            color: #000000; /* Ensure black text for contrast with green background */
            font-weight: bold;
        }
        .schedule-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        .stats {
            margin-top: 20px;
            background-color: var(--container-bg-color); /* Use dark mode container background */
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e4e8;
            color: var(--text-color); /* Ensure text color adapts to dark mode */
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease; /* Smooth transition */
        }
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            justify-content: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 50%;
        }
        .legend-break {
            background-color: var(--break-bg-color);
        }
        .legend-lunch {
            background-color: var(--lunch-bg-color);
        }
        .legend-unassigned {
            background-color: var(--unassigned-bg-color);
        }
        .legend-security {
            background-color: #ffccbc;
        }

        /* Ensure text color is visible for cells with white background in dark mode */
        body.dark-mode td {
            color: var(--text-color); /* Use the light text color defined for dark mode */
        }

        body.dark-mode tr:nth-child(even) td {
            background-color: #374151; /* Dark gray for even rows in dark mode */
            color: var(--table-cell-text-color); /* Ensure text color is visible */
        }

        body.dark-mode tr:nth-child(odd) td {
            background-color: var(--table-cell-bg-color); /* Dark gray for odd rows in dark mode */
            color: var(--table-cell-text-color); /* Ensure text color is visible */
        }

        /* Explicitly set text color for cells with white background */
        body.dark-mode td[style*="background-color: #ffffff"] {
            color: #333333; /* Dark text color for white background */
        }

        .staff-count {
            padding: 5px; /* Reduce padding */
            border: 1px solid #dfe4ea;
            border-radius: 5px;
            width: 80px; /* Adjust width to save space */
            font-size: 12px; /* Reduce font size */
            background-color: #ffffff;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .staff-count:focus {
            outline: none;
            border-color: #4a69bd;
            box-shadow: 0 0 5px rgba(74, 105, 189, 0.5);
        }

        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #f44336;
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 1000;
        }

        /* Explicitly set text color for cells when in dark mode */
        body.dark-mode .staff-break {
            background-color: var(--break-bg-color); /* Your dark mode yellow */
            color: #000000; /* Keep black text which contrasts with yellow */
        }

        body.dark-mode .staff-lunch {
            background-color: var(--lunch-bg-color); /* Your dark mode green */
            color: #000000; /* Keep black text which contrasts with green */
        }

        /* Other cells with custom colors in dark mode may need adjustments */
        body.dark-mode td.row-header {
            color: var(--table-header-text-color);
        }

        .rotation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .rotation-table th, .rotation-table td {
            border: 1px solid #e5e7eb;
            padding: 15px;
            text-align: center;
            font-size: 14px;
        }

        .rotation-table th {
            background-color: var(--table-header-bg-color);
            color: var(--table-header-text-color);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Title dynamically updates based on the current shift -->
        <h1 id="siteTitle">Day Shift Allocation</h1>

        <!-- Buttons for toggling shift and dark mode -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button id="toggleShiftBtn" style="padding: 10px 20px; font-size: 14px;">Switch to Night Shift</button>
            <button id="toggleModeBtn" title="Toggle Dark/Light Mode"></button>
        </div>

        <!-- Replace the Security Staff and Nurse in Charge sections with this flex container -->
        <div class="setup-section" style="margin-bottom: 20px;">
            <div style="display: flex; gap: 40px; align-items: flex-start;">
                <!-- Security Staff Section -->
                <div>
                    <h2>Security Staff</h2>
                    <div class="security-staff-inputs" id="securityStaffInputs"></div>
                    <button id="addSecurityStaffBtn">Add Security Staff</button>
                    <button id="removeSecurityStaffBtn">Remove Security Staff</button>
                </div>
                <!-- Nurse in Charge Section -->
                <div>
                    <h2>Nurse in Charge</h2>
                    <input type="text" id="nurseInChargeInput" placeholder="Enter Nurse in Charge Name" style="width: 250px; margin-bottom: 15px;">
                </div>
            </div>
        </div>

        <!-- Section for managing health care workers and patients -->
        <div class="setup-section">
            <h2>Health Care Worker (HCW)</h2>
            <div class="staff-inputs" id="staffInputs"></div>
            <button id="addStaffBtn">Add Health Care Worker</button>
            <button id="removeStaffBtn">Remove Health Care Worker</button>

            <h2>Patient Names</h2>
            <div class="patient-inputs" id="patientInputs"></div>
            <button id="addPatientBtn">Add Patient</button>
            <button id="removePatientBtn">Remove Patient</button>

            <!-- Buttons for generating and resetting the schedule -->
            <button id="generateBtn">Generate Schedule</button>
            <button id="resetBtn">Reset</button>
            <!-- Debugging Button -->
            <!-- This button is for debugging purposes only. Remove this button and its functionality before final deployment. -->
            <button id="debugFillBtn" style="background-color: #ff5722; color: white; margin-top: 10px;">Debug: Fill Random Names</button>
        </div>

        <!-- Legend for schedule colors -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color legend-break"></div>
                <div>30-min Break</div>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-lunch"></div>
                <div>1-hour 2nd Break</div> <!-- Changed from "1-hour Lunch" -->
            </div>
            <div class="legend-item">
                <div class="legend-color legend-unassigned"></div>
                <div>Unassigned</div>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-security"></div>
                <div>Security Duty</div>
            </div>
        </div>

        <!-- Schedule tables -->
        <div class="schedule-container">
            <h2>Patient Care Schedule</h2>
            <table id="scheduleTable">
                <thead id="scheduleHeader"></thead>
                <tbody id="scheduleBody"></tbody>
            </table>
        </div>

        <div class="schedule-container">
            <h2>Staff Schedule</h2>
            <table id="staffTable">
                <thead id="staffHeader"></thead>
                <tbody id="staffBody"></tbody>
            </table>
        </div>

        <div class="schedule-container">
            <h2>Staff Break Hours</h2>
            <table id="breakHoursTable">
                <thead>
                    <tr>
                        <th>Staff</th>
                        <th>30-min Break</th>
                        <th>1-hour 2nd Break</th> <!-- Updated label -->
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Statistics section -->
        <div class="stats" id="stats"></div>

        <!-- Staff-Patient Rotation section -->
        <div class="stats" id="rotationStats"></div>

        <button id="resetRotationBtn" class="action-button">Reset Rotation History</button>
    </div>

    <script>
        // Global variables
        let schedule = {};
        let isDayShift = true;
        let securityStaff = []; // Add this new global variable
        let staffPatientHistory = {}; // Tracks which staff has worked with which patients

        // Time slots for day and night shifts
        const dayShiftSlots = [
            "08:00-09:00", "09:00-10:00", "10:00-11:00", "11:00-12:00",
            "12:00-13:00", "13:00-14:00", "14:00-15:00", "15:00-16:00",
            "16:00-17:00", "17:00-18:00", "18:00-19:00", "19:00-20:00"
        ];

        const nightShiftSlots = [
            "20:00-21:00", "21:00-22:00", "22:00-23:00", "23:00-00:00",
            "00:00-01:00", "01:00-02:00", "02:00-03:00", "03:00-04:00",
            "04:00-05:00", "05:00-06:00", "06:00-07:00", "07:00-08:00"
        ];
        
        // Current time slots (default to day shift)
        let timeSlots = [...dayShiftSlots];
        
        // Helper functions
        function getInputValues(selector) {
            return Array.from(document.querySelectorAll(selector)).map(input => input.value.trim());
        }
        
        function getElement(id) {
            return document.getElementById(id);
        }
        
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            }
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Function to generate random colors for staff
        function generateStaffColors(staff) {
            const staffColors = {};
            const hueStep = 360 / staff.length;
            
            staff.forEach((s, index) => {
                const hue = index * hueStep;
                // Start with standard saturation and lightness
                let saturation = 70;
                let lightness = 80;
                
                // Calculate background color
                const bgColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                
                // Determine text color with guaranteed contrast ratio
                // Use black for light backgrounds, white for dark ones
                // Web standard for ensuring contrast is to use relative luminance:
                const relativeLuminance = calculateRelativeLuminance(hue, saturation, lightness);
                
                // Text color: white for dark backgrounds (smaller luminance), black for light ones
                // The threshold 0.5 is roughly where we need to switch to maintain 4.5:1 contrast
                const textColor = relativeLuminance > 0.5 ? '#000000' : '#ffffff';
                
                staffColors[s] = { bgColor, textColor };
            });
            
            return staffColors;
        }

        // Calculate relative luminance using HSL approximation
        function calculateRelativeLuminance(h, s, l) {
            // This is a simplified model - full implementation would convert HSL to RGB first
            // then apply the proper luminance formula, but this approximation works for this case
            // Adjust perceived brightness based on hue (yellows appear brighter, blues darker)
            const hueFactor = Math.cos((h - 60) * Math.PI / 180) * 0.1;
            
            // Saturation reduces luminance
            const saturationImpact = (s / 100) * 0.3;
            
            // Calculate adjusted luminance
            const adjustedLuminance = (l / 100) - saturationImpact + hueFactor;
            
            return Math.max(0, Math.min(1, adjustedLuminance));
        }

        // Add this function right after the calculateRelativeLuminance function
        function isSecurityRestrictedHour(timeIndex, totalHours) {
            // First 2 hours or last 2 hours
            return timeIndex < 2 || timeIndex >= totalHours - 2;
        }

        // Add UI elements
        function addStaffInput() {
            const staffInputs = document.getElementById('staffInputs');
            const staffContainer = document.createElement('div');
            staffContainer.className = 'staff-container';
            
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.className = 'staff-name';
            newInput.placeholder = 'Enter HCW name';
            
            staffContainer.appendChild(newInput);
            staffInputs.appendChild(staffContainer);
        }

        function addSecurityStaffInput() {
            const securityStaffInputs = document.getElementById('securityStaffInputs');
            const securityContainer = document.createElement('div');
            securityContainer.className = 'security-container';
            
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.className = 'security-name';
            newInput.placeholder = 'Enter security staff name';
            
            securityContainer.appendChild(newInput);
            securityStaffInputs.appendChild(securityContainer);
        }

        function addPatientInput() {
            const patientInputs = document.getElementById('patientInputs');
            const patientContainer = document.createElement('div');
            patientContainer.className = 'patient-container';
            
            const inputWrapper = document.createElement('div');
            inputWrapper.style.display = 'flex';
            inputWrapper.style.alignItems = 'center';
            inputWrapper.style.gap = '10px';
            
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.className = 'patient-name';
            newInput.placeholder = 'Enter patient name';
            
            const staffCountSelect = document.createElement('select');
            staffCountSelect.className = 'staff-count';
            
            const option1 = document.createElement('option');
            option1.value = 1;
            option1.textContent = '1:1';
            const option2 = document.createElement('option');
            option2.value = 2;
            option2.textContent = '2:1';
            const option3 = document.createElement('option');
            option3.value = 3;
            option3.textContent = '3:1';
            
            staffCountSelect.appendChild(option1);
            staffCountSelect.appendChild(option2);
            staffCountSelect.appendChild(option3);
            
            inputWrapper.appendChild(newInput);
            inputWrapper.appendChild(staffCountSelect);
            patientContainer.appendChild(inputWrapper);
            patientInputs.appendChild(patientContainer);
        }

        function generateSchedule() {
            const patientInputs = document.querySelectorAll('.patient-container');
            const staffInputs = document.querySelectorAll('.staff-container');
            const securityStaffInputs = document.querySelectorAll('.security-container');

            const staff = [];
            const excludedHours = {};
            const patients = [];

            // Process security staff
            securityStaffInputs.forEach(container => {
                const staffName = container.querySelector('.security-name').value.trim();

                if (staffName) {
                    staff.push(staffName);
                    // Instead of using a Set, add to the global array
                    if (!securityStaff.includes(staffName)) {
                        securityStaff.push(staffName);
                    }
                }
            });

            // Process other staff
            staffInputs.forEach(container => {
                const staffName = container.querySelector('.staff-name').value.trim();

                if (staffName) {
                    staff.push(staffName);
                    excludedHours[staffName] = 0; // No additional excluded hours for non-security staff
                }
            });

            // Process patients
            patientInputs.forEach(container => {
                const patientName = container.querySelector('.patient-name').value.trim();
                const staffCount = parseInt(container.querySelector('.staff-count').value);

                if (patientName) {
                    patients.push({ name: patientName, staffCount });
                }
            });

            // Validate inputs
            if (staff.length === 0) {
                alert("Please enter at least one staff name");
                return;
            }

            if (patients.length === 0) {
                alert("Please enter at least one patient name");
                return;
            }

            // Initialize schedule data structure
            schedule = {}; // Reset the schedule object
            timeSlots.forEach(time => {
                schedule[time] = {
                    patientAssignments: {},
                    staffBreaks: {}
                };

                // Initialize each patient to have no staff assigned
                patients.forEach(patient => {
                    schedule[time].patientAssignments[patient.name] = [];
                });

                // Initialize each staff to not be on break
                staff.forEach(s => {
                    schedule[time].staffBreaks[s] = "";
                });
            });

            // Initialize staffStats for all staff members
            const staffStats = {};
            staff.forEach(s => {
                staffStats[s] = {
                    workHours: 0,
                    breakTime: 0,
                    shortBreakTime: "",
                    secondBreakTime: ""
                };
            });

            // Keep track of the last time a staff was assigned to a patient to avoid consecutive hours
            const lastAssigned = {};

            // Add work hour tracking
            const staffWorkHours = {};
            staff.forEach(s => {
                staffWorkHours[s] = 0;
            });
            
            // Add a map to track consecutive work hours
            const consecutiveWorkHours = {};
            staff.forEach(s => { consecutiveWorkHours[s] = 0; });

            // Initialize staffPatientHistory if it doesn't exist
            if (!staffPatientHistory) {
                staffPatientHistory = {};
            }

            // Initialize history for each staff member
            staff.forEach(s => {
                if (!staffPatientHistory[s]) {
                    staffPatientHistory[s] = {};
                }
                
                // Initialize counter for each patient
                patients.forEach(patient => {
                    if (!staffPatientHistory[s][patient.name]) {
                        staffPatientHistory[s][patient.name] = 0;
                    }
                });
            });

            timeSlots.forEach((time, timeIndex) => {
                // Reset consecutive hours at start of new 4-hour block
                if (timeIndex % 4 === 0) {
                    staff.forEach(s => { consecutiveWorkHours[s] = 0; });
                }
                
                // Make a copy of staff for this time slot, excluding security staff during restricted hours
                let availableStaff = [...staff].filter(s => {
                    // If this is security staff and it's a restricted hour, exclude them
                    if (securityStaff.includes(s) && isSecurityRestrictedHour(timeIndex, timeSlots.length)) {
                        return false;
                    }
                    return true;
                });
                
                // Create a priority queue of patients based on care requirements
                const sortedPatients = [...patients].sort((a, b) => b.staffCount - a.staffCount);
                
                // Process patients in order of highest care needs first
                sortedPatients.forEach(patient => {
                    const assignedStaff = [];
                    
                    // Create a priority list of staff for this patient
                    // Staff who have worked less with this patient get higher priority
                    const prioritizedStaff = [...availableStaff].sort((a, b) => {
                        // Primary sort: staff who worked less with this patient get priority
                        if (staffPatientHistory[a][patient.name] !== staffPatientHistory[b][patient.name]) {
                            return staffPatientHistory[a][patient.name] - staffPatientHistory[b][patient.name];
                        }
                        
                        // Secondary sort: avoid consecutive assignments to same patient
                        const aConsecutive = lastAssigned[a] && lastAssigned[a][patient.name] === timeIndex - 1;
                        const bConsecutive = lastAssigned[b] && lastAssigned[b][patient.name] === timeIndex - 1;
                        if (aConsecutive !== bConsecutive) return aConsecutive ? 1 : -1;
                        
                        // Tertiary sort: total work hours for this shift
                        return staffWorkHours[a] - staffWorkHours[b];
                    });
                    
                    // Assign staff to this patient
                    for (let i = 0; i < patient.staffCount && prioritizedStaff.length > 0; i++) {
                        const staffMember = prioritizedStaff.shift(); // Take the highest priority staff
                        
                        assignedStaff.push(staffMember);
                        availableStaff = availableStaff.filter(s => s !== staffMember);
                        
                        // Update work hours and consecutive work tracking
                        staffWorkHours[staffMember]++;
                        consecutiveWorkHours[staffMember]++;
                        
                        // Update last assigned time for this staff/patient
                        if (!lastAssigned[staffMember]) {
                            lastAssigned[staffMember] = {};
                        }
                        lastAssigned[staffMember][patient.name] = timeIndex;
                        
                        // Update history counter for this staff/patient pair
                        staffPatientHistory[staffMember][patient.name]++;
                    }
                    
                    schedule[time].patientAssignments[patient.name] = assignedStaff;
                });

                // After assignments, update consecutive work hours
                staff.forEach(s => {
                    let isWorking = false;
                    
                    // Check if staff is assigned to any patient this hour
                    for (const patient in schedule[time].patientAssignments) {
                        if (schedule[time].patientAssignments[patient].includes(s)) {
                            isWorking = true;
                            break;
                        }
                    }
                    
                    // Update consecutive hours
                    if (isWorking) {
                        consecutiveWorkHours[s]++;
                        
                        // Force a break if more than 3 consecutive hours
                        if (consecutiveWorkHours[s] >= 3 && timeIndex < timeSlots.length - 1) {
                            const nextHour = timeSlots[timeIndex + 1];
                            // Only if they don't already have a break planned
                            if (schedule[nextHour] && !schedule[nextHour].staffBreaks[s]) {
                                schedule[nextHour].staffBreaks[s] = "30-MIN BREAK";
                                staffStats[s].shortBreakTime = nextHour;
                                staffStats[s].breakTime += 0.5;
                                consecutiveWorkHours[s] = 0;
                            }
                        }
                    } else if (schedule[time].staffBreaks[s]) {
                        // Reset consecutive work hours after a break
                        consecutiveWorkHours[s] = 0;
                    }
                });
            });

            // Assign breaks for each staff - ensure total break time is exactly 1.5 hours per shift (30 min + 1 hour)
            staff.forEach((s, index) => {
                // For day shift: short break in first half, lunch in second half
                // For night shift: similar pattern but adjusted timing
                const shiftLength = timeSlots.length; // 12 hours
                const midPoint = Math.floor(shiftLength / 2);
                
                // Clear any previously assigned breaks for this staff
                timeSlots.forEach(time => {
                    schedule[time].staffBreaks[s] = "";
                });

                // Reset break time in stats
                staffStats[s].breakTime = 0;
                staffStats[s].shortBreakTime = "";
                staffStats[s].secondBreakTime = "";
                
                // 30-minute break - in first half of shift, staggered
                // Place it between hours 2-5 to ensure it's not too early or too late
                const shortBreakOffset = index % 3; // Stagger by staff index
                const shortBreakHour = Math.min(2 + shortBreakOffset, 5);
                const shortBreakTime = timeSlots[shortBreakHour];
                
                // Assign 30-min break
                schedule[shortBreakTime].staffBreaks[s] = "30-MIN BREAK";
                staffStats[s].shortBreakTime = shortBreakTime;
                staffStats[s].breakTime = 0.5; // Start with 0.5 hours
                
                // 1-hour lunch break - in second half of shift, staggered
                // Ensure at least 2 hours between breaks
                const lunchBreakOffset = index % 3;
                let lunchBreakHour = midPoint + lunchBreakOffset; // Place around middle + offset
                
                // Ensure lunch break is at least 2 hours after the short break
                if (lunchBreakHour - shortBreakHour < 2) {
                    lunchBreakHour = shortBreakHour + 2;
                }
                
                // Make sure lunch break isn't in the last hour
                lunchBreakHour = Math.min(lunchBreakHour, shiftLength - 2);
                
                const lunchBreakTime = timeSlots[lunchBreakHour];
                
                // Assign lunch break (ensure it's not the same as short break)
                if (lunchBreakTime !== shortBreakTime) {
                    schedule[lunchBreakTime].staffBreaks[s] = "2ND BREAK"; // Changed from "LUNCH BREAK" to "2ND BREAK"
                    staffStats[s].secondBreakTime = lunchBreakTime;
                    staffStats[s].breakTime += 1.0; // Add 1 hour for lunch
                } else {
                    // Find alternative time if they overlap (unlikely but just in case)
                    const altLunchHour = Math.min(lunchBreakHour + 1, shiftLength - 2);
                    const altLunchTime = timeSlots[altLunchHour];
                    schedule[altLunchTime].staffBreaks[s] = "2ND BREAK"; // Changed from "LUNCH BREAK" to "2ND BREAK"
                    staffStats[s].secondBreakTime = altLunchTime;
                    staffStats[s].breakTime += 1.0;
                }
            });

            // Render the schedule
            renderSchedule(schedule, staff, patients.map(p => p.name), staffStats);
            
            // Save to localStorage
            saveToLocalStorage();
        }

        function renderSchedule(schedule, staff, patients, staffStats) {
            // Generate colors for staff
            const staffColors = generateStaffColors(staff);
            
            // Reset work hours in staffStats
            staff.forEach(s => {
                staffStats[s].workHours = 0;
                staffStats[s].breakTime = 0;
            });
            
            // Make sure timeSlots is properly initialized based on current shift
            if (!timeSlots || timeSlots.length === 0) {
                timeSlots = isDayShift ? [...dayShiftSlots] : [...nightShiftSlots];
            }
            
            // Ensure schedule is properly initialized for all time slots
            timeSlots.forEach(time => {
                if (!schedule[time]) {
                    schedule[time] = {
                        patientAssignments: {},
                        staffBreaks: {}
                    };
                }
                
                // Make sure patientAssignments exists
                if (!schedule[time].patientAssignments) {
                    schedule[time].patientAssignments = {};
                }
                
                // Initialize patient assignments if missing
                patients.forEach(patient => {
                    if (!schedule[time].patientAssignments[patient]) {
                        schedule[time].patientAssignments[patient] = [];
                    }
                });
                
                // Make sure staffBreaks exists
                if (!schedule[time].staffBreaks) {
                    schedule[time].staffBreaks = {};
                }
                
                // Initialize staff breaks if missing
                staff.forEach(s => {
                    if (!schedule[time].staffBreaks[s]) {
                        schedule[time].staffBreaks[s] = "";
                    }
                });
            });
            
            // Continue with the rest of the function...
            // Calculate work hours for each staff member
            timeSlots.forEach((time, timeIndex) => {
                staff.forEach(s => {
                    // If security staff on security duty, count as working
                    if (securityStaff.includes(s) && isSecurityRestrictedHour(timeIndex, timeSlots.length)) {
                        staffStats[s].workHours += 1;
                        return; // Skip further checks for this time slot
                    }
                    
                    // Skip if on break
                    if (schedule[time] && schedule[time].staffBreaks && schedule[time].staffBreaks[s]) {
                        // Existing break handling code
                        return;
                    }
                    
                    // Check if staff is working this hour
                    let working = false;
                    for (const patient in schedule[time].patientAssignments) {
                        if (schedule[time].patientAssignments[patient].includes(s)) {
                            working = true;
                            break;
                        }
                    }
                    
                    // Update work hours if working
                    if (working) {
                        staffStats[s].workHours += 1;
                    }
                });
            });
            
            // Setup patient schedule header (time slots horizontally)
            const scheduleHeader = document.getElementById('scheduleHeader');
            let headerHTML = '<tr><th>Patient</th>';
            timeSlots.forEach(time => {
                headerHTML += `<th>${time}</th>`;
            });
            headerHTML += '</tr>';
            scheduleHeader.innerHTML = headerHTML;
            
            // Setup patient schedule body (patient rows)
            const scheduleBody = document.getElementById('scheduleBody');
            scheduleBody.innerHTML = '';
            patients.forEach(patient => {
                const row = document.createElement('tr');
                
                // Add patient name cell
                const patientCell = document.createElement('td');
                patientCell.textContent = patient;
                patientCell.className = 'row-header';
                row.appendChild(patientCell);
                
                // Add cells for each time slot
                timeSlots.forEach(time => {
                    const cell = document.createElement('td');
                    const assignedStaff = schedule[time].patientAssignments[patient];
                    
                    if (assignedStaff.length === 0) {
                        cell.textContent = "UNASSIGNED";
                        cell.style.backgroundColor = "#ffeaa7"; // Yellow for unassigned
                        cell.style.color = "#000000"; // Black text for contrast
                    } else {
                        cell.textContent = assignedStaff.join(", ");
                        
                        // Add a check to ensure assignedStaff[0] exists and is in staffColors
                        if (assignedStaff.length > 0 && staffColors[assignedStaff[0]]) {
                            const { bgColor, textColor } = staffColors[assignedStaff[0]]; // Use the first staff's color
                            cell.style.backgroundColor = bgColor;
                            cell.style.color = textColor; // Set text color for contrast
                        } else {
                            // Fallback colors if no valid staff color is found
                            cell.style.backgroundColor = "#f8f9fa"; // Light gray background
                            cell.style.color = "#000000"; // Black text for contrast
                        }
                    }
                    
                    row.appendChild(cell);
                });
                
                scheduleBody.appendChild(row);
            });
            
            // Setup staff schedule header (same as patient schedule)
            const staffHeader = document.getElementById('staffHeader');
            staffHeader.innerHTML = headerHTML;
            
            // Setup staff schedule body (staff rows)
            const staffBody = document.getElementById('staffBody');
            staffBody.innerHTML = '';
            staff.forEach(s => {
                const row = document.createElement('tr');
                
                // Add staff name cell
                const staffCell = document.createElement('td');
                staffCell.textContent = s;
                staffCell.className = 'row-header';

                // Add safety check before accessing staffColors
                if (staffColors[s]) {
                    const { bgColor, textColor } = staffColors[s];
                    staffCell.style.backgroundColor = bgColor; // Assign staff color
                    staffCell.style.color = textColor; // Ensure text is visible
                } else {
                    // Fallback colors
                    staffCell.style.backgroundColor = "#f8f9fa"; // Light gray background
                    staffCell.style.color = "#000000"; // Black text for contrast
                }
                row.appendChild(staffCell);
                
                // Add cells for each time slot
                timeSlots.forEach((time, timeIndex) => {
                    const cell = document.createElement('td');
                    const breakStatus = schedule[time].staffBreaks[s];
                    
                    // Check if security staff on security duty (first 2 or last 2 hours)
                    if (securityStaff.includes(s) && isSecurityRestrictedHour(timeIndex, timeSlots.length)) {
                        cell.textContent = "SECURITY";
                        cell.style.backgroundColor = "#ffccbc"; // Light orange for security duty
                        cell.style.color = "#000000"; // Black text for contrast
                        cell.style.fontWeight = "bold";
                    }
                    else if (breakStatus === "30-MIN BREAK") {
                        cell.textContent = "BREAK";
                        cell.className = 'staff-break';
                    } else if (breakStatus === "2ND BREAK") {
                        cell.textContent = "2ND BREAK";
                        cell.className = 'staff-lunch';
                    } else {
                        // Rest of code for normal cell rendering
                        let assigned = false;
                        for (const patient in schedule[time].patientAssignments) {
                            if (schedule[time].patientAssignments[patient].includes(s)) {
                                cell.textContent = patient;
                                
                                // Add safety check for staff colors
                                if (staffColors[s]) {
                                    cell.style.backgroundColor = staffColors[s].bgColor;
                                    cell.style.color = staffColors[s].textColor;
                                } else {
                                    cell.style.backgroundColor = "#f8f9fa"; // Fallback light gray
                                    cell.style.color = "#000000"; // Black text
                                }
                                
                                assigned = true;
                                break;
                            }
                        }
                        
                        if (!assigned) {
                            cell.textContent = "FREE";
                            cell.style.backgroundColor = "#e0f7fa"; // Light blue for free time
                            cell.style.color = "#000000"; // Explicitly set text color to black for better visibility
                        }
                    }
                    
                    row.appendChild(cell);
                });
                
                staffBody.appendChild(row);
            });
            
            // Show statistics
            renderStats(staffStats, staff, patients);
            renderBreakHoursTable(staffStats, staff);
            renderStaffRotationStats();
        }

        function renderStats(staffStats, staff, patients) {
            let statsHtml = '<h2>Health Care Worker (HCW) Work Summary</h2>';
            statsHtml += '<table>';
            statsHtml += '<tr><th>HCW</th><th>Work Hours</th><th>Break Time</th><th>30-min Break</th><th>1-hour 2nd Break</th></tr>';
            
            // Get security staff from localStorage or global variable
            let securityStaff = [];
            try {
                const savedData = JSON.parse(localStorage.getItem('patientCareData'));
                securityStaff = savedData && savedData.securityStaff ? savedData.securityStaff : [];
            } catch (e) {}
            
            staff.forEach(s => {
                const isSecurity = securityStaff.includes(s);
                const rowStyle = isSecurity ? ' style="background-color:#ffe082;font-weight:bold;"' : '';
                statsHtml += `<tr${rowStyle}>
                    <td>${s}${isSecurity ? ' <span style="color:#d84315;">(Security)</span>' : ''}</td>
                    <td>${staffStats[s].workHours} hours</td>
                    <td>${staffStats[s].breakTime} hours</td>
                    <td>${staffStats[s].shortBreakTime}</td>
                    <td>${staffStats[s].secondBreakTime}</td>
                </tr>`;
            });
            
            statsHtml += '</table>';
            
            // Add schedule coverage
            statsHtml += '<h2>Schedule Coverage</h2>';
            statsHtml += `<p>Total HCWs: ${staff.length}</p>`;
            statsHtml += `<p>Total Patients: ${patients.length}</p>`;
            
            // Calculate patient-to-HCW ratio
            const ratio = staff.length / patients.length;
            statsHtml += `<p>HCW-to-Patient Ratio: ${ratio.toFixed(2)}:1</p>`;
            
            // Calculate workload balance metrics
            const workHours = staff.map(s => staffStats[s].workHours);
            const maxHours = Math.max(...workHours);
            const minHours = Math.min(...workHours);
            const avgHours = workHours.reduce((sum, hours) => sum + hours, 0) / staff.length;
            const balanceScore = maxHours - minHours; // Lower is better
            
            statsHtml += '<h3>Work Balance Metrics</h3>';
            statsHtml += `<p>Maximum Work Hours: ${maxHours}</p>`;
            statsHtml += `<p>Minimum Work Hours: ${minHours}</p>`;
            statsHtml += `<p>Average Work Hours: ${avgHours.toFixed(1)}</p>`;
            statsHtml += `<p>Balance Score: ${balanceScore} (lower is better)</p>`;
            
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = statsHtml;
        }

        function renderBreakHoursTable(staffStats, staff) {
            const breakHoursTableBody = document.querySelector('#breakHoursTable tbody');
            breakHoursTableBody.innerHTML = '';
            
            staff.forEach(s => {
                const row = document.createElement('tr');
                
                // Staff name
                const staffCell = document.createElement('td');
                staffCell.textContent = s;
                row.appendChild(staffCell);
                
                // 30-min Break
                const shortBreakCell = document.createElement('td');
                shortBreakCell.textContent = staffStats[s].shortBreakTime || 'N/A';
                row.appendChild(shortBreakCell);
                
                // 2nd Break
                const secondBreakCell = document.createElement('td');
                secondBreakCell.textContent = staffStats[s].secondBreakTime || 'N/A';
                row.appendChild(secondBreakCell);
                
                breakHoursTableBody.appendChild(row);
            });
        }

        function renderStaffRotationStats() {
            let rotationHtml = '<h3>Staff-Patient Rotation Summary</h3>';
            rotationHtml += '<table class="rotation-table">';
            
            // Header row with patient names
            rotationHtml += '<tr><th>Staff</th>';
            patients.forEach(patient => {
                rotationHtml += `<th>${patient.name}</th>`;
            });
            rotationHtml += '</tr>';
            
            // Rows for each staff member
            staff.forEach(s => {
                rotationHtml += `<tr><td>${s}</td>`;
                
                patients.forEach(patient => {
                    const count = staffPatientHistory[s] && staffPatientHistory[s][patient.name] 
                        ? staffPatientHistory[s][patient.name] : 0;
                    
                    // Color scale: darker green means more time spent with this patient
                    const intensity = Math.min(count * 20, 255);
                    const bgColor = `rgba(76, 175, 80, ${intensity/255})`;
                    
                    rotationHtml += `<td style="background-color: ${bgColor};">${count}</td>`;
                });
                
                rotationHtml += '</tr>';
            });
            
            rotationHtml += '</table>';
            
            // Add rotation visualization to stats
            document.getElementById('rotationStats').innerHTML = rotationHtml;
        }

        function saveToLocalStorage() {
            const staffInputs = Array.from(document.querySelectorAll('.staff-name')).map(input => input.value.trim());
            const patientInputs = Array.from(document.querySelectorAll('.patient-container')).map(container => {
                return {
                    name: container.querySelector('.patient-name').value.trim(),
                    staffCount: container.querySelector('.staff-count').value
                };
            });
            
            // Fix this line to properly get security staff values
            const securityStaffValues = Array.from(document.querySelectorAll('.security-name')).map(input => input.value.trim());
            const nurseInCharge = document.getElementById('nurseInChargeInput').value.trim();
            
            const data = {
                staff: staffInputs,
                patients: patientInputs,
                securityStaff: securityStaffValues, // Use the correctly extracted values
                nurseInCharge,
                schedule,
                isDayShift,
                isDarkMode: document.body.classList.contains('dark-mode'),
                staffPatientHistory,
            };
            
            localStorage.setItem('patientCareData', JSON.stringify(data));
            console.log("Data saved to localStorage:", data);
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('patientCareData');
            if (!savedData) {
                console.warn("No data found in localStorage.");
                // Add default data
                addStaffInput();
                addPatientInput();
                return;
            }
            
            // Fix: Don't destructure isDayShift as savedShift, use a different variable name
            const parsedData = JSON.parse(savedData);
            const { staff, patients, securityStaff: savedSecurityStaff, nurseInCharge, schedule: savedSchedule, isDarkMode } = parsedData;
            
            // Now assign the saved shift value to the global variable
            isDayShift = parsedData.isDayShift;
            
            // Restore dark mode
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('toggleModeBtn').textContent = ''; // Light mode symbol
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('toggleModeBtn').textContent = ''; // Dark mode symbol
            }
            
            // Restore nurse in charge
            if (nurseInCharge) {
                document.getElementById('nurseInChargeInput').value = nurseInCharge;
            }
            
            // Restore shift
            isDayShift = parsedData.isDayShift;
            timeSlots = isDayShift ? [...dayShiftSlots] : [...nightShiftSlots];
            document.getElementById('siteTitle').textContent = isDayShift ? "Day Shift Allocation" : "Night Shift Allocation";
            document.getElementById('toggleShiftBtn').textContent = isDayShift ? "Switch to Night Shift" : "Switch to Day Shift";
            
            // Restore staff
            const staffInputs = document.getElementById('staffInputs');
            staffInputs.innerHTML = '';
            staff.forEach(name => {
                const staffContainer = document.createElement('div');
                staffContainer.className = 'staff-container';
                
                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.value = name;
                newInput.className = 'staff-name';
                
                staffContainer.appendChild(newInput);
                staffInputs.appendChild(staffContainer);
            });
            
            // Restore patients
            const patientInputs = document.getElementById('patientInputs');
            patientInputs.innerHTML = '';
            patients.forEach(({ name, staffCount }) => {
                const patientContainer = document.createElement('div');
                patientContainer.className = 'patient-container';
                
                const inputWrapper = document.createElement('div');
                inputWrapper.style.display = 'flex';
                inputWrapper.style.alignItems = 'center';
                inputWrapper.style.gap = '10px';
                
                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.value = name;
                newInput.className = 'patient-name';
                
                const staffCountSelect = document.createElement('select');
                staffCountSelect.className = 'staff-count';
                
                const option1 = document.createElement('option');
                option1.value = 1;
                option1.textContent = '1:1';
                const option2 = document.createElement('option');
                option2.value = 2;
                option2.textContent = '2:1';
                const option3 = document.createElement('option');
                option3.value = 3;
                option3.textContent = '3:1';
                
                staffCountSelect.appendChild(option1);
                staffCountSelect.appendChild(option2);
                staffCountSelect.appendChild(option3);
                staffCountSelect.value = staffCount;
                
                inputWrapper.appendChild(newInput);
                inputWrapper.appendChild(staffCountSelect);
                patientContainer.appendChild(inputWrapper);
                patientInputs.appendChild(patientContainer);
            });
            
            // Restore security staff
            const securityStaffInputs = document.getElementById('securityStaffInputs');
            securityStaffInputs.innerHTML = '';

            // Reset the global array
            securityStaff = []; // Clear the existing array
            // Add loaded security staff to global variable
            savedSecurityStaff.forEach(name => {
                if (!securityStaff.includes(name)) {
                    securityStaff.push(name);
                }
            });

            securityStaff.forEach(name => {
                const securityContainer = document.createElement('div');
                securityContainer.className = 'security-container';
                
                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.value = name;
                newInput.className = 'security-name';
                
                securityContainer.appendChild(newInput);
                securityStaffInputs.appendChild(securityContainer);
            });
            
            // Restore schedule with better error handling
            try {
                schedule = savedSchedule || {}; // Ensure schedule is initialized
                
                // Validate schedule structure and recreate if needed
                const isValidSchedule = timeSlots.every(time => 
                    schedule[time] && 
                    schedule[time].patientAssignments && 
                    schedule[time].staffBreaks
                );
                
                if (!isValidSchedule) {
                    // If schedule is invalid, regenerate it from scratch
                    console.warn("Saved schedule format is invalid, regenerating...");
                    generateSchedule();
                    return;
                }
                
                // Regenerate the schedule
                if (Object.keys(schedule).length > 0) {
                    const staffStats = {};
                    staff.forEach(s => {
                        staffStats[s] = {
                            workHours: 0,
                            breakTime: 0,
                            shortBreakTime: "",
                            secondBreakTime: ""
                        };
                    });
                    
                    renderSchedule(schedule, staff, patients.map(p => p.name), staffStats);
                }
            } catch (error) {
                console.error("Error restoring schedule:", error);
                // Reset to empty schedule
                schedule = {};
                // Add default data
                addStaffInput();
                addPatientInput();
            }
            
            console.log("Data loaded from localStorage:", { staff, patients, securityStaff, schedule, isDayShift, isDarkMode });
        }

        function clearAllData() {
            // Clear all input containers
            document.getElementById('staffInputs').innerHTML = '';
            document.getElementById('patientInputs').innerHTML = '';
            document.getElementById('securityStaffInputs').innerHTML = '';
            document.getElementById('nurseInChargeInput').value = '';
            
            // Clear all display areas
            document.getElementById('scheduleHeader').innerHTML = '';
            document.getElementById('scheduleBody').innerHTML = '';
            document.getElementById('staffHeader').innerHTML = '';
            document.getElementById('staffBody').innerHTML = '';
            document.getElementById('breakHoursTable').querySelector('tbody').innerHTML = '';
            document.getElementById('stats').innerHTML = '';
            
            // Reset variables
            schedule = {};
            isDayShift = true;
            timeSlots = [...dayShiftSlots];
        }

        // Initialize on window load
        window.onload = function() {
            // Set moon emoji for dark mode button
            document.getElementById('toggleModeBtn').innerHTML = '';
            
            // Create debounced save function
            const debouncedSave = debounce(saveToLocalStorage, 300);
            
            try {
                // Add default inputs if needed
                if (document.getElementById('staffInputs').children.length === 0) {
                    addStaffInput();
                }
                if (document.getElementById('patientInputs').children.length === 0) {
                    addPatientInput();
                }
                
                // Add event listeners
                document.getElementById('addStaffBtn').addEventListener('click', addStaffInput);
                document.getElementById('removeStaffBtn').addEventListener('click', () => {
                    const staffInputs = document.getElementById('staffInputs');
                    if (staffInputs.children.length > 0) {
                        staffInputs.removeChild(staffInputs.lastChild);
                        saveToLocalStorage();
                    }
                });
                
                document.getElementById('addSecurityStaffBtn').addEventListener('click', addSecurityStaffInput);
                document.getElementById('removeSecurityStaffBtn').addEventListener('click', () => {
                    const securityStaffInputs = document.getElementById('securityStaffInputs');
                    if (securityStaffInputs.children.length > 0) {
                        securityStaffInputs.removeChild(securityStaffInputs.lastChild);
                        saveToLocalStorage();
                    }
                });
                
                document.getElementById('addPatientBtn').addEventListener('click', addPatientInput);
                document.getElementById('removePatientBtn').addEventListener('click', () => {
                    const patientInputs = document.getElementById('patientInputs');
                    if (patientInputs.children.length > 0) {
                        patientInputs.removeChild(patientInputs.lastChild);
                        saveToLocalStorage();
                    }
                });
                
                document.getElementById('generateBtn').addEventListener('click', generateSchedule);
                
                document.getElementById('resetBtn').addEventListener('click', () => {
                    // Call the improved clearAllData function
                    clearAllData();
                    
                    // Clear localStorage
                    localStorage.removeItem('patientCareData');
                    
                    // Reset UI elements
                    addStaffInput();
                    addPatientInput();
                    
                    // Reset dark mode
                    document.body.classList.remove('dark-mode');
                    document.getElementById('toggleModeBtn').textContent = '';
                    
                    // Reset shift
                    isDayShift = true;
                    timeSlots = [...dayShiftSlots];
                    document.getElementById('siteTitle').textContent = "Day Shift Allocation";
                    document.getElementById('toggleShiftBtn').textContent = "Switch to Night Shift";
                    
                    // Reset table headers
                    document.getElementById('scheduleHeader').innerHTML = '';
                    document.getElementById('staffHeader').innerHTML = '';
                    
                    console.log("Data cleared and reset complete");
                    
                    // Show confirmation to user
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    errorDiv.style.backgroundColor = '#4CAF50'; // Green for success
                    errorDiv.textContent = "Reset complete. All data has been cleared.";
                    document.body.appendChild(errorDiv);
                    setTimeout(() => errorDiv.remove(), 3000);
                });
                
                document.getElementById('toggleShiftBtn').addEventListener('click', () => {
                    isDayShift = !isDayShift;
                    timeSlots = isDayShift ? [...dayShiftSlots] : [...nightShiftSlots];
                    document.getElementById('siteTitle').textContent = isDayShift ? "Day Shift Allocation" : "Night Shift Allocation";
                    document.getElementById('toggleShiftBtn').textContent = isDayShift ? "Switch to Night Shift" : "Switch to Day Shift";
                    
                    // Regenerate schedule if exists
                    if (Object.keys(schedule).length > 0) {
                        generateSchedule();
                    }
                    
                    saveToLocalStorage();
                });
                
                document.getElementById('toggleModeBtn').addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    const isDark = document.body.classList.contains('dark-mode');
                    document.getElementById('toggleModeBtn').textContent = isDark ? '' : '';
                    saveToLocalStorage();
                });
                
                document.getElementById('debugFillBtn').addEventListener('click', () => {
                    // Show loading state
                    const debugBtn = document.getElementById('debugFillBtn');
                    const originalText = debugBtn.textContent;
                    debugBtn.textContent = "Loading...";
                    debugBtn.disabled = true;
                    
                    // Get current counts of staff and patient inputs
                    const currentStaffInputs = document.querySelectorAll('.staff-name');
                    const currentPatientInputs = document.querySelectorAll('.patient-name');
                    const currentSecurityInputs = document.querySelectorAll('.security-name');
                    
                    // Use predefined names
                    const staffNames = ['John S.', 'Mary T.', 'Robert K.', 'Lisa G.', 'Michael P.', 'Sarah R.', 'David C.', 'Emma H.', 'Thomas W.', 'Olivia J.'];
                    const patientNames = ['Patient Anderson', 'Patient Brown', 'Patient Chen', 'Patient Davis', 'Patient Evans', 'Patient Fisher', 'Patient Garcia', 'Patient Harris'];
                    const securityNames = ['Security Jones', 'Security Wilson', 'Security Taylor'];
                    
                    // Fill staff inputs with names
                    currentStaffInputs.forEach((input, index) => {
                        input.value = staffNames[index % staffNames.length];
                    });
                    
                    // Fill patient inputs with names
                    currentPatientInputs.forEach((input, index) => {
                        input.value = patientNames[index % patientNames.length];
                        
                        // Set random staff count (1:1, 2:1, or 3:1)
                        const staffCountSelect = input.closest('.patient-container').querySelector('.staff-count');
                        if (staffCountSelect) {
                            staffCountSelect.value = Math.min(index % 3 + 1, 3);
                        }
                    });
                    
                    // Fill security staff inputs with names
                    currentSecurityInputs.forEach((input, index) => {
                        input.value = securityNames[index % securityNames.length];
                    });
                    
                    // Add nurse in charge
                    document.getElementById('nurseInChargeInput').value = 'Charge Nurse Wilson';
                    
                    // Save to localStorage
                    saveToLocalStorage();
                    
                    // Reset button state
                    debugBtn.textContent = originalText;
                    debugBtn.disabled = false;
                });
                
                // Add debounced input handlers
                document.querySelectorAll('input, select').forEach(input => 
                    input.addEventListener('input', debouncedSave)
                );
                
                // Load data from localStorage
                loadFromLocalStorage();
                
            } catch (error) {
                console.error("Error:", error);
                showError("Something went wrong. Please try again.");
            }
        };

        document.getElementById('resetRotationBtn').addEventListener('click', () => {
            // Reset staffPatientHistory
            staffPatientHistory = {};
            
            // Initialize for current staff and patients
            staff.forEach(s => {
                staffPatientHistory[s] = {};
                patients.forEach(patient => {
                    staffPatientHistory[s][patient.name] = 0;
                });
            });
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Show confirmation
            const confirmationDiv = document.createElement('div');
            confirmationDiv.className = 'success-message';
            confirmationDiv.textContent = "Staff rotation history has been reset.";
            document.body.appendChild(confirmationDiv);
            setTimeout(() => confirmationDiv.remove(), 3000);
            
            // Regenerate schedule if exists
            if (Object.keys(schedule).length > 0) {
                generateSchedule();
            }
        });
    </script>
</body>
</html>