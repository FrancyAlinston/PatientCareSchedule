<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Care Schedule - With Color Excel Export</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* Light theme colors */
            --primary-bg: #ffffff;
            --secondary-bg: #f8f9fa;
            --container-bg-color: #ffffff;
            --table-bg-color: #ffffff;
            --table-header-bg: #007bff;
            --table-cell-bg: #ffffff;
            --table-cell-text-color: #333333;
            --table-cell-border: #dee2e6;
            --text-color: #333333;
            --border-color: #dee2e6;
            --button-bg-color: #007bff;
            --button-text-color: #ffffff;
            --button-hover-bg: #0056b3;
            --input-bg-color: #ffffff;
            --input-border-color: #ced4da;
            --input-focus-border: #80bdff;
            --legend-bg: rgba(255, 255, 255, 0.95);
        }

        /* Dark theme colors */
        .dark-mode {
            --primary-bg: #1a1a1a;
            --secondary-bg: #2d2d2d;
            --container-bg-color: #333333;
            --table-bg-color: #2d2d2d;
            --table-header-bg: #4a90e2;
            --table-cell-bg: #3a3a3a;
            --table-cell-text-color: #ffffff;
            --table-cell-border: #555555;
            --text-color: #ffffff;
            --border-color: #555555;
            --button-bg-color: #4a90e2;
            --button-text-color: #ffffff;
            --button-hover-bg: #357abd;
            --input-bg-color: #2d2d2d;
            --input-border-color: #555555;
            --input-focus-border: #4a90e2;
            --legend-bg: rgba(51, 51, 51, 0.95);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--primary-bg);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--container-bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        h1, h2 {
            color: var(--text-color);
            margin-bottom: 15px;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .action-button {
            background-color: var(--button-bg-color);
            color: var(--button-text-color);
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .action-button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .action-button:active {
            transform: translateY(0);
        }

        .action-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .form-section {
            background-color: var(--container-bg-color);
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
            flex-wrap: wrap;
        }

        label {
            font-weight: 500;
            margin-right: 10px;
            color: var(--text-color);
            min-width: 120px;
        }

        input, select {
            padding: 10px;
            border: 1px solid var(--input-border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--input-focus-border);
        }

        .staff-name, .patient-name, .security-name {
            min-width: 200px;
            flex: 1;
        }

        .staff-count {
            min-width: 80px;
        }

        .nurse-input {
            min-width: 250px;
        }

        .input-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .small-button {
            background-color: var(--button-bg-color);
            color: var(--button-text-color);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
        }

        .small-button:hover {
            background-color: var(--button-hover-bg);
        }

        .schedule-container {
            background-color: var(--container-bg-color);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: var(--table-bg-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid var(--table-cell-border);
            color: var(--table-cell-text-color);
            background-color: var(--table-cell-bg);
        }

        th {
            background-color: var(--table-header-bg);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .row-header {
            background-color: var(--table-header-bg);
            color: white;
            font-weight: 600;
            text-align: left !important;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        .staff-break {
            background-color: #e1bee7;
            color: #000000;
            font-weight: bold;
        }

        .staff-lunch {
            background-color: #f8bbd9;
            color: #000000;
            font-weight: bold;
        }

        .staff-unassigned {
            background-color: #ffcdd2;
            color: #000000;
            font-weight: bold;
        }

        .assignable-staff-cell {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .assignable-staff-cell:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

        .stats {
            background-color: var(--container-bg-color);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .legend {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--legend-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            z-index: 100;
            min-width: 200px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
            border: 1px solid var(--border-color);
        }

        .legend-break {
            background-color: #e1bee7;
        }

        .legend-lunch {
            background-color: #f8bbd9;
        }

        .legend-unassigned {
            background-color: #ffcdd2;
        }

        .legend-security {
            background-color: #ffccbc;
        }

        .legend-night-break {
            background-color: #673ab7;
        }

        .legend-cleaning-duty {
            background-color: #9c27b0;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
            font-weight: 500;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
            font-weight: 500;
        }

        .rotation-table {
            font-size: 12px;
        }

        .rotation-table th, .rotation-table td {
            padding: 8px;
            min-width: 50px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .legend {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
            }

            .form-row {
                flex-direction: column;
                align-items: stretch;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .action-button {
                width: 100%;
                margin-bottom: 10px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 4px;
            }
        }

        /* Cleaning duty assignable cells */
        .cleaning-duty-assignable {
            transition: background-color 0.2s ease;
            border-radius: 4px;
            padding: 4px 8px;
        }

        .cleaning-duty-assignable:hover {
            background-color: rgba(156, 39, 176, 0.1);
            font-weight: bold;
        }

        /* Break adjustment styles */
        .break-adjustment-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .break-time-select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--input-border-color);
            background-color: var(--input-bg-color);
            color: var(--text-color);
        }

        .staff-break-actions {
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        .reset-staff-btn {
            background-color: #ffc107;
            color: #212529;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .reset-staff-btn:hover {
            background-color: #e0a800;
        }

        /* Debug styles */
        #debugFillBtn {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        #debugFillBtn:hover {
            background-color: #138496;
        }

        /* Excel export button special styling */
        #exportExcelBtn {
            background: linear-gradient(135deg, #28a745, #20c997);
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        #exportExcelBtn:hover {
            background: linear-gradient(135deg, #218838, #1e7e34);
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
        }

        #exportExcelBtn:before {
            content: "🎨";
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Legend -->
        <div class="legend">
            <h3 style="margin-top: 0;">Legend</h3>
            <div class="legend-item">
                <div class="legend-color legend-break"></div>
                <div>30-min Break</div>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-lunch"></div>
                <div>1-hour 2nd Break</div>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-unassigned"></div>
                <div>Emergency Assignment</div>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-security"></div>
                <div>Security Duty</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4CAF50;"></div>
                <div>OBS</div>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <h1 id="siteTitle">Day Shift Allocation - WITH EXCEL COLORS!</h1>
            <div class="controls">
                <button id="toggleModeBtn" class="action-button" title="Toggle Dark/Light Mode">🌙</button>
                <button id="toggleShiftBtn" class="action-button">Switch to Night Shift</button>
            </div>
        </div>

        <!-- Staff Input Section -->
        <div class="form-section">
            <h2>Health Care Workers</h2>
            <div id="staffInputs"></div>
            <div class="input-controls">
                <button id="addStaffBtn" class="small-button">+ Add HCW</button>
                <button id="removeStaffBtn" class="small-button">- Remove Last</button>
                <button id="debugFillBtn" class="small-button">🔧 Fill Random Data</button>
            </div>
        </div>

        <!-- Nurse in Charge Section -->
        <div class="form-section">
            <h2>Nurses in Charge</h2>
            <div class="form-row">
                <label for="nurseInChargeInput">Primary Nurse in Charge:</label>
                <input type="text" id="nurseInChargeInput" placeholder="Enter Primary Nurse in Charge" class="nurse-input">
            </div>
            <div class="form-row">
                <label for="nurseInCharge2Input">Secondary Nurse in Charge:</label>
                <input type="text" id="nurseInCharge2Input" placeholder="Enter Secondary Nurse in Charge (optional)" class="nurse-input">
            </div>
        </div>

        <!-- Security Staff Section -->
        <div class="form-section">
            <h2>Security Staff</h2>
            <div id="securityStaffInputs">
                <div class="security-container">
                    <input type="text" placeholder="Enter Security Staff Name" class="security-name">
                </div>
            </div>
        </div>

        <!-- Patient Input Section -->
        <div class="form-section">
            <h2>Patients</h2>
            <div id="patientInputs"></div>
            <div class="input-controls">
                <button id="addPatientBtn" class="small-button">+ Add Patient</button>
                <button id="removePatientBtn" class="small-button">- Remove Last</button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="controls">
            <button id="generateBtn" class="action-button">🔄 Generate Schedule</button>
            <button id="exportExcelBtn" class="action-button">📊 Export to Excel (With Colors!)</button>
            <button id="resetBtn" class="action-button">🗑️ Reset All</button>
        </div>

        <!-- Patient Care Schedule -->
        <div class="schedule-container">
            <h2>Patient Care Schedule</h2>
            <table id="patientScheduleTable">
                <thead id="scheduleHeader"></thead>
                <tbody id="scheduleBody"></tbody>
            </table>
        </div>

        <!-- Staff Schedule -->
        <div class="schedule-container">
            <h2>Staff Schedule</h2>
            <table id="staffScheduleTable">
                <thead id="staffHeader"></thead>
                <tbody id="staffBody"></tbody>
            </table>
        </div>

        <!-- Break Hours Display -->
        <div class="schedule-container">
            <h2>Staff Break Hours</h2>
            <table id="breakHoursTable">
                <thead>
                    <tr>
                        <th>Staff</th>
                        <th>30-min Break</th>
                        <th>1-hour 2nd Break</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Manual Break Time Adjustment Section -->
        <div class="schedule-container" id="manualBreakAdjustment" style="display: none;">
            <h2>Manual Break Time Adjustment</h2>
            <p>Adjust break times for staff members. Changes will update all tables and statistics automatically.</p>
            <div class="break-adjustment-controls">
                <button id="toggleBreakAdjustment" class="action-button">Enable Break Time Editing</button>
                <button id="resetAllBreaks" class="action-button" style="display: none;">Reset All Breaks</button>
                <button id="saveBreakChanges" class="action-button" style="display: none;">Apply Changes</button>
            </div>
            <div id="breakAdjustmentTable" style="display: none;">
                <table id="editableBreakTable">
                    <thead>
                        <tr>
                            <th>Staff</th>
                            <th id="firstBreakHeader">30-min Break</th>
                            <th id="secondBreakHeader">1-hour 2nd Break</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Statistics section -->
        <div class="stats" id="stats"></div>

        <!-- Staff-Patient Rotation section -->
        <div class="stats" id="rotationStats"></div>

        <button id="resetRotationBtn" class="action-button">Reset Rotation History</button>
    </div>

    <div id="debugPanel" style="display: none; position: fixed; bottom: 0; right: 0; width: 400px; height: 300px; background-color: rgba(0,0,0,0.8); color: white; padding: 10px; overflow: auto; z-index: 1000; font-family: monospace; font-size: 12px;">
    <h3 style="margin-top: 0; border-bottom: 1px solid white;">Debug Console</h3>
    <button id="clearDebugBtn" style="position: absolute; top: 10px; right: 10px; background-color: #f44336; color: white; border: none; border-radius: 4px; padding: 5px;">Clear</button>
    <div id="debugOutput"></div>
</div>

<button id="toggleDebugBtn" style="position: fixed; bottom: 10px; right: 10px; background-color: #333; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; z-index: 999;">🐞</button>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Add this function near the top of your script section with other utility functions
        function getInitials(fullName) {
            if (!fullName) return '';

            // Split the name by spaces
            const nameParts = fullName.trim().split(' ');

            // If it's a single name, return first 2 letters
            if (nameParts.length === 1) {
                return nameParts[0].substring(0, 2).toUpperCase();
            }

            // Otherwise return first letter of first name + first letter of last name
            const firstInitial = nameParts[0][0] || '';
            const lastInitial = nameParts[nameParts.length - 1][0] || '';

            return (firstInitial + lastInitial).toUpperCase();
        }

        // Staff Color Management System - Consistent colors throughout the site
        let staffColorMap = {}; // Store staff name -> color mapping
        const staffColors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F',
            '#BB8FCE', '#85C1E9', '#82E0AA', '#F8C471', '#F1948A', '#85C1E9', '#A9DFBF', '#F9E79F',
            '#D7BDE2', '#A3E4D7', '#FAD7A0', '#FADBD8', '#D5DBDB', '#AED6F1', '#A9DFBF', '#FCF3CF',
            '#EBDEF0', '#D1F2EB', '#FDEAA7', '#FDEDEC', '#EAEDED', '#D6EAF8', '#D4EDDA', '#FFF3CD'
        ];

        function getStaffColor(staffName) {
            if (!staffName || staffName.trim() === '') return '#6c757d'; // Default gray for empty names
            
            const cleanName = staffName.trim();
            
            // If staff already has a color, return it
            if (staffColorMap[cleanName]) {
                return staffColorMap[cleanName];
            }
            
            // Assign new color based on current number of staff
            const assignedColors = Object.keys(staffColorMap).length;
            const colorIndex = assignedColors % staffColors.length;
            staffColorMap[cleanName] = staffColors[colorIndex];
            
            return staffColorMap[cleanName];
        }

        function getStaffWithColor(staffName) {
            const initials = getInitials(staffName);
            const color = getStaffColor(staffName);
            return {
                name: staffName,
                initials: initials,
                color: color
            };
        }

        function formatStaffDisplay(staffName, showFullName = false) {
            if (!staffName || staffName.trim() === '') return '';
            
            const staffData = getStaffWithColor(staffName);
            const displayText = showFullName ? `${staffData.initials} (${staffData.name})` : staffData.initials;
            
            return `<span style="color: ${staffData.color}; font-weight: bold;">${displayText}</span>`;
        }

        // Reset staff color mapping (useful when staff list changes)
        function resetStaffColors() {
            staffColorMap = {};
        }

        // NEW: ExcelJS-based Excel export with FULL COLOR SUPPORT
        function exportToExcelWithColors() {
            try {
                if (!schedule || Object.keys(schedule).length === 0) {
                    alert('No schedule data to export. Please generate a schedule first.');
                    return;
                }

                console.log('Starting Excel export with ExcelJS (FULL COLORS)...');
                
                // Create a new workbook with ExcelJS
                const workbook = new ExcelJS.Workbook();
                
                // Set workbook properties
                workbook.creator = 'Patient Care Schedule System';
                workbook.lastModifiedBy = 'User';
                workbook.created = new Date();
                workbook.modified = new Date();
                
                const timestamp = new Date().toISOString().slice(0, 16).replace(/[T:]/g, '_');
                const currentShift = document.getElementById('siteTitle').textContent;
                const shiftType = currentShift.includes('Night') ? 'Night' : 'Day';
                
                // Export sheets with full color support
                exportPatientScheduleWithColors(workbook);
                exportStaffScheduleWithColors(workbook);
                
                // Generate and download the Excel file
                const filename = `Patient_Care_Schedule_COLORED_${shiftType}_${timestamp}.xlsx`;
                workbook.xlsx.writeBuffer().then(function(buffer) {
                    const blob = new Blob([buffer], { 
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                    });
                    
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    console.log('Excel file with FULL COLORS generated successfully:', filename);
                    alert(`🎨 SUCCESS! Excel file with FULL COLORS exported!\n\n` +
                          `📂 File: ${filename}\n\n` +
                          `✨ Now includes:\n` +
                          `• Patient Care Schedule (with beautiful colors!)\n` +
                          `• Staff Schedule (with color coding!)\n` +
                          `• All assignments properly colored\n` +
                          `• OBS assignments highlighted\n` +
                          `• Break times color-coded\n\n` +
                          `🚀 Powered by ExcelJS - Professional Excel library!`);
                }).catch(error => {
                    console.error('Error generating Excel file:', error);
                    alert('Error generating Excel file: ' + error.message);
                });
                
            } catch (error) {
                console.error('Excel export failed:', error);
                alert('Excel export failed: ' + error.message);
            }
        }
        
        function exportPatientScheduleWithColors(workbook) {
            const worksheet = workbook.addWorksheet('Patient Care Schedule');
            
            // Check if schedule exists
            if (!schedule || Object.keys(schedule).length === 0) {
                console.warn('No schedule data available for export');
                return;
            }
            
            // Get schedule data
            const allPatients = getAllPatients();
            const timeSlots = Object.keys(schedule).sort();
            const currentShift = document.getElementById('siteTitle').textContent;
            const currentDate = new Date().toLocaleDateString();
            
            // Define beautiful color scheme (using white/transparent backgrounds with colored text)
            const colors = {
                header: 'FF4A90E2',      // Professional blue
                headerText: 'FFFFFFFF',  // White text for headers
                normalText: 'FF000000',  // Black text for normal content
                obsText: 'FFFF6B35',     // Orange text for OBS (high priority)
                breakText: 'FFFF69B4',   // Hot pink text for breaks
                emptyText: 'FF808080'    // Gray text for empty cells
            };
            
            // Helper function to convert hex color to ARGB
            function hexToArgb(hexColor) {
                // Remove # if present and ensure it's a valid hex color
                const cleanHex = hexColor.replace('#', '');
                return 'FF' + cleanHex; // Add full opacity prefix
            }
            
            // Title rows with styling
            let currentRow = 1;
            const titleCell = worksheet.getCell(currentRow, 1);
            titleCell.value = currentShift;
            titleCell.font = { bold: true, size: 18, color: { argb: 'FF1F4E79' } };
            titleCell.alignment = { horizontal: 'center' };
            worksheet.mergeCells(currentRow, 1, currentRow, timeSlots.length + 1);
            currentRow++;
            
            const dateCell = worksheet.getCell(currentRow, 1);
            dateCell.value = `Generated on: ${currentDate}`;
            dateCell.font = { italic: true, size: 12 };
            dateCell.alignment = { horizontal: 'center' };
            worksheet.mergeCells(currentRow, 1, currentRow, timeSlots.length + 1);
            currentRow += 2;
            
            // Headers with beautiful styling
            const headerCell = worksheet.getCell(currentRow, 1);
            headerCell.value = 'Patient / Time';
            headerCell.font = { bold: true, color: { argb: colors.headerText }, size: 12 };
            headerCell.fill = { 
                type: 'pattern', 
                pattern: 'solid', 
                fgColor: { argb: colors.header } 
            };
            headerCell.border = {
                top: { style: 'thick' },
                left: { style: 'thick' },
                bottom: { style: 'thick' },
                right: { style: 'thick' }
            };
            headerCell.alignment = { horizontal: 'center', vertical: 'middle' };
            
            // Time slot headers
            timeSlots.forEach((time, index) => {
                const cell = worksheet.getCell(currentRow, index + 2);
                cell.value = time;
                cell.font = { bold: true, color: { argb: colors.headerText }, size: 11 };
                cell.fill = { 
                    type: 'pattern', 
                    pattern: 'solid', 
                    fgColor: { argb: colors.header } 
                };
                cell.border = {
                    top: { style: 'thick' },
                    left: { style: 'medium' },
                    bottom: { style: 'thick' },
                    right: { style: 'medium' }
                };
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
            });
            currentRow++;
            
            // Patient rows with color coding
            allPatients.forEach(patient => {
                // Patient name with styling
                const nameCell = worksheet.getCell(currentRow, 1);
                nameCell.value = patient.name;
                nameCell.font = { bold: true, size: 11, color: { argb: colors.normalText } };
                nameCell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thick' },
                    bottom: { style: 'thin' },
                    right: { style: 'medium' }
                };
                nameCell.alignment = { horizontal: 'left', vertical: 'middle' };
                
                // Time slots for this patient with smart color coding
                timeSlots.forEach((time, timeIndex) => {
                    const cell = worksheet.getCell(currentRow, timeIndex + 2);
                    const assignments = schedule[time].patientAssignments[patient.name] || [];
                    
                    if (assignments.length > 0) {
                        // Check if this is an OBS assignment
                        const obsAssignment = schedule[time].obsAssignments && 
                                            schedule[time].obsAssignments[patient.name] && 
                                            schedule[time].obsAssignments[patient.name].length > 0;
                        
                        // Check if this involves staff on break
                        const hasBreakStaff = assignments.some(staff => 
                            schedule[time].staffBreaks && schedule[time].staffBreaks[staff]
                        );
                        
                        // Create colored staff initials based on their assigned colors
                        const coloredStaffList = assignments.map(staff => {
                            const initials = getInitials(staff);
                            const staffColor = getStaffColor(staff);
                            return { initials, color: hexToArgb(staffColor) };
                        });
                        
                        if (obsAssignment) {
                            cell.value = coloredStaffList.map(s => s.initials).join(', ') + ' (OBS)';
                            cell.font = { 
                                bold: true, 
                                color: { argb: colors.obsText },
                                size: 10 
                            };
                        } else if (hasBreakStaff) {
                            cell.value = coloredStaffList.map(s => s.initials).join(', ') + ' (Break)';
                            cell.font = { 
                                italic: true, 
                                color: { argb: colors.breakText },
                                size: 10 
                            };
                        } else {
                            // For regular assignments, use the first staff member's color or mixed indicator
                            if (coloredStaffList.length === 1) {
                                cell.value = coloredStaffList[0].initials;
                                cell.font = { 
                                    color: { argb: coloredStaffList[0].color },
                                    bold: true,
                                    size: 10 
                                };
                            } else {
                                // Multiple staff - use normal text but indicate it's multiple
                                cell.value = coloredStaffList.map(s => s.initials).join(', ');
                                cell.font = { 
                                    color: { argb: colors.normalText },
                                    bold: true,
                                    size: 10 
                                };
                            }
                        }
                    } else {
                        cell.value = '-';
                        cell.font = { 
                            color: { argb: colors.emptyText },
                            size: 10 
                        };
                    }
                    
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                });
                
                currentRow++;
            });
            
            // Auto-fit columns for perfect display
            worksheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell((cell) => {
                    const columnLength = cell.value ? cell.value.toString().length : 10;
                    if (columnLength > maxLength) {
                        maxLength = columnLength;
                    }
                });
                column.width = Math.min(Math.max(maxLength + 3, 12), 35);
            });
        }
        
        function exportStaffScheduleWithColors(workbook) {
            const worksheet = workbook.addWorksheet('Staff Schedule');
            
            // Check if schedule exists
            if (!schedule || Object.keys(schedule).length === 0) {
                console.warn('No schedule data available for staff export');
                return;
            }
            
            const allStaffNames = getAllStaffNames();
            const timeSlots = Object.keys(schedule).sort();
            const currentShift = document.getElementById('siteTitle').textContent;
            const currentDate = new Date().toLocaleDateString();
            
            const colors = {
                header: 'FF1F4E79',        // Dark blue for header background
                headerText: 'FFFFFFFF',    // White text for headers
                normalText: 'FF000000',    // Black text for normal content
                obsText: 'FFFF8A50',       // Bright orange text for OBS
                shortBreakText: 'FFBA68C8', // Purple text for short breaks
                longBreakText: 'FFCE93D8',  // Light purple text for long breaks
                securityText: 'FFFF6B35',   // Orange text for security duty
                freeText: 'FF808080',       // Gray text for free time
                emptyText: 'FFCCCCCC'       // Light gray for empty
            };
            
            // Helper function to convert hex color to ARGB (same as patient function)
            function hexToArgb(hexColor) {
                const cleanHex = hexColor.replace('#', '');
                return 'FF' + cleanHex;
            }
            
            // Title rows
            let currentRow = 1;
            const titleCell = worksheet.getCell(currentRow, 1);
            titleCell.value = currentShift + ' - Staff Schedule';
            titleCell.font = { bold: true, size: 18, color: { argb: 'FF1F4E79' } };
            titleCell.alignment = { horizontal: 'center' };
            worksheet.mergeCells(currentRow, 1, currentRow, timeSlots.length + 1);
            currentRow++;
            
            const dateCell = worksheet.getCell(currentRow, 1);
            dateCell.value = `Generated on: ${currentDate}`;
            dateCell.font = { italic: true, size: 12 };
            dateCell.alignment = { horizontal: 'center' };
            worksheet.mergeCells(currentRow, 1, currentRow, timeSlots.length + 1);
            currentRow += 2;
            
            // Headers
            const headerCell = worksheet.getCell(currentRow, 1);
            headerCell.value = 'Staff / Time';
            headerCell.font = { bold: true, color: { argb: colors.headerText }, size: 12 };
            headerCell.fill = { 
                type: 'pattern', 
                pattern: 'solid', 
                fgColor: { argb: colors.header } 
            };
            headerCell.border = {
                top: { style: 'thick' },
                left: { style: 'thick' },
                bottom: { style: 'thick' },
                right: { style: 'thick' }
            };
            headerCell.alignment = { horizontal: 'center', vertical: 'middle' };
            
            timeSlots.forEach((time, index) => {
                const cell = worksheet.getCell(currentRow, index + 2);
                cell.value = time;
                cell.font = { bold: true, color: { argb: colors.headerText }, size: 11 };
                cell.fill = { 
                    type: 'pattern', 
                    pattern: 'solid', 
                    fgColor: { argb: colors.header } 
                };
                cell.border = {
                    top: { style: 'thick' },
                    left: { style: 'medium' },
                    bottom: { style: 'thick' },
                    right: { style: 'medium' }
                };
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
            });
            currentRow++;
            
            // Staff rows with dynamic text color coding
            allStaffNames.forEach(staff => {
                const nameCell = worksheet.getCell(currentRow, 1);
                nameCell.value = staff;
                const staffColor = getStaffColor(staff);
                nameCell.font = { 
                    bold: true, 
                    size: 11, 
                    color: { argb: hexToArgb(staffColor) } 
                };
                nameCell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thick' },
                    bottom: { style: 'thin' },
                    right: { style: 'medium' }
                };
                nameCell.alignment = { horizontal: 'left', vertical: 'middle' };
                
                timeSlots.forEach((time, timeIndex) => {
                    const cell = worksheet.getCell(currentRow, timeIndex + 2);
                    let assigned = false;
                    
                    // Check for OBS assignments (highest priority coloring)
                    Object.keys(schedule[time].obsAssignments || {}).forEach(patient => {
                        if (schedule[time].obsAssignments[patient].includes(staff)) {
                            cell.value = getInitials(patient) + ' (OBS)';
                            cell.font = { 
                                bold: true, 
                                color: { argb: colors.obsText },
                                size: 10 
                            };
                            assigned = true;
                        }
                    });
                    
                    // Check for break assignments
                    if (!assigned) {
                        if (schedule[time].staffBreaks && schedule[time].staffBreaks[staff]) {
                            const breakType = schedule[time].staffBreaks[staff];
                            if (breakType === "30-MIN BREAK") {
                                cell.value = 'Short Break';
                                cell.font = { 
                                    italic: true, 
                                    color: { argb: colors.shortBreakText },
                                    size: 10 
                                };
                                assigned = true;
                            } else if (breakType === "2ND BREAK" || breakType === "NIGHT BREAK") {
                                cell.value = 'Long Break';
                                cell.font = { 
                                    italic: true, 
                                    color: { argb: colors.longBreakText },
                                    size: 10 
                                };
                                assigned = true;
                            } else if (breakType === "SECURITY DUTY") {
                                cell.value = 'Security Duty';
                                cell.font = { 
                                    bold: true, 
                                    color: { argb: colors.securityText },
                                    size: 10 
                                };
                                assigned = true;
                            }
                        }
                    }
                    
                    // Check for regular patient assignments
                    if (!assigned) {
                        const allPatients = getAllPatients();
                        for (const patient of allPatients) {
                            if (schedule[time].patientAssignments[patient.name] &&
                                schedule[time].patientAssignments[patient.name].includes(staff)) {
                                cell.value = getInitials(patient.name);
                                // Use the staff's own color for patient assignments
                                const staffColor = getStaffColor(staff);
                                cell.font = { 
                                    color: { argb: hexToArgb(staffColor) },
                                    bold: true,
                                    size: 10 
                                };
                                assigned = true;
                                break;
                            }
                        }
                    }
                    
                    if (!assigned) {
                        cell.value = 'FREE';
                        cell.font = { 
                            color: { argb: colors.freeText },
                            size: 10 
                        };
                    }
                    
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                });
                
                currentRow++;
            });
            
            // Auto-fit columns
            worksheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell((cell) => {
                    const columnLength = cell.value ? cell.value.toString().length : 10;
                    if (columnLength > maxLength) {
                        maxLength = columnLength;
                    }
                });
                column.width = Math.min(Math.max(maxLength + 3, 12), 35);
            });
        }

        // Global variables
        let schedule = {};
        let isDayShift = true;
        let timeSlots = [];
        let securityStaff = [];
        let nurseInCharge1 = '';
        let nurseInCharge2 = '';
        let staffPatientHistory = {};

        // Cleaning duties for night shift (global scope)
        let cleaningDuties = [
            "DINING ROOM", "OFFICE ROOM", "TAKE OUT BINS", "LAUNDRY ROOM", "PHONE ROOM",
            "LOUNGE", "KITCHEN", "QUIET ROOM", "CORRIDOR", "TOILETS"
        ];

        // Security-only cleaning duties (new rule: only security staff can do these)
        let securityOnlyDuties = ["KITCHEN", "TAKE OUT BINS"];

        // Time slot definitions
        const dayShiftSlots = ["08:00-09:00", "09:00-10:00", "10:00-11:00", "11:00-12:00", "12:00-13:00", "13:00-14:00", "14:00-15:00", "15:00-16:00", "16:00-17:00", "17:00-18:00", "18:00-19:00", "19:00-20:00"];
        const nightShiftSlots = ["20:00-21:00", "21:00-22:00", "22:00-23:00", "23:00-00:00", "00:00-01:00", "01:00-02:00", "02:00-03:00", "03:00-04:00", "04:00-05:00", "05:00-06:00", "06:00-07:00", "07:00-08:00"];

        // Initialize time slots
        timeSlots = [...dayShiftSlots];

        // Helper functions
        function getInputValues(selector) {
            return Array.from(document.querySelectorAll(selector)).map(input => input.value.trim());
        }

        function getElement(id) {
            return document.getElementById(id);
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            }
        }

        // Helper functions for getting staff and patient names
        function getAllStaffNames() {
            const staff = Array.from(document.querySelectorAll('.staff-name'))
                .map(input => input.value.trim())
                .filter(name => name);

            const securityStaffValues = Array.from(document.querySelectorAll('.security-name'))
                .map(input => input.value.trim())
                .filter(name => name);

            const nurseInCharge1 = document.getElementById('nurseInChargeInput').value.trim();
            const nurseInCharge2 = document.getElementById('nurseInCharge2Input').value.trim();

            const allStaff = [...staff, ...securityStaffValues];
            if (nurseInCharge1) allStaff.push(nurseInCharge1);
            if (nurseInCharge2) allStaff.push(nurseInCharge2);

            return allStaff;
        }

        function getAllPatientNames() {
            return Array.from(document.querySelectorAll('.patient-name'))
                .map(input => input.value.trim())
                .filter(name => name);
        }

        function getAllPatients() {
            return Array.from(document.querySelectorAll('.patient-container'))
                .map(container => {
                    const name = container.querySelector('.patient-name').value.trim();
                    if (!name) return null;

                    return {
                        name,
                        staffCount: parseInt(container.querySelector('.staff-count').value)
                    };
                })
                .filter(patient => patient !== null); // Filter out empty patients
        }

        // Simple demo function to create sample schedule
        function generateSchedule() {
            alert('🎯 This is the EXCEL ENHANCED version!\n\n' +
                  '✨ Features:\n' +
                  '• Beautiful color-coded Excel exports\n' +
                  '• Professional formatting\n' +
                  '• Dynamic staff color assignments\n\n' +
                  '📝 To see full functionality, please add:\n' +
                  '• Health Care Workers\n' +
                  '• Patients\n' +
                  '• Security Staff\n\n' +
                  '🚀 Then use the Excel export button!');
            
            // Create simple demo schedule for export testing
            schedule = {
                "08:00-09:00": {
                    patientAssignments: {
                        "Patient A": ["John Doe"],
                        "Patient B": ["Jane Smith"],
                        "OBS": ["Security Guard"]
                    },
                    staffBreaks: {}
                },
                "09:00-10:00": {
                    patientAssignments: {
                        "Patient A": ["John Doe"],
                        "Patient B": ["Jane Smith"],
                        "OBS": ["Security Guard"]
                    },
                    staffBreaks: {}
                }
            };
        }

        // Function to add staff input
        function addStaffInput() {
            const staffInputs = document.getElementById('staffInputs');

            const staffContainer = document.createElement('div');
            staffContainer.className = 'staff-container';

            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.placeholder = 'Enter HCW Name';
            newInput.className = 'staff-name';

            staffContainer.appendChild(newInput);
            staffInputs.appendChild(staffContainer);
        }

        // Function to add patient input
        function addPatientInput() {
            const patientInputs = document.getElementById('patientInputs');

            const patientContainer = document.createElement('div');
            patientContainer.className = 'patient-container';

            const inputWrapper = document.createElement('div');
            inputWrapper.style.display = 'flex';
            inputWrapper.style.alignItems = 'center';
            inputWrapper.style.gap = '10px';

            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.placeholder = 'Enter Patient Name';
            newInput.className = 'patient-name';

            const staffCountSelect = document.createElement('select');
            staffCountSelect.className = 'staff-count';

            const option1 = document.createElement('option');
            option1.value = 1;
            option1.textContent = '1:1';
            const option2 = document.createElement('option');
            option2.value = 2;
            option2.textContent = '2:1';
            const option3 = document.createElement('option');
            option3.value = 3;
            option3.textContent = '3:1';

            staffCountSelect.appendChild(option1);
            staffCountSelect.appendChild(option2);
            staffCountSelect.appendChild(option3);
            staffCountSelect.value = 1; // Default to 1:1

            inputWrapper.appendChild(newInput);
            inputWrapper.appendChild(staffCountSelect);
            patientContainer.appendChild(inputWrapper);
            patientInputs.appendChild(patientContainer);
        }

        // Initialize the application when page loads
        window.onload = function() {
            // Set moon emoji for dark mode button
            document.getElementById('toggleModeBtn').innerHTML = '🌙';

            // Add event listeners for all buttons
            document.getElementById('toggleModeBtn').addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                this.textContent = document.body.classList.contains('dark-mode') ? '☀️' : '🌙';
            });

            document.getElementById('toggleShiftBtn').addEventListener('click', function() {
                isDayShift = !isDayShift;
                timeSlots = isDayShift ? [...dayShiftSlots] : [...nightShiftSlots];
                document.getElementById('siteTitle').textContent = isDayShift ? "Day Shift Allocation - WITH EXCEL COLORS!" : "Night Shift Allocation - WITH EXCEL COLORS!";
                this.textContent = isDayShift ? "Switch to Night Shift" : "Switch to Day Shift";
            });

            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcelWithColors);

            document.getElementById('generateBtn').addEventListener('click', generateSchedule);

            document.getElementById('resetBtn').addEventListener('click', function() {
                document.getElementById('staffInputs').innerHTML = '';
                document.getElementById('patientInputs').innerHTML = '';
                document.getElementById('scheduleHeader').innerHTML = '';
                document.getElementById('scheduleBody').innerHTML = '';
                document.getElementById('staffHeader').innerHTML = '';
                document.getElementById('staffBody').innerHTML = '';
                schedule = {};
                addStaffInput();
                addPatientInput();
            });

            document.getElementById('addStaffBtn').addEventListener('click', addStaffInput);
            document.getElementById('removeStaffBtn').addEventListener('click', function() {
                const staffInputs = document.getElementById('staffInputs');
                if (staffInputs.children.length > 1) {
                    staffInputs.removeChild(staffInputs.lastChild);
                }
            });

            document.getElementById('addPatientBtn').addEventListener('click', addPatientInput);
            document.getElementById('removePatientBtn').addEventListener('click', function() {
                const patientInputs = document.getElementById('patientInputs');
                if (patientInputs.children.length > 1) {
                    patientInputs.removeChild(patientInputs.lastChild);
                }
            });

            // Initialize with one staff and patient input
            addStaffInput();
            addPatientInput();
        };
    </script>

<!-- Staff selection popup with overlay -->
<div id="popupOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
     background-color: rgba(0,0,0,0.5); z-index:1500;"></div>

<div id="staffPopup" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%,-30%);
     background-color: var(--container-bg-color); color: var(--text-color); border:2px solid var(--button-bg-color);
     border-radius:8px; z-index:2000; padding:20px; min-width:300px; box-shadow: 0 4px 20px rgba(0,0,0,0.25);">
    <h3>Select Staff for Assignment</h3>
    <div id="staffList" style="max-height: 300px; overflow-y: auto; margin: 15px 0;"></div>
    <div style="display: flex; justify-content: space-between; margin-top: 15px;">
        <button id="removeAllStaffBtn" style="background-color: #f44336; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">Remove All Staff</button>
        <button id="closePopupBtn" style="background-color: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
    </div>
</div>

<!-- Cleaning Duty Assignment Popup -->
<div id="cleaningDutyPopup" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%,-30%);
     background-color: var(--container-bg-color); color: var(--text-color); border:2px solid #9c27b0;
     border-radius:8px; z-index:2000; padding:20px; min-width:350px; box-shadow: 0 4px 20px rgba(0,0,0,0.25);">
    <h3>Assign Staff to Cleaning Duty</h3>
    <div id="cleaningDutyTitle" style="background-color: #9c27b0; color: white; padding: 10px; margin: -20px -20px 15px -20px; border-radius: 6px 6px 0 0; font-weight: bold; text-align: center;"></div>
    <div id="cleaningStaffList" style="max-height: 300px; overflow-y: auto; margin: 15px 0;"></div>
    <div style="display: flex; justify-content: space-between; margin-top: 15px;">
        <button id="removeCleaningStaffBtn" style="background-color: #f44336; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">Remove Assignment</button>
        <button id="closeCleaningPopupBtn" style="background-color: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
    </div>
</div>
</body>
</html>
